var chrome=function(){"use strict";var e=squared.base.Resource,t=squared.lib.base.Pattern;const{createElement:s}=squared.lib.dom,{convertWord:n,endsWith:o,fromLastIndexOf:r,isPlainObject:i,resolvePath:a,splitPair:c,splitPairEnd:l,splitPairStart:u,startsWith:m,trimEnd:p}=squared.lib.util,{appendSeparator:d,fromMimeType:f,parseMimeType:h,parseTask:g,parseWatchInterval:v,randomUUID:b}=squared.base.lib.util,A=new t(/\s*(.+?\.[^\s,]+)(\s+[\d.]+[wx])?\s*,?/g),y=new WeakMap;let w=0;function S(e,t){if(t){const s=new RegExp(`^\\s*${e}\\s*:(.+)$`).exec(t);if(s){const e=s[1].split("::").map((e=>e.trim()));return{file:z(e[0]),format:e[1]}}}}function x(e){if(e){const t=/\bcompress\[\s*([a-z\d]+)\s*\]/g;let s,n;for(;n=t.exec(e);)(s||(s=[])).push({format:n[1]});return{inline:e.includes("inline"),compress:s,download:!e.includes("crossorigin")&&void 0,preserve:e.includes("preserve"),blob:e.includes("blob")}}return{}}function T(e,t,s){if(m(e,"./")&&(e=e.substring(2)),!e.includes("/"))return["","",e];let n;if("/"===e[0])n="__serverroot__",e=e.substring(1);else if(m(e,"../")){n="__serverroot__";let t=location.pathname.split("/");if(--t.length)for(let s=0,n=e.length;s<n&&("../"===e.substring(s,s+3)&&0!=--t.length);s+=3);t.shift(),t=t.join("/"),e=(t?t+"/":"")+e.split("../").pop()}const o=c(e,"/",!1,!0);return t&&(o[1]=U(o[1],s)),[n,o[0],o[1]]}function k(e,t){const s=a(e instanceof HTMLObjectElement?e.data:e.src);s&&t.set(e,s)}function E(e){for(const t in e){const s=e[t],n=s.length;if(n>1){const e=[],t=++w;for(let o=0;o<n;++o){const n=s[o];n.bundleId=t,n.bundleIndex=o,o>0&&delete n.cloudStorage,e&&n.uri&&e.push(new URL(n.uri))}e:if(e.length===n){const t=e[0].origin,o=e[0].pathname.split("/");for(let s=1;s<n;++s){const n=e[s];if(n.origin!==t)break e;if(o.length){const e=n.pathname.split("/");for(let t=0;t<e.length;++t)if(o[t]!==e[t]){o.splice(t,1/0);break}}}s[0].bundleRoot=t+o.join("/")+"/"}}}}function O(e,t,s,n,o,r,i,a){const c=t.innerHTML;if(c.trim()){const[l,u,m]=T(s),p={uri:location.href,pathname:u,filename:m,moveTo:l,content:c,mimeType:n,format:o,preserve:r,document:a};i&&(p.inlineContent=q(t));const d=e[e.length-1];if(!d||!D(d,p,!0))return M(e,p),p;(d.trailingContent||(d.trailingContent=[])).push(c),j(e,{exclude:!0},t,a)}return null}function C(e,t){const s=(t.moveTo||"")+t.pathname+t.filename;s&&(e[s]||(e[s]=[])).push(t)}function I(e,t){for(let s=0,n=e.length;s<n;++s)if(D(e[s],t)){for(let o=s+1;o<n;++o)if(!D(e[o],t))return M(e,t),!0;return!1}return M(e,t),!0}function M(e,t){const s=t.filename;let n=0;for(;e.find((e=>D(e,t)));){const[e,s]=c(t.filename,".");t.filename=e+"_"+ ++n+(s?"."+s:"")}n>0&&y.set(t,s)}function j(e,t,s,n){return t.exclude?(e.push({pathname:"",filename:"",exclude:!0,element:s,document:n}),!0):!!t.ignore}function _(e,t,s){const n=F(e,t,s||e&&U(e));return n?[n,!1]:t&&"~"!==t?[t,!0]:["",!1]}function F(e,t,s){if("~"===t&&(t=""),e&&!t){const s=new URL(e);if(location.origin===s.origin){const s=location.origin.length,n=e.substring(s+1).split("/");for(const e of location.href.substring(s+1).split("/"))if(e!==n.shift())return"";t=n.join("/")}}return t&&s?d(t,s):""}function L(e,t,s){var n,o;const r=(n=t.dataset)[o=s+"Id"]||(n[o]=b());(e.id||(e.id={}))[s]=r}const U=(e,t)=>"__assign__."+(t||e&&W(e)||"unknown"),R=(e,t)=>"boolean"==typeof e?!e:!!t,q=e=>"LINK"===e.tagName?"style":e.tagName.toLowerCase(),P=(e,t,s)=>Object.assign(Object.assign({},e),{attributes:t,append:s}),N=e=>e.split("?")[0].split("/").pop(),D=(e,t,s)=>e.pathname===t.pathname&&(e.filename===t.filename||y.get(e)===t.filename||s&&m(e.filename,"__assign__"))&&(e.moveTo||"")===(t.moveTo||""),H=(e,t,s="")=>e.type.trim().toLowerCase()||t&&h(t)||s,W=e=>l(e,".",!0,!0).toLowerCase(),z=e=>e.replace(/\\+/g,"/");class File extends squared.base.File{static createTagNode(e,t,s){const n=e.tagName.toLowerCase(),o=s[n]||(s[n]=document.querySelectorAll(n)),r=o.length;let i=-1,a=-1;for(let s=0,n=t.length;s<n;++s)t[s]===e&&(i=s);for(let t=0;t<r;++t)if(o[t]===e){a=t;break}return{index:i,tagName:n,tagIndex:a,tagCount:r,ignoreCase:!0}}static setDocumentId(e,t,s){if(Array.isArray(s))for(const n of s)L(e,t,n);else s&&L(e,t,s)}static parseUri(e,t,s){let o,r,i,l,d;s&&({saveAs:o,mimeType:r,format:i,saveTo:l,fromConfig:d}=s),r||(r=h(e));let f=p(e,"/"),g;const v=m(f,location.origin);if(!v&&t)return{pathname:"",filename:"",mimeType:r,format:"crossorigin"};if(o){if(o=p(z(o),"/"),l||d)g=o;else{const e=S("saveAs",o);e?({file:g,format:i}=e):g=o}"~"===g&&(g=""),v&&g&&(f=a(g))}try{const{host:t,port:s,pathname:o}=new URL(f),[a,m]=c(o,"/",!1,!0);let p="",d="",h;if(g?[h,p,d]=T(g,l,W(e)):v||(p=n(t)+(s?"/"+s.substring(1):"")+a),e!==location.href){if(v&&!p){let e=location.pathname;e.endsWith("/")||(e=u(e,"/",!1,!0)),a.startsWith(e)?p=a.substring(e.length+1):(h="__serverroot__",p=a)}d||(d=m)}return{uri:e,moveTo:h,pathname:decodeURIComponent(p),filename:decodeURIComponent(d),mimeType:r,format:i}}catch(e){}return null}copyTo(e,t){return this.copying(e,this.processAssets(t))}appendTo(e,t){return this.archiving(e,this.processAssets(t))}saveAs(e,t){return e&&(t.filename=e),this.archiving("",this.processAssets(t))}getHtmlPage(e){var t;const s=document.documentElement;let n=s.dataset.chromeFile,o,r;if("ignore"===n)return[];e&&(o=e.assetMap,r=null===(t=e.saveAs)||void 0===t?void 0:t.html);const i=(null==o?void 0:o.get(s))||r;let a,c,l,u,m,p,d,f;if(i){if(i.ignore||i.exclude)return[];({filename:a,compress:l,process:u,tasks:m,attributes:p,cloudStorage:d,document:f}=i)}else{const{chromeOptions:e,chromeTasks:t}=s.dataset;l=x(e).compress,m=g(t)}a&&(n=""),u&&(c=u.join("+"));const h=File.parseUri(location.href,!1,{saveAs:n,format:c,mimeType:"text/html"});if(this.processExtensions(h,f,l,m,d,p,s)){if(a)h.filename=a;else if(!h.filename){const e=N(location.href);h.filename=/\.html?$/i.exec(e)?e:"index.html"}return[h]}return[]}getScriptAssets(e){var t,s;let n,o,r;e&&(({assetMap:n,preserveCrossOrigin:o}=e),r=null===(t=e.saveAs)||void 0===t?void 0:t.script);const i=[],a={};let c;if(n)for(const{selector:e,type:t,template:o}of n.values())if(o&&t&&!e)switch(t){case"html":case"js":case"css":{const{module:e,identifier:n}=o;let r=o.value;e&&n&&r&&(r=r.trim())&&r.includes("function")&&(((s=(c||(c={html:{},js:{},css:{}}))[t])[e]||(s[e]={}))[n]=r);break}}return document.querySelectorAll("script").forEach((e=>{var t;const s=e.dataset.chromeTemplate;if(s||"text/template"===e.type){const o=null==n?void 0:n.get(e);let r,a,l;if(o?(r=o.type,o.template&&({module:a,identifier:l}=o.template),j(i,o,e)):s&&([r,a,l]=s.split("::").map(((e,t)=>(0===t?e.toLowerCase():e).trim()))),r&&a&&l)switch(r){case"html":case"js":case"css":((t=(c||(c={html:{},js:{},css:{}}))[r])[a]||(t[a]={}))[l]=e.textContent.trim(),e.dataset.chromeFile="exclude"}}else{const t=e.src;this.createBundle(i,e,t,H(e,t,"text/javascript"),o,a,n,void 0,r)}})),E(a),[i,c]}getLinkAssets(e){var t;let s,n,o,i;e&&(({resourceId:s,assetMap:n,preserveCrossOrigin:o}=e),i=null===(t=e.saveAs)||void 0===t?void 0:t.link);const c=[],l={};document.querySelectorAll("link, style").forEach((e=>{let t="",s;if(e instanceof HTMLLinkElement){if(!(s=e.href))return;{const n=e.rel.trim().toLowerCase(),o=()=>{const n=r(s,"/");return!!n.includes(".")&&(t=H(e,n),!0)};switch(n){case"stylesheet":t="text/css";break;case"alternate":case"help":case"license":case"manifest":case"modulepreload":case"prefetch":case"preload":case"prerender":if(!o())return;break;default:if(!n.includes("icon")||!o())return}}}else t="text/css";this.createBundle(c,e,s,t,o,l,n,void 0,i,"text/css"===t||e instanceof HTMLStyleElement)}));const u=this.getResourceAssets(s);if(u)for(const[e,t]of u.rawData)if("text/css"===t.mimeType){let s,n,r,l,u,m,p,f,h;if(i){let t=i;i.customize&&(t=Object.assign({},t),n=i.customize.call(null,e,"text/css",t),t.pathname&&n&&(s=d(t.pathname,n))),({compress:r,download:l,preserve:u,process:m,tasks:p,cloudStorage:f,document:h}=t)}const g=File.parseUri(a(e),R(l,o),{saveAs:s,format:m?m.join("+"):""});this.processExtensions(g,h,r,p,f)&&(n&&(g.filename=n),u&&(g.preserve=!0),g.mimeType=t.mimeType,c.push(g))}return E(l),c}getImageAssets(t){var s;let n,r,i,c;t&&(({resourceId:n,assetMap:r,preserveCrossOrigin:i}=t),c=null===(s=t.saveAs)||void 0===s?void 0:s.image);const l=[];document.querySelectorAll("img, input[type=image], picture > source[src]").forEach((t=>{let s=t instanceof HTMLVideoElement?t.poster:t.src,n,o;const u=e.parseDataURI(s);if(u){if(!(o=u.base64))return;n=u.mimeType,s=a(U("",n&&f(n)))}else s=a(s);this.processImageUri(l,t,s,c,i,r,n,o)})),document.querySelectorAll("img[srcset], picture > source[srcset]").forEach((e=>{for(A.matcher(e.srcset.trim());A.find();){const t=a(A.group(1));t!==a(e.src)&&this.processImageUri(l,e,t,c,i,r,void 0,void 0,!0)}}));const u=this.getResourceAssets(n);if(u){for(const t of u.image.keys()){const s=e.parseDataURI(t);s?s.base64&&this.resource.addRawData(n,t,s):this.processImageUri(l,null,t,c,i)}for(const e of u.rawData.values()){const{base64:t,content:s,mimeType:n=h(e.filename)}=e;if(t){if(null==c?void 0:c.blob){let s=c,r,i;c.customize&&(s=Object.assign({},s),r=c.customize.call(null,"",n,s));const u=s.pathname;if(r||(r=e.filename),m(n,"image/")&&(i=s.commands))for(let e=0;e<i.length;++e){const t=/^\s*(?:(png|jpeg|webp|bmp)\s*[@%]?)(.*)$/.exec(i[e]);t?i[e]=t[1]+"@"+t[2].trim():i.splice(e--,1)}const p=this.processImageUri(l,null,a(u?d(u,r):r),s,!1,void 0,n,t);p&&(o(p.filename,".unknown")&&(p.mimeType="image/unknown"),i&&i.length?p.commands=i:delete p.commands,u||delete p.uri)}}else if(s&&n){const t={pathname:`__generated__/${n.split("/").pop()}`,filename:U(e.filename),content:s,mimeType:n};this.processExtensions(t)&&l.push(t)}}}return l}getVideoAssets(e){return this.getRawAssets("video",e)}getAudioAssets(e){return this.getRawAssets("audio",e)}getFontAssets(e){var t;let s,n,o;e&&(({resourceId:s,preserveCrossOrigin:n}=e),o=null===(t=e.saveAs)||void 0===t?void 0:t.font);const r=[],i=this.getResourceAssets(s);if(i)for(const e of i.fonts.values())for(const{srcUrl:t,srcBase64:s,mimeType:i}of e){let e,c,l,u;if(o){let s=o;o.customize&&(s=Object.assign({},s),c=o.customize.call(null,t||"",i,s)),({pathname:e,inline:l,blob:u}=s)}let m=null;t?(m=File.parseUri(t,!0!==l&&n))&&l&&(m.format="base64"):s&&u&&(c||(c=U("",f(i))),(m=File.parseUri(a(e?d(e,c):c)))&&(m.format="blob",m.base64=s)),this.processExtensions(m)&&r.push(m)}return r}finalizeRequestBody(e,t){var n;const o=t.productionRelease;let r;if(e.baseUrl=t.baseUrl,e.dataSource=t.dataSource,e.templateMap=t.templateMap,e.unusedStyles=t.unusedStyles,e.productionRelease=o,!o&&t.watch){const e={},o=new URL(this.hostname).hostname;for(const{watch:s}of t.assets)if(i(s)&&s.reload){const t=s.reload,{socketId:r,handler:i={},secure:a}=t,c=t.port||(a?this.userSettings.webSocketSecurePort:this.userSettings.webSocketPort);e[n=r+"_"+c+(a?"_0":"_1")]||(e[n]='socket=new WebSocket("'+(a?"wss":"ws")+`://${o}:${c}");`+(i.open?`socket.onopen=${i.open};`:"")+"socket.onmessage="+(i.message||`function(e){var c=JSON.parse(e.data);if(c&&c.socketId==="${r}"&&c.module==="watch"&&c.action==="modified"){if(!c.errors||!c.errors.length){if(c.hot){if(c.type==="text/css"){var a=document.querySelectorAll('link[href^="'+c.src+'"]');if(a.length){a.forEach(b=>b.href=c.src+c.hot);return;}}else if(c.type.startsWith("image/")){var a=document.querySelectorAll('img[src^="'+c.src+'"]');if(a.length){a.forEach(b=>b.src=c.src+c.hot);return;}}}window.location.reload();}else{console.log("FAIL: "+c.errors.length+" errors\\n\\n"+c.errors.join("\\n"));}}}`)+";"+(i.error?`socket.onerror=${i.error};`:"")+(i.close?`socket.onclose=${i.close};`:"")),delete t.handler}if(Object.keys(e).length){let n='document.addEventListener("DOMContentLoaded", function(){var socket;';for(const t in e)n+=e[t];if(n+="});",t.useOriginalHtmlPage){const e=t.assets.find((e=>"@text/html"===e.mimeType));e&&(e.element.textContent=`<script>${n}<\/script>`)}else r=s("script",{parent:document.body,attributes:{textContent:n}})}}if(!t.useOriginalHtmlPage){for(const e of t.assets){const t=e.element;if(t){switch(t.tagName){case"html":t.innerXml=document.documentElement.innerHTML;break;case"script":r&&++t.tagCount}if(r){const e=t.append;"script"===(null==e?void 0:e.tagName)&&++e.tagCount}}o&&e.watch&&delete e.watch}if(r&&document.body.removeChild(r),e.document)for(const t of e.document){const e=t+"Id";document.querySelectorAll(`[data-${t}-id]`).forEach((t=>delete t.dataset[e]))}t.removeInlineStyles&&document.querySelectorAll("[style]").forEach((e=>e.removeAttribute("style")))}}getCopyQueryParameters(e){return e.watch&&!e.productionRelease?"&watch=1":""}getRawAssets(e,t){var s;let n,o,r;t&&(({assetMap:n,preserveCrossOrigin:o}=t),r=null===(s=t.saveAs)||void 0===s?void 0:s.image);const i=[];return document.querySelectorAll(e).forEach((e=>{const t=new Map;let s="";switch(e.tagName){case"VIDEO":case"AUDIO":e.querySelectorAll("source, track").forEach((e=>k(e,t)));break;case"IFRAME":if(!(null==n?void 0:n.get(e))&&!m(e.dataset.chromeFile,"saveTo"))return;case"OBJECT":case"EMBED":{const t=e instanceof HTMLObjectElement?e.data:e.src;if(s=e.type||h(t),m(s,"image/"))return void this.processImageUri(i,e,t,r,o,n,s);break}}k(e,t);for(const[e,s]of t){const t=e.dataset.chromeFile;if("ignore"===t)continue;const r=null==n?void 0:n.get(e);let a,c,l,u,m,p,d,f,h,b,A;if(r){if(({filename:l,compress:u,download:m,tasks:p,watch:d,attributes:f,cloudStorage:h,document:b}=r),j(i,r,e,b))continue;[a,c]=_(s,r.saveTo||r.pathname,l||N(s)),a&&(l=""),A=!0}else{const s=S("saveAs",t);s&&(a=s.file);const{chromeOptions:n,chromeTasks:o,chromeWatch:r}=e.dataset;({compress:u,download:m}=x(n)),p=g(o),d=v(r)}const y=File.parseUri(s,R(m,o),{saveAs:a,saveTo:c,fromConfig:A});this.processExtensions(y,b,u,p,h,f,e,d)&&(l&&(y.filename=l),i.push(y))}})),i}processAssets(e){const{assetMap:t,appendMap:s,useOriginalHtmlPage:n,preserveCrossOrigin:o}=e,r=e.nodeMap||(e.nodeMap=new Map),i=document.querySelectorAll("*"),a={},c=this.getHtmlPage(e).concat(this.getLinkAssets(e));if(e.saveAsWebPage)for(const e of c)switch(e.mimeType){case"text/html":case"text/css":e.mimeType="@"+e.mimeType}const[u,m]=this.getScriptAssets(e);if(c.push(...u,...this.getImageAssets(e),...this.getVideoAssets(e),...this.getAudioAssets(e),...this.getRawAssets("object",e),...this.getRawAssets("embed",e),...this.getRawAssets("iframe",e),...this.getFontAssets(e)),s){const e={},r=(t,s,n,o)=>(t in e||(e[t]=document.querySelectorAll(t).length),{tagName:t,tagCount:e[t],textContent:n,order:s,prepend:o});for(const[e,u]of s){const s=File.createTagNode(e,i,a),m=null==t?void 0:t.get(e),p=null==m?void 0:m.document,d=()=>s.index+e.querySelectorAll("*").length+1;n||File.setDocumentId(s,e,p),s.outerXml=e.outerHTML.trim();let f=0;for(const t of u){const{type:n,attributes:i,download:a,textContent:u}=t;if(n){let m,h,g;switch(n){case"prepend/js":g=!0;case"append/js":i&&(h=i.src,i.type||(i.type="text/javascript"),m=!0);break;case"prepend/css":g=!0;case"append/css":i&&(h=i.href,i.type||(i.type="text/css"));break;default:{let e;if("replace"===n)u&&(e=P(s,i),e.textContent=u);else{const t=r(l(n,"/",!0,!0).toLowerCase(),++f,u);n.startsWith("append/")?(t.nextSibling=d(),e=P(s,i,t)):n.startsWith("prepend/")&&(t.prepend=!0,e=P(s,i,t))}e&&c.push({pathname:"",filename:"",document:p,element:e});continue}}if(h&&i){t.document||(t.document=p),delete t.download;const n=this.createBundle(c,e,h,i.type,void 0,void 0,void 0,t);if(n){R(a,o)&&delete n.uri;const e=r(m?"script":"link",++f,void 0,g);g||(e.nextSibling=d()),n.element=P(s,i,e)}}}}}}const p=this.userSettings.outputDocumentHandler;for(const e of c){const t=e.element;if(t instanceof Element){const s=File.createTagNode(t,i,a);n||File.setDocumentId(s,t,e.document),e.element=s,r.set(s,t)}e.document||(e.document=p)}for(const[e,t]of r)t!==document.documentElement&&(e.outerXml=t.outerHTML.trim());return e.assets&&c.push(...e.assets),e.assets=c,e.baseUrl=location.href,m&&(e.templateMap=m),delete e.assetMap,delete e.indexMap,delete e.nodeMap,delete e.appendMap,e}createBundle(e,t,s,n,o,r,i,c,l,u=!0){let m=c?"":t.dataset.chromeFile;if("exclude"===m||"ignore"===m)return;let p=(null==i?void 0:i.get(t))||c,d,f,h,b,A,y,w,T,k,E,M,L,U,P;if(p){if(({inline:h,compress:A,download:y,preserve:w,process:b,tasks:T,watch:k,attributes:E,cloudStorage:M,document:L}=p),j(e,p,t,L))return;m=s?p.saveAs:p.exportAs,m||!p.filename||p.pathname&&(m=_(s,p.pathname,p.filename)[0])||(d=p.filename),U=!0}else{if(u&&l){if(p=l,l.customize&&(p=Object.assign({},p),d=l.customize.call(null,s||"",n,p)),({preserve:w,inline:h,compress:A,download:y,process:b,tasks:T,watch:k,attributes:E,cloudStorage:M,document:L}=p),j(e,l,t,L))return;(d||(d=p.filename))&&(s?(m=F(s,p.pathname,d))&&(d=""):(m="./"+d,d="",P=!0))}const{chromeOptions:o,chromeTasks:r,chromeWatch:i}=t.dataset,a=x(o);null!=h||(h=a.inline),null!=w||(w=a.preserve),null!=A||(A=a.compress),null!=y||(y=a.download),T||(T=g(r)),k||(k=v(i))}b&&(f=b.join("+"));let N=null;if(s){if((N=File.parseUri(a(s),R(y,o),{saveAs:m,mimeType:n,format:f,fromConfig:U}))&&"crossorigin"!==N.format)if(c){if(h)switch(c.type){case"append/js":N.inlineContent="script";break;case"append/css":N.inlineContent="style"}}else h&&(N.inlineContent=q(t)),I(e,N)&&(N.bundleIndex=-1)}else if(m){if(!U&&!P){const e=S("exportAs",m);e&&({file:m,format:f}=e)}(N=O(e,t,m,n,f,w,h,L))&&(N.bundleIndex=-1)}return this.processExtensions(N,L,A,T,M,E,c?void 0:t,k)?(d&&(N.filename=d),w&&(N.preserve=!0),r&&C(r,N),e.push(N),N):void 0}processImageUri(e,t,s,n,o,r,i,a,c){if(s){let l,u,m,p,d,f,h,b,A,y,w,T,k,E,O,C;const I=e=>{e.customize&&(l=Object.assign({},e),d=e.customize.call(null,s,i||"",l))};if(t){const o=t.dataset.chromeFile;if("ignore"===o)return;if(l=null==r?void 0:r.get(t)){if(({pathname:p,filename:d,inline:h,compress:b,download:A,blob:y,commands:f,tasks:w,watch:T,attributes:k,cloudStorage:E,document:O}=l),j(e,l,t,O))return;[u,m]=_(s,l.saveTo||p,d||N(s)),u&&(d=""),C=!0}else{if(n){if(I(l=n),({pathname:p,inline:h,compress:b,download:A,blob:y,commands:f,tasks:w,watch:T,attributes:k,cloudStorage:E,document:O}=l),j(e,n,t,O))return;[u,m]=_(s,p,d||N(s))}if(o&&!p){let e=S("saveTo",o);e?[u,m]=_(s,e.file,d||N(s)):(e=S("saveAs",o))&&(u=e.file)}const{chromeCommands:r,chromeOptions:i,chromeTasks:a,chromeWatch:c}=t.dataset;!f&&r&&(f=r.split("::").map((e=>e.trim())));const C=x(i);null!=h||(h=C.inline),null!=b||(b=C.compress),null!=A||(A=C.download),null!=y||(y=C.blob),w||(w=g(a)),T||(T=v(c))}}else n&&(I(l=n),({pathname:p,inline:h,compress:b,download:A,blob:y,commands:f,tasks:w,cloudStorage:E}=l),[u,m]=_(s,p,d||N(s)));if(a&&!y)return;!f||0!==f.length&&"~"!==f[0]||(f=void 0);const M=File.parseUri(s,R(A,o),{saveAs:u,saveTo:m,mimeType:i,fromConfig:C});if(this.processExtensions(M,O,b,w,E,k,t,T,!!f)){if(d&&(M.filename=d),a){if(!C&&e.find((e=>e.base64===a)))return;M.format="blob",M.base64=a}else if(c)M.format="srcset";else if(h)M.format="base64";else if(!t&&e.find((e=>e.moveTo===M.moveTo&&e.pathname===M.pathname&&e.filename===M.filename&&!M.filename.includes("__assign__"))))return;return f&&(M.commands=f),e.push(M),M}}}getResourceAssets(t){if(void 0!==t&&-1!==t)return e.ASSETS[t]}processExtensions(e,t,s,n,o,r,i,a,c){if(e){s&&(e.compress=s,c=!0),n&&(e.tasks=n,c=!0),r&&(e.attributes=r,c=!0),o&&(e.cloudStorage=o,c=!0),a&&(e.watch=a,c=!0),i&&(e.element=i),t&&(e.document=t);for(const t of this.application.extensions)if(!t.processFile(e))return!1;return c||"crossorigin"!==e.format}return!1}get application(){return this.resource.application}get userSettings(){return this.resource.userSettings}}const{UNABLE_TO_FINALIZE_DOCUMENT:$,reject:B}=squared.lib.error,{escapePattern:V,isPlainObject:J}=squared.lib.util;class Application extends squared.base.Application{constructor(){super(...arguments),this.extensions=[],this.systemName="chrome"}insertNode(e,t){if("#"===t.nodeName[0]){if(this.userSettings.excludePlainText)return;this.controllerHandler.applyDefaultStyles(e,t)}return this.createNodeStatic(e,t)}saveAs(e,t){return this.processAssets("saveAs",e,t)}copyTo(e,t){return this.processAssets("copyTo",e,t)}appendTo(e,t){return this.processAssets("appendTo",e,t)}async processAssets(e,t,s){const n=await this.parseDocument();if(!n)return B($);const{resourceId:o,unusedStyles:r}=this.getProcessing(n.sessionId),i=[],a=new Map,c=new Map,l=new Map;if(s=Object.assign(Object.assign({},s),{saveAsWebPage:!0,resourceId:o,assetMap:a,nodeMap:c,appendMap:l}),r){const{removeUnusedClasses:e,removeUnusedSelectors:t,retainUsedStyles:n=[]}=s;(e||t)&&(s.unusedStyles=Array.from(r).filter((s=>(s.includes(":")?t:e)&&!n.includes(s))))}if(s.configUri){const e=await this.fileHandler.loadConfig(s.configUri,s);if(e){const t=this.userSettings.outputDocumentHandler,s=new Map,n=e=>{if(e&&"number"!=typeof e&&"boolean"!=typeof e){const t=e,n="object"==typeof e||Array.isArray(e);n&&(e=JSON.stringify(e));const o=e;for(const[t,n]of s.values())e=e.replace(t,n);if(o===e)return t;if(n)try{return JSON.parse(e)}catch(e){return t}}return e};location.href.includes("?")&&new URLSearchParams(location.search).forEach(((e,t)=>s.set(t,[new RegExp(`\\{\\{\\s*${V(t)}\\s*\\}\\}`,"g"),e])));for(const o of e)if(o.selector){const e=o.type;let r=J(o.dataSource)?o.dataSource:null,c=J(o.cloudDatabase)?o.cloudDatabase:null;if(s.size)for(const e of[r,c])if(e)for(const t in e)"value"!==t&&(e[t]=n(e[t]));r&&(r=Object.assign(Object.assign({document:o.document||t},r),{type:e})),c&&(c=Object.assign(Object.assign({document:o.document||t},r),{type:e,source:"cloud"})),document.querySelectorAll(o.selector).forEach((t=>{switch(e){case"text":case"attribute":case"display":r?i.push([t,r]):c&&i.push([t,c]);break;default:if(e&&("replace"===e||e.startsWith("append/")||e.startsWith("prepend/"))){const e=l.get(t)||[];e.push(Object.assign({},o)),l.set(t,e)}else a.set(t,Object.assign({},o))}}))}}}if(0===a.size&&delete s.assetMap,0===l.size&&delete s.appendMap,i.length){const e=s.useOriginalHtmlPage,t=document.querySelectorAll("*"),n={},o=s.dataSource||(s.dataSource=[]);for(let s=0,r=i.length;s<r;++s){const[r,a]=i[s],l=File.createTagNode(r,t,n);l.textContent=r.textContent,a.element=l,e||File.setDocumentId(l,r,a.document),c.set(l,r),o.push(a)}}return this.fileHandler[e](t,s)}get initializing(){return!1}get length(){return 1}}class Extension extends squared.base.Extension{processFile(e){return!0}}const X={builtInExtensions:[],preloadImages:!1,preloadFonts:!1,preloadCustomElements:!1,excludePlainText:!0,createElementMap:!0,createQuerySelectorMap:!0,pierceShadowRoot:!0,showErrorMessages:!1,webSocketPort:80,webSocketSecurePort:443,outputDocumentHandler:"chrome",outputEmptyCopyDirectory:!1,outputTasks:{},outputWatch:{},outputArchiveName:"chrome-data",outputArchiveFormat:"zip",outputArchiveCache:!1},{DIRECTORY_NOT_PROVIDED:K,FRAMEWORK_NOT_INSTALLED:Q,reject:Y}=squared.lib.error,{isString:Z,isPlainObject:G}=squared.lib.util;let ee=null,te=null;function se(e,t,s){return G(t)?t.assets&&e.push(...t.assets):t={},Object.assign(t,{assets:e,filename:s})}const ne=(e,t)=>e||`${ee.userSettings.outputArchiveName}-${t}`,oe=undefined;return{base:{Application:Application,Extension:Extension,File:File},lib:{},extensions:{},system:{copyHtmlPage:(e,t)=>Z(e)?te?te.copying(e,se(te.getHtmlPage(t),t)):Y(Q):Y(K),copyScriptAssets:(e,t)=>Z(e)?te?te.copying(e,se(te.getScriptAssets(t)[0],t)):Y(Q):Y(K),copyLinkAssets:(e,t)=>Z(e)?te?te.copying(e,se(te.getLinkAssets(t),t)):Y(Q):Y(K),copyImageAssets:(e,t)=>Z(e)?te?te.copying(e,se(te.getImageAssets(t),t)):Y(Q):Y(K),copyVideoAssets:(e,t)=>Z(e)?te?te.copying(e,se(te.getVideoAssets(t),t)):Y(Q):Y(K),copyAudioAssets:(e,t)=>Z(e)?te?te.copying(e,se(te.getAudioAssets(t),t)):Y(Q):Y(K),copyFontAssets:(e,t)=>Z(e)?te?te.copying(e,se(te.getFontAssets(t),t)):Y(Q):Y(K),saveHtmlPage:(e,t)=>te?te.archiving("",se(te.getHtmlPage(t),t,ne(e,"html"))):Y(Q),saveScriptAssets:(e,t)=>te?te.archiving("",se(te.getScriptAssets(t)[0],t,ne(e,"script"))):Y(Q),saveLinkAssets:(e,t)=>te?te.archiving("",se(te.getLinkAssets(t),t,ne(e,"link"))):Y(Q),saveImageAssets:(e,t)=>te?te.archiving("",se(te.getImageAssets(t),t,ne(e,"image"))):Y(Q),saveVideoAssets:(e,t)=>te?te.archiving("",se(te.getVideoAssets(t),t,ne(e,"video"))):Y(Q),saveAudioAssets:(e,t)=>te?te.archiving("",se(te.getAudioAssets(t),t,ne(e,"audio"))):Y(Q),saveFontAssets:(e,t)=>te?te.archiving("",se(te.getFontAssets(t),t,ne(e,"font"))):Y(Q)},create:()=>(ee=new Application(4,squared.base.Node,squared.base.Controller,squared.base.ExtensionManager,squared.base.Resource),te=new File,ee.resourceHandler.fileHandler=te,{application:ee,framework:4,userSettings:Object.assign({},X)}),cached(){return ee?{application:ee,framework:4,userSettings:ee.userSettings}:this.create()}}}();
