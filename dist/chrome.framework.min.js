var chrome=function(){"use strict";var e=squared.base.Resource;const{DOM:t}=squared.base.lib.regex,{createElement:s}=squared.lib.dom,{convertWord:n,escapePattern:o,findReverse:i,fromLastIndexOf:r,isPlainObject:a,hasValue:c,lastItemOf:l,replaceAll:u,resolvePath:d,splitPair:m,splitPairEnd:p,splitPairStart:f,splitSome:h,startsWith:g}=squared.lib.util,{parseTask:v,parseWatchInterval:b}=squared.base.lib.internal,{appendSeparator:y,fromMimeType:A,parseMimeType:x,generateUUID:S,getComponentEnd:w,trimEnd:T}=squared.base.lib.util,U=new WeakMap;let C=0;function E(e,t){if(t){const s=new RegExp(`^${e}\\s*:(.+)$`).exec(t.trim());if(s){const[e,t]=m(s[1],"::",!0);return{file:u(e,"\\","/"),format:t}}}}function O(e){const t={};if(e){-1!==e.indexOf("inline")&&(t.inline=!0),-1!==e.indexOf("preserve")&&(t.preserve=!0),-1!==e.indexOf("blob")&&(t.blob=!0),-1!==e.indexOf("extract")&&(t.extract=!0),-1!==e.indexOf("crossorigin")&&(t.download=!1);const s=/\bcompress\[([^\]]+)\]/g;let n;for(;n=s.exec(e);)(t.compress||(t.compress=[])).push({format:n[1].trim()})}return t}function _(e,t,s){if(g(e,"./")&&(e=e.substring(2)),-1===e.indexOf("/"))return["",e];let n;if("/"===e[0])n="__serverroot__",e=e.substring(1);else if(g(e,"../")){n="__serverroot__";const t=location.pathname.split("/");if(--t.length)for(let s=0,n=e.length;s<n&&("../"===e.substring(s,s+3)&&0!=--t.length);s+=3);e=(t.shift()?t.join("/")+"/":"")+e.split("../").pop()}const o=m(e,"/",!1,!0);return t&&(o[1]=W(o[1],s)),n&&o.push(n),o}function k(e,t){const s=d(e instanceof HTMLObjectElement?e.data:e.src);s&&t.set(e,s)}function I(e){for(const t in e){const s=e[t],n=s.length;if(n>1){const e=[],t=++C;for(let o=0;o<n;++o){const n=s[o];n.bundleId=t,n.bundleIndex=o,o>0&&delete n.cloudStorage,n.uri&&e.push(new URL(n.uri))}e:if(e.length===n){const{origin:t,pathname:o}=e[0];let i=o.split("/");for(let s=1;s<n;++s){const n=e[s];if(n.origin!==t)break e;if(i.length){const e=n.pathname.split("/");for(let t=0;t<e.length;++t)if(i[t]!==e[t]){i=i.slice(0,t);break}}}s[0].bundleRoot=t+i.join("/")+"/"}}}}function M(e,t,s,n,o,r,a,c){const l=t.innerHTML;if(l.trim()){const[u,d,m]=_(s),p={uri:G(),pathname:u,filename:d,moveTo:m,content:l,mimeType:n,format:o,preserve:r,document:c};a&&(p.inlineContent=$(t));const f=i(e,(e=>e.mimeType===n&&!e.exclude));if(!f||!Q(f,p,!0))return R(e,p),p;(f.trailingContent||(f.trailingContent=[])).push(l),L(e,{exclude:!0},t,c)}return null}function F(e,t){const s=(t.moveTo||"")+t.pathname+t.filename;s&&(e[s]||(e[s]=[])).push(t)}function j(e,t){for(const s of e)if(Q(s,t,!0)){if(s.mimeType===t.mimeType)return!1;R(e,t);break}return!0}function R(e,t){const s=t.filename;let n=0;for(;e.find((e=>Q(e,t,!1)));){const[e,s]=m(t.filename,".");t.filename=e+"_"+ ++n+(s?"."+s:"")}n>0&&U.set(t,s)}function L(e,t,s,n){return t.exclude?(e.push({pathname:"",filename:"",exclude:!0,element:s,document:n}),!0):!!t.ignore}function D(e,t,s){const n=N(e,t,s||e&&W(e));return n?[n,!1]:t&&"~"!==t?[t,!0]:["",!1]}function N(e,t,s){if("~"===t&&(t=""),e&&!t&&s)try{const n=new URL(e);if(location.origin!==n.origin||!g(n.pathname,t=f(location.pathname,"/",!1,!0)))return"";{const e=n.pathname.substring(t.length+1);if(-1===e.indexOf("/"))return s;t=f(e,"/",!1,!0)}}catch(e){}return t&&s&&y(t,s)}function q(e,t,s){var n,o;const i=(n=t.dataset)[o=s+"Id"]||(n[o]=S());(e.id||(e.id={}))[s]=i}function P(e){return{pathname:"",filename:"",mimeType:e,format:"crossorigin"}}function H(e){if(e){switch(e){case"base64":case"crossorigin":case"blob":case"srcset":return!1}return!0}return!1}function V(t){if(void 0!==t&&-1!==t)return e.ASSETS[t]}const W=(e,t)=>"__assign__."+(t||e&&X(e)||"unknown"),z=(e,t)=>"boolean"==typeof e?!e:!!t,$=e=>e instanceof HTMLLinkElement?"style":e.tagName.toLowerCase(),B=(e,t,s)=>Object.assign(Object.assign({},e),{attributes:t,append:s}),K=(e,t)=>e&&e.get(t),J=(e,t,s="")=>e.type.trim().toLowerCase()||t&&x(t)||s,X=e=>p(e,".",!0,!0).toLowerCase(),G=()=>location.origin+location.pathname,Q=(e,t,s)=>e.pathname===t.pathname&&(e.filename===t.filename||U.get(e)===t.filename||s&&g(e.filename,"__assign__"))&&(e.moveTo||"")===(t.moveTo||"");class File extends squared.base.File{static createTagNode(e,t,s){const n=e.tagName.toLowerCase(),o=s[n]||(s[n]=document.querySelectorAll(n)),i=o.length;let r=-1,a=-1;for(let s=0,n=t.length;s<n;++s)t[s]===e&&(r=s);for(let t=0;t<i;++t)if(o[t]===e){a=t;break}return{index:r,tagName:n,tagIndex:a,tagCount:i,ignoreCase:!0}}static setDocumentId(e,t,s){Array.isArray(s)?s.forEach((s=>q(e,t,s))):s&&q(e,t,s)}static parseUri(e,t,s){let o,i,r,a,c,p;s&&({saveAs:o,saveTo:i,mimeType:r,format:a,pathname:c,fromConfig:p}=s),r||(r=x(e));let h=T(e,"/"),v;const b=g(h,location.origin);if(!b&&t)return P(r);if(o){if(o=T(u(o,"\\","/"),"/"),i||p)v=o;else{const e=E("saveAs",o);e?({file:v,format:a}=e):v=o}"~"===v?v="":b&&v&&(h=d(v))}try{const{host:t,port:s,pathname:o}=new URL(h),[u,d]=m(o,"/",!1,!0);let p,y;if(v)[c,y,p]=_(v,i,X(e));else if(void 0===c)if(b){let e=location.pathname;"/"!==l(e)&&(e=f(e,"/",!1,!0)),g(u,e)?c=u.substring(e.length+1):(p="__serverroot__",c="/"===u[0]?u.substring(1):u)}else c=n(t)+(s?"/"+s.substring(1):"")+u;return{uri:e,moveTo:p,pathname:decodeURIComponent(c),filename:decodeURIComponent(y||d),mimeType:r,format:a}}catch(e){}return null}copyTo(e,t){return this.copying(e,this.processAssets(t))}appendTo(e,t){return this.archiving(e,this.processAssets(t))}saveAs(e,t){return e&&(t.filename=e),this.archiving("",this.processAssets(t))}getHtmlPage(e){var t;const s=document.documentElement;let n=s.dataset.chromeFile,o,i;if("ignore"===n)return[];e&&(o=e.assetMap,i=null===(t=e.saveAs)||void 0===t?void 0:t.html);const r=K(o,s)||i;let a,c,l,u,d,m,p,f;if(r){if(r.ignore||r.exclude)return[];({filename:a,compress:l,process:u,tasks:d,attributes:m,cloudStorage:p,document:f}=r)}else{const{chromeOptions:e,chromeTasks:t}=s.dataset;l=O(e).compress,d=v(t)}a&&(n=""),u&&(c=u.join("+"));const h=File.parseUri(location.href,!1,{saveAs:n,mimeType:"text/html",format:c,pathname:""});return this.processExtensions(h,s,m,f,p,l,d)?(a&&(h.filename=a),H(h.format)&&(h.willChange=!0),[h]):[]}getScriptAssets(e){var t;let s,n,o;e&&(({assetMap:s,preserveCrossOrigin:n}=e),o=null===(t=e.saveAs)||void 0===t?void 0:t.script);const i=[],r={};let a;const c=(e,t,s,n)=>{var o;a||(a={});const i=undefined;("data"===e?a[e]||(a[e]={}):(o=a[e]||(a[e]={}))[t]||(o[t]={}))[s]=n.trim()};if(s)for(const{template:e,type:t,selector:n}of s.values())if(e&&t&&!n)switch(t){case"html":case"js":case"css":{let{module:s,identifier:n,value:o}=e;s&&n&&o&&-1!==o.indexOf("function")&&c(t,s,n,o);break}case"data":{let{value:s,identifier:n}=e;n&&s&&-1!==s.indexOf("function")&&c(t,"",n,s);break}}return document.querySelectorAll("script").forEach((e=>{const t=e.dataset.chromeTemplate;let a=e.type.toLowerCase();if(t||"text/template"===a){const n=K(s,e);let o,r,a;if(n?(o=n.type,n.template&&({module:r,identifier:a}=n.template)):t&&([o,r,a]=t.split("::").map(((e,t)=>(0===t?e.toLowerCase():e).trim()))),r){if("data"===o)return c(o,"",r,e.textContent),void L(i,{exclude:!0},e);if(a)switch(o){case"html":case"js":case"css":return c(o,r,a,e.textContent),void L(i,{exclude:!0},e)}}n&&L(i,n,e)}else if("application/json"!==a&&"application/ld+json"!==a){const t=e.src;a=J(e,t,"text/javascript"),"application/javascript"===a&&(a="text/javascript"),this.createBundle(!0,i,e,t,a+"|"+(e.defer?"1":"0")+(e.async?"1":"0")+(e.noModule?"1":"0"),"js",{preserveCrossOrigin:n,bundleIndex:r,assetMap:s,saveAsOptions:o})}})),I(r),[i,a]}getLinkAssets(e){var t,s,n;let i,a,c,l;e&&(({resourceId:i,assetMap:a,preserveCrossOrigin:c}=e),l=null===(t=e.saveAs)||void 0===t?void 0:t.link);const u=[],m={},p=new WeakMap;document.querySelectorAll("link, style").forEach((e=>{let t="";if(e instanceof HTMLLinkElement){const s=e.rel.trim().toLowerCase();if(t=e.href,"stylesheet"!==s){const n=e.dataset.chromeFile;if("exclude"===n||"ignore"===n)return;let o;const i=()=>{const s=r(t,"/");return-1!==s.indexOf(".")&&(o=J(e,s),!0)};if(t&&-1!==s.indexOf("icon")&&i()&&g(o,"image/")){const s=this.processImageUri(u,e,t,void 0,c,a,o);s&&delete s.format}else{const s=K(a,e);if(s){if(L(u,s,e,s.document))return;if(i(),s.download&&t){const i=File.parseUri(t,!1,{saveAs:n,mimeType:o,pathname:s.pathname});this.processExtensions(i,e,s.attributes,s.document,s.cloudStorage,s.compress,s.tasks,s.watch)&&(s.filename&&(i.filename=s.filename),u.push(i))}else{const t=P(o);this.processExtensions(t,e,s.attributes,s.document)&&u.push(t)}}else if(t){const s=e.dataset.chromeOptions;if(s){const{download:r,compress:a}=O(s);if(r&&t){const{chromeTasks:s,chromeWatch:r}=e.dataset;i();const c=File.parseUri(t,!1,{saveAs:n,mimeType:o});this.processExtensions(c,e,null,null,null,a,v(s),b(r))&&u.push(c)}}}}return}}const s=this.createBundle(!0,u,e,t,"text/css","css",{preserveCrossOrigin:c,bundleIndex:m,assetMap:a,saveAsOptions:l});s&&p.set(e,s)}));const f=null===(s=V(i))||void 0===s?void 0:s.rawData;if(f){const e=document.styleSheets,t=e.length;for(const[s,i]of f)e:if("text/css"===i.mimeType){try{t:if(new URL(s).origin===location.origin)for(let i=0;i<t;++i){const t=e[i].cssRules;for(let e=0,i=t.length,r;e<i;++e){const i=t[e];if(i.type===i.IMPORT_RULE&&(r=null===(n=i.parentStyleSheet)||void 0===n?void 0:n.ownerNode)&&d(i.href,r.href)===s){const e=p.get(r);if(e){let t=a&&a.get(r),n;if(t||(null==l?void 0:l.extract)){const d={preserveCrossOrigin:c,bundleIndex:m};if(t){const e=r.dataset.chromeFile;(t.extract||e&&-1!==e.indexOf("extract"))&&(n=!0),d.assetMap=a}else if(null==l?void 0:l.extract){if(l.customize&&null===l.customize.call(null,s,"text/css",Object.assign({},l)))continue;t=Object.assign({},l),d.assetCommand=t,n=!0}if(t){n&&(t.pathname=(e.moveTo?"/":"")+e.pathname,t.filename=e.filename);const a=this.createBundle(!0,u,r,s,"text/css","css",d);if(a){n&&(a.bundleReplace=o(i.cssText).replace(/\("/,"(\\s*[\"']?\\s*").replace(/"\\\)/,"\\s*[\"']?\\s*\\)").replace(/\s+/g,"\\s+")),delete a.element;break e}}}}break t}}}}catch(e){}let i=l,r,f,h,g,v,b,A,x,S;if(i){if(i.customize){if(null===(f=i.customize.call(null,s,"text/css",i=Object.assign({},i))))continue;i.pathname&&f&&(r=y(i.pathname,f))}({compress:h,download:g,preserve:v,process:b,tasks:A,cloudStorage:x,document:S}=i)}const w=File.parseUri(d(s),z(g,c),{saveAs:r,mimeType:"text/css",format:b?b.join("+"):""});this.processExtensions(w,null,null,S,x,h,A)&&(f&&(w.filename=f),v&&(w.preserve=!0),u.push(w))}}return I(m),u}getImageAssets(s){var n;let o,i,r,a;s&&(({resourceId:o,assetMap:i,preserveCrossOrigin:r}=s),a=null===(n=s.saveAs)||void 0===n?void 0:n.image);const c=[];document.querySelectorAll("img, input[type=image], picture > source[src], video[poster]").forEach((t=>{let s=t instanceof HTMLVideoElement?t.poster:t.src,n,o;const l=e.parseDataURI(s);if(l){if(!(o=l.base64))return;s=W("",(n=l.mimeType)&&A(n))}this.processImageUri(c,t,d(s),a,r,i,n,o)})),document.querySelectorAll("img[srcset], picture > source[srcset]").forEach((e=>{h(e.srcset,(s=>{const n=t.SRCSET.exec(s);if(n){const t=d(n[1]);t!==d(e.src)&&this.processImageUri(c,e,t,a,r,i,void 0,void 0,!0)}}))}));const l=V(o);if(l){for(const t of l.image.keys()){const s=e.parseDataURI(t);s?s.base64&&this.resource.addRawData(o,t,s):this.processImageUri(c,null,t,a,r)}if(l.rawData)for(const e of l.rawData.values()){const{base64:t,content:s,mimeType:n=x(e.filename)}=e;if(t){if(null==a?void 0:a.blob){let s=a,o,i;if(s.customize&&null===(o=s.customize.call(null,"",n,s=Object.assign({},s))))continue;const r=s.pathname;if(o||(o=e.filename),g(n,"image/")&&(i=s.commands))for(let e=0;e<i.length;++e){const t=/^([a-z]+)\s*[@%]?(.*)$/.exec(i[e].trim());t?i[e]=t[1]+"@"+t[2]:i.splice(e--,1)}const l=this.processImageUri(c,null,d(r?y(r,o):o),s,!1,void 0,n||"image/unknown",t);l&&(i&&i.length?l.commands=i:delete l.commands,r||delete l.uri,this.processExtensions(l)&&c.push(l))}}else if(s&&n){const t={pathname:"__generated__/"+n.split("/").pop(),filename:W(e.filename),content:s,mimeType:n};this.processExtensions(t)&&c.push(t)}}}return c}getVideoAssets(e){return this.getRawAssets("video",e)}getAudioAssets(e){return this.getRawAssets("audio",e)}getFontAssets(e){var t;let s,n,o;e&&(({resourceId:s,preserveCrossOrigin:n}=e),o=null===(t=e.saveAs)||void 0===t?void 0:t.font);const i=[],r=V(s);if(r)for(const e of r.fonts.values())for(const{srcUrl:t,srcBase64:s,mimeType:r}of e){let e=o,a,c,l,u,m;if(e){if(e.customize&&null===(l=e.customize.call(null,t||"",r,e=Object.assign({},e))))continue;({pathname:c,inline:u,blob:m}=e)}t?(a=File.parseUri(t,!0!==u&&n))&&u&&(a.format="base64"):s&&m&&(l||(l=W("",A(r))),(a=File.parseUri(d(c?y(c,l):l)))&&(a.format="blob",a.base64=s)),this.processExtensions(a)&&i.push(a)}return i}finalizeRequestBody(e){var t;const n=e.productionRelease;let o;if(!n&&e.watch){const n={},i=new URL(this.hostname).hostname,r=this.application.userSettings;for(const{watch:s}of e.assets)if(a(s)&&s.reload){const e=s.reload;let{socketId:o,secure:a,handler:l={},port:u=(a?r.webSocketSecurePort:r.webSocketPort)}=e;o&&c(u)&&Math.floor(u=+u)>0&&(n[t=o+`_${u}_`+(a?"0":"1")]||(n[t]=`socket=new WebSocket("${a?"wss":"ws"}://${i}:${u}");`+(l.open?`socket.onopen=${l.open};`:"")+"socket.onmessage="+(l.message||`function(e){var c=JSON.parse(e.data);if(c&&c.socketId==="${o}"&&c.module==="watch"&&c.action==="modified"){if(!c.errors||!c.errors.length){if(c.hot){if(c.type==="text/css"){var a=document.querySelectorAll('link[href^="'+c.src+'"]');if(a.length){a.forEach(function(b){b.href=c.src+c.hot;});return;}}else if(c.type.startsWith("image/")){var a=document.querySelectorAll('img[src^="'+c.src+'"]');if(a.length){a.forEach(function(b){b.src=c.src+c.hot;});return;}}}window.location.reload();}else{console.log("FAIL: "+c.errors.length+" errors\\n\\n"+c.errors.join("\\n"));}}}`)+";"+(l.error?`socket.onerror=${l.error};`:"")+(l.close?`socket.onclose=${l.close};`:""))),delete e.handler}if(Object.keys(n).length){let t='document.addEventListener("DOMContentLoaded", function(){var socket;';for(const e in n)t+=n[e];if(t+="});",e.useOriginalHtmlPage){const s=e.assets.find((e=>"@text/html"===e.mimeType));s&&(s.element.textContent=`<script>${t}<\/script>`)}else o=s("script",{parent:document.body,attributes:{textContent:t}})}}if(!e.useOriginalHtmlPage){let t;for(const s of e.assets){const e=s.element;if(e){switch(e.tagName){case"html":e.innerXml=document.documentElement.innerHTML;break;case"script":o&&++e.tagCount}o&&(t=e.append)&&"script"===t.tagName&&++t.tagCount}n&&s.watch&&delete s.watch}if(o&&document.body.removeChild(o),e.document)for(const t of e.document){const e=t+"Id";document.querySelectorAll(`[data-${t}-id]`).forEach((t=>delete t.dataset[e]))}e.removeInlineStyles&&document.querySelectorAll("[style]").forEach((e=>e.removeAttribute("style")))}}getCopyQueryParameters(e){return e.watch&&!e.productionRelease?"&watch=1":""}getRawAssets(e,t){var s;let n,o,i;t&&(({assetMap:n,preserveCrossOrigin:o}=t),i=null===(s=t.saveAs)||void 0===s?void 0:s.image);const r=[];return document.querySelectorAll(e).forEach((e=>{const t=new Map;switch(e.tagName.toUpperCase()){case"VIDEO":case"AUDIO":e.querySelectorAll("source, track").forEach((e=>k(e,t)));break;case"IFRAME":if(!K(n,e)&&!g(e.dataset.chromeFile,"saveTo"))return;case"OBJECT":case"EMBED":{const t=e instanceof HTMLObjectElement?e.data:e.src,s=e.type||x(t);if(g(s,"image/"))return void this.processImageUri(r,e,t,i,o,n,s);break}}k(e,t);for(const[s,i]of t){const t=s.dataset.chromeFile;if("ignore"===t)continue;const a=K(n,s);let c,l,u,d,m,p,f,h,g,y,x,S;if(a){if(({filename:d,compress:m,download:p,tasks:f,watch:h,attributes:g,cloudStorage:y,document:x}=a),L(r,a,s,x))continue;[c,l]=D(i,a.saveTo||a.pathname,d||w(i)),c&&(d=""),S=!0}else{const e=E("saveAs",t);e&&(c=e.file);const{chromeOptions:n,chromeTasks:o,chromeWatch:i}=s.dataset;({compress:m,download:p}=O(n)),f=v(o),h=b(i)}switch(s.tagName.toUpperCase()){case"OBJECT":case"EMBED":case"SOURCE":{const t=e.type.trim().toLowerCase();A(t)&&(u=t);break}}const T=File.parseUri(i,z(p,o),{saveAs:c,saveTo:l,mimeType:u,fromConfig:S});this.processExtensions(T,s,g,x,y,m,f,h)&&(d&&(T.filename=d),r.push(T))}})),r}processAssets(e){var t;const{assetMap:s,appendMap:n,nodeMap:o=new Map,useOriginalHtmlPage:i,preserveCrossOrigin:r}=e,a=document.querySelectorAll("*"),c={},l=this.getHtmlPage(e).concat(this.getLinkAssets(e));e.saveAsWebPage&&l.forEach((e=>{switch(e.mimeType){case"text/html":case"text/css":e.mimeType="@"+e.mimeType,e.willChange=!0}}));const[u,d]=this.getScriptAssets(e);if(u.forEach((e=>{let t=e.mimeType;t&&(t=f(t,"|"),e.mimeType="module"===t?"application/javascript":t),(H(e.format)||e.bundleId||e.trailingContent)&&(e.willChange=!0)})),l.push(...u,...this.getImageAssets(e),...this.getVideoAssets(e),...this.getAudioAssets(e),...this.getRawAssets("object",e),...this.getRawAssets("embed",e),...this.getRawAssets("iframe",e),...this.getFontAssets(e)),n){const e={},o=(t,s)=>(t in e||(e[t]=document.querySelectorAll(t).length),{tagName:t,tagCount:e[t],order:s});for(const[e,u]of n){const n=File.createTagNode(e,a,c),d=null===(t=K(s,e))||void 0===t?void 0:t.document,m=()=>n.index+e.querySelectorAll("*").length+1;i||File.setDocumentId(n,e,d),n.outerXml=e.outerHTML.trim();let f=0,h=0;for(const t of u){const{type:s,attributes:i,download:a,textContent:c}=t;let u,v,b;switch(s){case"prepend/js":b=!0;case"append/js":i&&(v=i.src,i.type||(i.type="text/javascript"),u=!0);break;case"prepend/css":b=!0;case"append/css":i&&(v=i.href,i.type||(i.type="text/css"));break;default:{let e;if("replace"===s)c&&(e=B(n,i),e.textContent=c);else{if(b=g(s,"prepend/"),!b&&!g(s,"append/"))continue;const t=o(p(s,"/",!0,!0).toLowerCase(),b?++h:++f);b?(t.prepend=!0,e=B(n,i,t)):(t.nextSibling=m(),e=B(n,i,t)),c&&(t.textContent=c)}e&&l.push({pathname:"",filename:"",document:d,element:e});continue}}if(v&&i){t.document||(t.document=d),delete t.download;const s=this.createBundle(!1,l,e,v,i.type,u?"js":"css",{appendCommand:t});if(s){z(a,r)&&delete s.uri;const e=u?"script":"link";let t;b?(t=o(e,++h),t.prepend=b):(t=o(e,++f),t.nextSibling=m()),s.element=B(n,i,t)}}}}}const m=this.application.userSettings.outputDocumentHandler,h=document.documentElement;for(const e of l){const t=e.element;if(t instanceof Element){const s=File.createTagNode(t,a,c);i||File.setDocumentId(s,t,e.document),e.element=s,o.set(s,t)}e.document||(e.document=File.copyDocument(m))}for(const[e,t]of o)t!==h&&(e.outerXml=t.outerHTML.trim());return e.assets&&l.push(...e.assets),e.assets=l,e.baseUrl=G(),d&&(e.templateMap=d),delete e.saveAs,delete e.assetMap,delete e.indexMap,delete e.nodeMap,delete e.appendMap,delete e.sessionId,delete e.resourceId,e}createBundle(e,t,s,n,o,i,r){const{preserveCrossOrigin:a,bundleIndex:c,assetMap:l,assetCommand:u,appendCommand:m}=r;let p=u||m?"":s.dataset.chromeFile;if("exclude"===p||"ignore"===p)return;const f=K(l,s)||m||u;let h,g,y,A,x,w,T,U,C,_,k,I,R,q,V;if(f){if(({inline:y,compress:x,download:w,preserve:T,process:A,tasks:U,watch:C,attributes:_,cloudStorage:k,document:I}=f),L(t,f,s,I))return;p=n?f.saveAs:f.exportAs,p||!f.filename||f.pathname&&(p=D(n,f.pathname,f.filename)[0])||(h=f.filename),R=!0}else{let a=e&&r.saveAsOptions;if(a){if(a.customize&&null===(h=a.customize.call(null,n||"",o,a=Object.assign({},a))))return;if(({inline:y,compress:x,download:w,preserve:T,process:A,tasks:U,watch:C,attributes:_,cloudStorage:k,document:I}=a),L(t,a,s,I))return;a.filename||(a.filename=h||S(this.userSettings.formatUUID,this.userSettings.formatDictionary)+"."+i),h||(h=a.filename),n?(p=N(n,a.pathname,h))&&(h=""):(p="./"+h,h="",q=!0)}const{chromeOptions:c,chromeTasks:l,chromeWatch:u}=s.dataset,d=O(c);null!=y||(y=d.inline),null!=T||(T=d.preserve),x||(x=d.compress),null!=w||(w=d.download),U||(U=v(l)),C||(C=b(u))}if(A&&(g=A.join("+")),n){if((V=File.parseUri(d(n),z(w,a)||m&&T,{saveAs:p,mimeType:o,format:g,fromConfig:R}))&&"crossorigin"!==V.format)if(m){if(y)switch(m.type){case"append/js":V.inlineContent="script";break;case"append/css":V.inlineContent="style"}}else y&&(V.inlineContent=$(s)),e&&j(t,V)&&(V.bundleIndex=-1)}else if(p&&e){if(!R&&!q){const e=E("exportAs",p);e&&({file:p,format:g}=e)}(V=M(t,s,p,o,g,T,y,I))&&(V.bundleIndex=-1)}else s instanceof HTMLScriptElement||(V=P(o));return this.processExtensions(V,u||m?null:s,_,I,k,x,U,C)?(h&&(V.filename=h),T&&(V.preserve=!0),c&&F(c,V),H(V.format)&&(V.willChange=!0),t.push(V),V):void 0}processImageUri(e,t,s,n,o,i,r,a,c){if(s){let l,u,d,m,p,f,h,g,y,A,x,S,T,U,C,_;const k=e=>!e.customize||null!==(p=e.customize.call(null,s,r||"",l=Object.assign({},e)));if(t){const o=t.dataset.chromeFile;if("ignore"===o)return;if(l=K(i,t)){if(({pathname:m,filename:p,inline:h,compress:g,download:y,blob:A,commands:f,tasks:x,watch:S,attributes:T,cloudStorage:U,document:C}=l),L(e,l,t,C))return;[u,d]=D(s,l.saveTo||m,p||w(s)),u&&(p=""),_=!0}else{if(n){if(!k(l=n))return;if(({pathname:m,inline:h,compress:g,download:y,blob:A,commands:f,tasks:x,watch:S,attributes:T,cloudStorage:U,document:C}=l),L(e,n,t,C))return;[u,d]=D(s,m,p||w(s))}if(o&&!m){let e=E("saveTo",o);e?[u,d]=D(s,e.file,p||w(s)):(e=E("saveAs",o))&&(u=e.file)}const{chromeCommands:i,chromeOptions:r,chromeTasks:a,chromeWatch:c}=t.dataset;i&&(f||(f=i.split("::").map((e=>e.trim()))));const _=O(r);null!=h||(h=_.inline),g||(g=_.compress),null!=y||(y=_.download),null!=A||(A=_.blob),x||(x=v(a)),S||(S=b(c))}}else if(n){if(!k(l=n))return;({pathname:m,inline:h,compress:g,download:y,blob:A,commands:f,tasks:x,cloudStorage:U}=l),[u,d]=D(s,m,p||w(s))}if(a&&!A)return;!f||0!==f.length&&"~"!==f[0]||(f=void 0);const I=File.parseUri(s,z(y,o),{saveAs:u,saveTo:d,mimeType:r,fromConfig:_});if(this.processExtensions(I,t,T,C,U,g,x,S,!!f)){if(p&&(I.filename=p),a){if(!_&&e.find((e=>e.base64===a)))return;I.format="blob",I.base64=a}else if(c)I.format="srcset";else if(h)I.format="base64";else if(!t&&e.find((e=>e.moveTo===I.moveTo&&e.pathname===I.pathname&&e.filename===I.filename&&-1===I.filename.indexOf("__assign__"))))return;return f?(I.commands=f,I.willChange=!0):g&&(I.willChange=!0),e.push(I),I}}}processExtensions(e,t,s,n,o,i,r,a,c){if(e){i&&(e.compress=i,c=!0),r&&(e.tasks=r,c=!0),s&&(e.attributes=s,c=!0),o&&(e.cloudStorage=o,c=!0),a&&(e.watch=a,c=!0),t&&(e.element=t),n&&(e.document=n);for(const t of this.application.extensions)if(!t.processFile(e))return!1;return c||"crossorigin"!==e.format}return!1}get application(){return this.resource.application}get userSettings(){return this.application.userSettings}}const{STRING:Y}=squared.base.lib.regex,{UNABLE_TO_FINALIZE_DOCUMENT:Z,reject:ee}=squared.lib.error,{escapePattern:te,isPlainObject:se,splitSome:ne}=squared.lib.util,{trimBoth:oe}=squared.base.lib.util,ie=new RegExp(Y.CSS_VARVALUE+"|"+Y.CSS_VARNAME,"g"),re=new RegExp(Y.CSS_VARNAME,"g"),ae=new RegExp(Y.CSS_VARVALUE,"g");class Application extends squared.base.Application{constructor(){super(...arguments),this.extensions=[],this.systemName="chrome",this._cssVariables={},this._cssUsedVariables={},this._cssUsedFontFace={},this._cssUsedKeyframes={},this._cssUnusedSelectors={},this._cssUnusedMedia={},this._cssUnusedSupports={}}init(){this.session.usedSelector=function(e,t){var s,n,o,i,r;const{fontFamily:a,animationName:c}=t.style;let l,u,d,m,p;for(;p=ie.exec(t.cssText);)p[3]&&(u||(u=(s=this._cssUsedVariables)[e]||(s[e]=new Set)),u.add(p[3]));for(;p=ae.exec(t.cssText);)l||(l=(n=this._cssVariables)[e]||(n[e]={})),(l[o=p[1]]||(l[o]=new Set)).add(p[2].trim());a&&(d||(d=(i=this._cssUsedFontFace)[e]||(i[e]=new Set)),ne(a,(e=>{d.add(oe(e))}))),c&&(m||(m=(r=this._cssUsedKeyframes)[e]||(r[e]=new Set)),ne(c,(e=>{m.add(e)}))),ie.lastIndex=0,ae.lastIndex=0},this.session.unusedSelector=function(e,t,s,n){var o;n||((o=this._cssUnusedSelectors)[e]||(o[e]=new Set)).add(s)},this.session.unusedMedia=function(e,t,s,n){var o;n||((o=this._cssUnusedMedia)[e]||(o[e]=new Set)).add(s)},this.session.unusedSupports=function(e,t,s,n){var o;n||((o=this._cssUnusedSupports)[e]||(o[e]=new Set)).add(s)},super.init()}reset(){this._cssVariables={},this._cssUsedVariables={},this._cssUsedFontFace={},this._cssUsedKeyframes={},this._cssUnusedSelectors={},this._cssUnusedMedia={},this._cssUnusedSupports={},super.reset()}insertNode(e,t){if("#"===t.nodeName[0]){if(this.getUserSetting(e,"excludePlainText"))return;this.controllerHandler.applyDefaultStyles(e,t)}return this.createNodeStatic(e,t)}saveAs(e,t){return this.processAssets("saveAs",e,t)}copyTo(e,t){return this.processAssets("copyTo",e,t)}appendTo(e,t){return this.processAssets("appendTo",e,t)}async processAssets(e,t,s){const n=await this.parseDocument();if(!n)return ee(Z);const o=n.sessionId,i=undefined,r=this.getProcessing(o).resourceId,a=[],c=new Map,l=new Map,u=new Map,d=(s=Object.assign(Object.assign({},s),{saveAsWebPage:!0,sessionId:o,resourceId:r,assetMap:c,nodeMap:l,appendMap:u})).retainUsedStyles,m=d?d.filter((e=>"string"==typeof e)):[],p=e=>{const t=[];return e.forEach((e=>!t.includes(e)&&t.push(e))),t};if(s.removeUnusedVariables){const e=this._cssVariables[o];let t=p(Array.from(this._cssUsedVariables[o]||[]).concat(m.filter((e=>e.startsWith("--")))));if(e){const s=new Set;for(const n of t)!function t(n){if(n){const o=new RegExp(re);let i;for(const r of n){for(;i=o.exec(r);)s.add(i[1]),t(e[i[1]]);o.lastIndex=0}}}(e[n]);s.size&&(t.forEach((e=>s.add(e))),t=Array.from(s))}s.usedVariables=t,delete s.removeUnusedVariables}if(s.removeUnusedFontFace&&(s.usedFontFace=p(Array.from(this._cssUsedFontFace[o]||[]).concat(m.filter((e=>e.startsWith("|font-face:")&&e.endsWith("|"))).map((e=>oe(e,"|").substring(10).trim())))),delete s.removeUnusedFontFace),s.removeUnusedKeyframes&&(s.usedKeyframes=p(Array.from(this._cssUsedKeyframes[o]||[]).concat(m.filter((e=>e.startsWith("|keyframes:")&&e.endsWith("|"))).map((e=>oe(e,"|").substring(10).trim())))),delete s.removeUnusedKeyframes),s.removeUnusedMedia){const e=this._cssUnusedMedia[o];if(e){const t=[],n=m.filter((e=>e.startsWith("|media:")&&e.endsWith("|"))).map((e=>oe(e,"|").substring(6).trim()));e.forEach((e=>!n.includes(e)&&t.push(e))),t.length&&(s.unusedMedia=t)}delete s.removeUnusedMedia}if(s.removeUnusedSupports){const e=this._cssUnusedSupports[o];if(e){const t=[],n=m.filter((e=>e.startsWith("|supports:")&&e.endsWith("|"))).map((e=>oe(e,"|").substring(9).trim()));for(const s of e)n.includes(s)||t.push(s);t.length&&(s.unusedSupports=t)}delete s.removeUnusedSupports}if(s.removeUnusedClasses||s.removeUnusedPseudoClasses){const e=this._cssUnusedSelectors[o];if(e){const t=[];for(const n of e)!(-1!==n.indexOf(":")?s.removeUnusedPseudoClasses:s.removeUnusedClasses)||d&&d.find((e=>"string"==typeof e?e===n:e.test(n)))||t.push(n);t.length&&(s.unusedStyles=t)}delete s.removeUnusedClasses,delete s.removeUnusedPseudoClasses}const f=File.findConfigUri(s);if(f){const e=await this.fileHandler.loadConfig(f,s);if(e){const t=this.userSettings.outputDocumentHandler,s=new Map,n=e=>{const t=typeof e;if(e&&("object"===t||"string"===t)){const n="object"===t?JSON.stringify(e):e;let o=n;for(const[e,t]of s.values())o=o.replace(e,((...e)=>{const s=e[1];return s?s+t.replace(new RegExp(`(?:^${s}|([^\\\\])${s})`,"g"),((...e)=>(e[1]||"")+"\\"+s))+s:t}));if(o!==n){if("object"!==t)return o;try{return JSON.parse(o)}catch(e){}}}return e};location.search&&new URLSearchParams(location.search).forEach(((e,t)=>s.set(t,[new RegExp(`(["'])?\\{\\{\\s*${te(t)}\\s*\\}\\}\\1`,"g"),e])));for(const o of e)if(o.selector){const e=o.type;let i=se(o.dataSource)?o.dataSource:null,r=se(o.cloudDatabase)?o.cloudDatabase:null;if(s.size){const e=e=>{if(e)for(const t in e)"value"!==t&&(e[t]=n(e[t]))};e(i),e(r)}i&&(i=Object.assign(Object.assign({document:o.document||File.copyDocument(t)},i),{type:e})),r&&(r=Object.assign(Object.assign({document:o.document||File.copyDocument(t)},i),{type:e,source:"cloud"})),document.querySelectorAll(o.selector).forEach((t=>{switch(e){case"text":case"attribute":case"display":i?a.push([t,i]):r&&a.push([t,r]);break;default:if(e&&("replace"===e||e.startsWith("append/")||e.startsWith("prepend/"))){let e=u.get(t);e||u.set(t,e=[]),e.push(Object.assign({},o))}else c.set(t,Object.assign({},o))}}))}}}if(0===c.size&&delete s.assetMap,0===u.size&&delete s.appendMap,a.length){const e=s.useOriginalHtmlPage,t=document.querySelectorAll("*"),n={},o=s.dataSource||(s.dataSource=[]);for(const[s,i]of a){const r=File.createTagNode(s,t,n);r.textContent=s.textContent,i.element=r,e||File.setDocumentId(r,s,i.document),l.set(r,s),o.push(i)}}return this.fileHandler[e](t,s)}get initializing(){return!1}get length(){return 1}}class Extension extends squared.base.Extension{processFile(e){return!0}}class Node extends squared.base.Node{}const ce={builtInExtensions:[],preloadImages:!1,preloadFonts:!1,preloadCustomElements:!1,excludePlainText:!0,createElementMap:!0,pierceShadowRoot:!0,showErrorMessages:!1,webSocketPort:80,webSocketSecurePort:443,formatUUID:"8-4-4-4-12",formatDictionary:"0123456789abcdef",outputDocumentHandler:"chrome",outputEmptyCopyDirectory:!1,outputTasks:{},outputWatch:{},outputArchiveName:"chrome-data",outputArchiveFormat:"zip",outputArchiveCache:!1},{DIRECTORY_NOT_PROVIDED:le,FRAMEWORK_NOT_INSTALLED:ue,reject:de}=squared.lib.error,{isString:me,isPlainObject:pe}=squared.lib.util;let fe=null,he=null;function ge(e,t,s){return pe(t)&&t.assets&&e.push(...t.assets),Object.assign(t={},{assets:e,filename:s})}const ve=(e,t)=>e||`${fe.userSettings.outputArchiveName}-${t}`,be=undefined;return{base:{Application:Application,Extension:Extension,File:File,Node:Node},lib:{},extensions:{},system:{copyHtmlPage:(e,t)=>me(e)?he?he.copying(e,ge(he.getHtmlPage(t),t)):de(ue):de(le),copyScriptAssets:(e,t)=>me(e)?he?he.copying(e,ge(he.getScriptAssets(t)[0],t)):de(ue):de(le),copyLinkAssets:(e,t)=>me(e)?he?he.copying(e,ge(he.getLinkAssets(t),t)):de(ue):de(le),copyImageAssets:(e,t)=>me(e)?he?he.copying(e,ge(he.getImageAssets(t),t)):de(ue):de(le),copyVideoAssets:(e,t)=>me(e)?he?he.copying(e,ge(he.getVideoAssets(t),t)):de(ue):de(le),copyAudioAssets:(e,t)=>me(e)?he?he.copying(e,ge(he.getAudioAssets(t),t)):de(ue):de(le),copyFontAssets:(e,t)=>me(e)?he?he.copying(e,ge(he.getFontAssets(t),t)):de(ue):de(le),saveHtmlPage:(e,t)=>he?he.archiving("",ge(he.getHtmlPage(t),t,ve(e,"html"))):de(ue),saveScriptAssets:(e,t)=>he?he.archiving("",ge(he.getScriptAssets(t)[0],t,ve(e,"script"))):de(ue),saveLinkAssets:(e,t)=>he?he.archiving("",ge(he.getLinkAssets(t),t,ve(e,"link"))):de(ue),saveImageAssets:(e,t)=>he?he.archiving("",ge(he.getImageAssets(t),t,ve(e,"image"))):de(ue),saveVideoAssets:(e,t)=>he?he.archiving("",ge(he.getVideoAssets(t),t,ve(e,"video"))):de(ue),saveAudioAssets:(e,t)=>he?he.archiving("",ge(he.getAudioAssets(t),t,ve(e,"audio"))):de(ue),saveFontAssets:(e,t)=>he?he.archiving("",ge(he.getFontAssets(t),t,ve(e,"font"))):de(ue)},create:()=>(fe=new Application(4,Node,squared.base.Controller,squared.base.ExtensionManager,squared.base.Resource),he=new File(fe.resourceHandler),{application:fe,framework:4,userSettings:Object.assign({},ce)}),cached(){return fe?{application:fe,framework:4,userSettings:fe.userSettings}:this.create()}}}();
