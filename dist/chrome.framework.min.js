var chrome=function(){"use strict";var e=squared.base.Resource;const{DOM:t}=squared.base.lib.regex,{createElement:s}=squared.lib.dom,{convertWord:n,fromLastIndexOf:o,isPlainObject:i,hasValue:r,lastItemOf:a,replaceAll:c,resolvePath:l,splitPair:u,splitPairEnd:d,splitPairStart:m,splitSome:p,startsWith:f}=squared.lib.util,{parseTask:h,parseWatchInterval:g}=squared.base.lib.internal,{appendSeparator:v,fromMimeType:b,parseMimeType:A,generateUUID:y,getComponentEnd:S,trimEnd:x}=squared.base.lib.util,w=new WeakMap;let U=0;function T(e,t){if(t){const s=new RegExp(`^(?:^|\\s+)${e}\\s*:(.+)$`).exec(t);if(s){const[e,t]=u(s[1],"::",!0);return{file:c(e,"\\","/"),format:t}}}}function E(e){const t={};if(e){-1!==e.indexOf("inline")&&(t.inline=!0),-1!==e.indexOf("preserve")&&(t.preserve=!0),-1!==e.indexOf("blob")&&(t.blob=!0),-1!==e.indexOf("crossorigin")&&(t.download=!1);const s=/\bcompress\[([^\]]+)\]/g;let n;for(;n=s.exec(e);)(t.compress||(t.compress=[])).push({format:n[1].trim()})}return t}function _(e,t,s){if(f(e,"./")&&(e=e.substring(2)),-1===e.indexOf("/"))return[void 0,"",e];let n;if("/"===e[0])n="__serverroot__",e=e.substring(1);else if(f(e,"../")){n="__serverroot__";const t=location.pathname.split("/");if(--t.length)for(let s=0,n=e.length;s<n&&("../"===e.substring(s,s+3)&&0!=--t.length);s+=3);e=(t.shift()?t.join("/")+"/":"")+e.split("../").pop()}const o=u(e,"/",!1,!0);return t&&(o[1]=D(o[1],s)),[n,...o]}function I(e,t){const s=l(e instanceof HTMLObjectElement?e.data:e.src);s&&t.set(e,s)}function O(e){for(const t in e){const s=e[t],n=s.length;if(n>1){const e=[],t=++U;for(let o=0;o<n;++o){const n=s[o];n.bundleId=t,n.bundleIndex=o,o>0&&delete n.cloudStorage,e&&n.uri&&e.push(new URL(n.uri))}e:if(e.length===n){const t=e[0].origin;let o=e[0].pathname.split("/");for(let s=1;s<n;++s){const n=e[s];if(n.origin!==t)break e;if(o.length){const e=n.pathname.split("/");for(let t=0;t<e.length;++t)if(o[t]!==e[t]){o=o.slice(0,t);break}}}s[0].bundleRoot=t+o.join("/")+"/"}}}}function C(e,t,s,n,o,i,r,c){const l=t.innerHTML;if(l.trim()){const[u,d,m]=_(s),p={uri:B(),pathname:d,filename:m,moveTo:u,content:l,mimeType:n,format:o,preserve:i,document:c};r&&(p.inlineContent=H(t));const f=a(e);if(!f||!K(f,p,!0))return F(e,p),p;(f.trailingContent||(f.trailingContent=[])).push(l),j(e,{exclude:!0},t,c)}return null}function k(e,t){const s=(t.moveTo||"")+t.pathname+t.filename;s&&(e[s]||(e[s]=[])).push(t)}function M(e,t){for(const s of e)if(K(s,t,!0)){if(s.mimeType===t.mimeType)return!1;F(e,t);break}return!0}function F(e,t){const s=t.filename;let n=0;for(;e.find((e=>K(e,t)));){const[e,s]=u(t.filename,".");t.filename=e+"_"+ ++n+(s?"."+s:"")}n>0&&w.set(t,s)}function j(e,t,s,n){return t.exclude?(e.push({pathname:"",filename:"",exclude:!0,element:s,document:n}),!0):!!t.ignore}function R(e,t,s){const n=L(e,t,s||e&&D(e));return n?[n,!1]:t&&"~"!==t?[t,!0]:["",!1]}function L(e,t,s){if("~"===t&&(t=""),e&&!t&&s)try{const n=new URL(e);if(location.origin!==n.origin||!f(n.pathname,t=m(location.pathname,"/",!1,!0)))return"";{const e=n.pathname.substring(t.length+1);if(-1===e.indexOf("/"))return s;t=m(e,"/",!1,!0)}}catch(e){}return t&&s&&v(t,s)}function N(e,t,s,n){var o,i;const r=(o=t.dataset)[i=s+"Id"]||(o[i]=y(n));(e.id||(e.id={}))[s]=r}function q(e){return{pathname:"",filename:"",mimeType:e,format:"crossorigin"}}const D=(e,t)=>"__assign__."+(t||e&&z(e)||"unknown"),P=(e,t)=>"boolean"==typeof e?!e:!!t,H=e=>e instanceof HTMLLinkElement?"style":e.tagName.toLowerCase(),V=(e,t,s)=>Object.assign(Object.assign({},e),{attributes:t,append:s}),W=(e,t)=>e&&e.get(t),$=(e,t,s="")=>e.type.trim().toLowerCase()||t&&A(t)||s,z=e=>d(e,".",!0,!0).toLowerCase(),B=()=>location.origin+location.pathname,K=(e,t,s)=>e.pathname===t.pathname&&(e.filename===t.filename||w.get(e)===t.filename||s&&f(e.filename,"__assign__"))&&(e.moveTo||"")===(t.moveTo||"");class File extends squared.base.File{static createTagNode(e,t,s){const n=e.tagName.toLowerCase(),o=s[n]||(s[n]=document.querySelectorAll(n)),i=o.length;let r=-1,a=-1;for(let s=0,n=t.length;s<n;++s)t[s]===e&&(r=s);for(let t=0;t<i;++t)if(o[t]===e){a=t;break}return{index:r,tagName:n,tagIndex:a,tagCount:i,ignoreCase:!0}}static setDocumentId(e,t,s,n){Array.isArray(s)?s.forEach((s=>N(e,t,s,n))):s&&N(e,t,s,n)}static parseUri(e,t,s){let o,i,r,d,p;s&&({saveAs:o,mimeType:i,format:r,saveTo:d,fromConfig:p}=s),i||(i=A(e));let h=x(e,"/"),g;const v=f(h,location.origin);if(!v&&t)return q(i);if(o){if(o=x(c(o,"\\","/"),"/"),d||p)g=o;else{const e=T("saveAs",o);e?({file:g,format:r}=e):g=o}"~"===g&&(g=""),v&&g&&(h=l(g))}try{const{host:t,port:s,pathname:o}=new URL(h),[c,l]=u(o,"/",!1,!0);let p="",b="",A;if(g?[A,p,b]=_(g,d,z(e)):v||(p=n(t)+(s?"/"+s.substring(1):"")+c),e!==location.href){if(v&&!p){let e=location.pathname;"/"!==a(e)&&(e=m(e,"/",!1,!0)),f(c,e)?p=c.substring(e.length+1):(A="__serverroot__",p="/"===c[0]?c.substring(1):c)}b||(b=l)}return{uri:e,moveTo:A,pathname:decodeURIComponent(p),filename:decodeURIComponent(b),mimeType:i,format:r}}catch(e){}return null}copyTo(e,t){return this.copying(e,this.processAssets(t))}appendTo(e,t){return this.archiving(e,this.processAssets(t))}saveAs(e,t){return e&&(t.filename=e),this.archiving("",this.processAssets(t))}getHtmlPage(e){var t;const s=document.documentElement;let n=s.dataset.chromeFile,o,i;if("ignore"===n)return[];e&&(o=e.assetMap,i=null===(t=e.saveAs)||void 0===t?void 0:t.html);const r=W(o,s)||i;let a,c,l,u,d,m,p,f;if(r){if(r.ignore||r.exclude)return[];({filename:a,compress:l,process:u,tasks:d,attributes:m,cloudStorage:p,document:f}=r)}else{const{chromeOptions:e,chromeTasks:t}=s.dataset;l=E(e).compress,d=h(t)}a&&(n=""),u&&(c=u.join("+"));const g=File.parseUri(location.href,!1,{saveAs:n,format:c,mimeType:"text/html"});if(this.processExtensions(g,f,l,d,p,m,s)){if(a)g.filename=a;else if(!g.filename){const e=location.pathname.split("/").pop();g.filename=/\.(?:html?|php|jsp|aspx?)$/i.exec(e)?e:"index.html"}return[g]}return[]}getScriptAssets(e){var t;let s,n,o;e&&(({assetMap:s,preserveCrossOrigin:n}=e),o=null===(t=e.saveAs)||void 0===t?void 0:t.script);const i=[],r={};let a;const c=(e,t,s,n)=>{var o;return((o=(a||(a={html:{},js:{},css:{}}))[e])[t]||(o[t]={}))[s]=n};if(s)for(const{template:e,type:t,selector:n}of s.values())if(e&&t&&!n)switch(t){case"html":case"js":case"css":{const{module:s,identifier:n}=e;let o=e.value;s&&n&&o&&(o=o.trim())&&-1!==o.indexOf("function")&&c(t,s,n,o);break}}return document.querySelectorAll("script").forEach((t=>{const a=t.dataset.chromeTemplate;if(a||"text/template"===t.type){const e=W(s,t);let n,o,r;if(e?(n=e.type,e.template&&({module:o,identifier:r}=e.template)):a&&([n,o,r]=a.split("::").map(((e,t)=>(0===t?e.toLowerCase():e).trim()))),n&&o&&r)switch(n){case"html":case"js":case"css":return c(n,o,r,t.textContent.trim()),void j(i,{exclude:!0},t)}e&&j(i,e,t)}else{const a=t.src;this.createBundle(e?e.sessionId:"",!0,i,t,a,$(t,a,"text/javascript"),"js",n,r,s,void 0,o)}})),O(r),[i,a]}getLinkAssets(e){var t,s;let n,i,r,a;e&&(({resourceId:n,assetMap:i,preserveCrossOrigin:r}=e),a=null===(t=e.saveAs)||void 0===t?void 0:t.link);const c=[],u={};document.querySelectorAll("link, style").forEach((t=>{let s="",n="text/css";if(t instanceof HTMLLinkElement){const e=t.rel.trim().toLowerCase();if(s=t.href,"stylesheet"!==e){const r=()=>{const e=o(s,"/");return-1!==e.indexOf(".")&&(n=$(t,e),!0)};if(W(i,t))r();else if(!s||-1===e.indexOf("icon")||!r())return}}this.createBundle(e?e.sessionId:"","text/css"===n,c,t,s,n,"css",r,u,i,void 0,a)}));const d=null===(s=this.getResourceAssets(n))||void 0===s?void 0:s.rawData;if(d)for(const[e,t]of d)if("text/css"===t.mimeType){let t=a,s,n,o,i,u,d,m,p,f;t&&(t.customize&&(n=t.customize.call(null,e,"text/css",t=Object.assign({},t)),t.pathname&&n&&(s=v(t.pathname,n))),({compress:o,download:i,preserve:u,process:d,tasks:m,cloudStorage:p,document:f}=t));const h=File.parseUri(l(e),P(i,r),{saveAs:s,mimeType:"text/css",format:d?d.join("+"):""});this.processExtensions(h,f,o,m,p)&&(n&&(h.filename=n),u&&(h.preserve=!0),c.push(h))}return O(u),c}getImageAssets(s){var n;let o,i,r,a;s&&(({resourceId:o,assetMap:i,preserveCrossOrigin:r}=s),a=null===(n=s.saveAs)||void 0===n?void 0:n.image);const c=[];document.querySelectorAll("img, input[type=image], picture > source[src], video[poster]").forEach((t=>{let s=t instanceof HTMLVideoElement?t.poster:t.src,n,o;const u=e.parseDataURI(s);if(u){if(!(o=u.base64))return;s=D("",(n=u.mimeType)&&b(n))}this.processImageUri(c,t,l(s),a,r,i,n,o)})),document.querySelectorAll("img[srcset], picture > source[srcset]").forEach((e=>{p(e.srcset,(s=>{const n=t.SRCSET.exec(s);if(n){const t=l(n[1]);t!==l(e.src)&&this.processImageUri(c,e,t,a,r,i,void 0,void 0,!0)}}))}));const u=this.getResourceAssets(o);if(u){for(const t of u.image.keys()){const s=e.parseDataURI(t);s?s.base64&&this.resource.addRawData(o,t,s):this.processImageUri(c,null,t,a,r)}if(u.rawData)for(const e of u.rawData.values()){const{base64:t,content:s,mimeType:n=A(e.filename)}=e;if(t){if(null==a?void 0:a.blob){let s=a,o,i;s.customize&&(o=s.customize.call(null,"",n,s=Object.assign({},s)));const r=s.pathname;if(o||(o=e.filename),f(n,"image/")&&(i=s.commands))for(let e=0;e<i.length;++e){const t=/^(?:^|\s+)(?:(png|jpeg|webp|bmp)\s*[@%]?)(.*)$/.exec(i[e]);t?i[e]=t[1]+"@"+t[2].trim():i.splice(e--,1)}const u=this.processImageUri(c,null,l(r?v(r,o):o),s,!1,void 0,n||"image/unknown",t);u&&(i&&i.length?u.commands=i:delete u.commands,r||delete u.uri,this.processExtensions(u)&&c.push(u))}}else if(s&&n){const t={pathname:`__generated__/${n.split("/").pop()}`,filename:D(e.filename),content:s,mimeType:n};this.processExtensions(t)&&c.push(t)}}}return c}getVideoAssets(e){return this.getRawAssets("video",e)}getAudioAssets(e){return this.getRawAssets("audio",e)}getFontAssets(e){var t;let s,n,o;e&&(({resourceId:s,preserveCrossOrigin:n}=e),o=null===(t=e.saveAs)||void 0===t?void 0:t.font);const i=[],r=this.getResourceAssets(s);if(r)for(const e of r.fonts.values())for(const{srcUrl:t,srcBase64:s,mimeType:r}of e){let e=o,a=null,c,u,d,m;e&&(e.customize&&(u=e.customize.call(null,t||"",r,e=Object.assign({},e))),({pathname:c,inline:d,blob:m}=e)),t?(a=File.parseUri(t,!0!==d&&n))&&d&&(a.format="base64"):s&&m&&(u||(u=D("",b(r))),(a=File.parseUri(l(c?v(c,u):u)))&&(a.format="blob",a.base64=s)),this.processExtensions(a)&&i.push(a)}return i}finalizeRequestBody(e){var t,n;const o=e.productionRelease;let a;if(!o&&e.watch){const o={},c=new URL(this.hostname).hostname,l=this.application.userSettings;for(const{watch:s}of e.assets)if(i(s)&&s.reload){const e=s.reload,{socketId:i,secure:a,handler:u={}}=e;let d=null!==(t=e.port)&&void 0!==t?t:a?l.webSocketSecurePort:l.webSocketPort;i&&r(d)&&!isNaN(d=+d)&&(o[n=i+`_${d}_`+(a?"0":"1")]||(o[n]=`socket=new WebSocket("${a?"wss":"ws"}://${c}:${d}");`+(u.open?`socket.onopen=${u.open};`:"")+"socket.onmessage="+(u.message||`function(e){var c=JSON.parse(e.data);if(c&&c.socketId==="${i}"&&c.module==="watch"&&c.action==="modified"){if(!c.errors||!c.errors.length){if(c.hot){if(c.type==="text/css"){var a=document.querySelectorAll('link[href^="'+c.src+'"]');if(a.length){a.forEach(function(b){b.href=c.src+c.hot;});return;}}else if(c.type.startsWith("image/")){var a=document.querySelectorAll('img[src^="'+c.src+'"]');if(a.length){a.forEach(function(b){b.src=c.src+c.hot;});return;}}}window.location.reload();}else{console.log("FAIL: "+c.errors.length+" errors\\n\\n"+c.errors.join("\\n"));}}}`)+";"+(u.error?`socket.onerror=${u.error};`:"")+(u.close?`socket.onclose=${u.close};`:""))),delete e.handler}if(Object.keys(o).length){let t='document.addEventListener("DOMContentLoaded", function(){var socket;';for(const e in o)t+=o[e];if(t+="});",e.useOriginalHtmlPage){const s=e.assets.find((e=>"@text/html"===e.mimeType));s&&(s.element.textContent=`<script>${t}<\/script>`)}else a=s("script",{parent:document.body,attributes:{textContent:t}})}}if(!e.useOriginalHtmlPage){let t;for(const s of e.assets){const e=s.element;if(e){switch(e.tagName){case"html":e.innerXml=document.documentElement.innerHTML;break;case"script":a&&++e.tagCount}a&&(t=e.append)&&"script"===t.tagName&&++t.tagCount}o&&s.watch&&delete s.watch}if(a&&document.body.removeChild(a),e.document)for(const t of e.document){const e=t+"Id";document.querySelectorAll(`[data-${t}-id]`).forEach((t=>delete t.dataset[e]))}e.removeInlineStyles&&document.querySelectorAll("[style]").forEach((e=>e.removeAttribute("style")))}}getCopyQueryParameters(e){return e.watch&&!e.productionRelease?"&watch=1":""}getRawAssets(e,t){var s;let n,o,i;t&&(({assetMap:n,preserveCrossOrigin:o}=t),i=null===(s=t.saveAs)||void 0===s?void 0:s.image);const r=[];return document.querySelectorAll(e).forEach((e=>{const t=new Map;switch(e.tagName.toUpperCase()){case"VIDEO":case"AUDIO":e.querySelectorAll("source, track").forEach((e=>I(e,t)));break;case"IFRAME":if(!W(n,e)&&!f(e.dataset.chromeFile,"saveTo"))return;case"OBJECT":case"EMBED":{const t=e instanceof HTMLObjectElement?e.data:e.src,s=e.type||A(t);if(f(s,"image/"))return void this.processImageUri(r,e,t,i,o,n,s);break}}I(e,t);for(const[e,s]of t){const t=e.dataset.chromeFile;if("ignore"===t)continue;const i=W(n,e);let a,c,l,u,d,m,p,f,v,b,A;if(i){if(({filename:l,compress:u,download:d,tasks:m,watch:p,attributes:f,cloudStorage:v,document:b}=i),j(r,i,e,b))continue;[a,c]=R(s,i.saveTo||i.pathname,l||S(s)),a&&(l=""),A=!0}else{const s=T("saveAs",t);s&&(a=s.file);const{chromeOptions:n,chromeTasks:o,chromeWatch:i}=e.dataset;({compress:u,download:d}=E(n)),m=h(o),p=g(i)}const y=File.parseUri(s,P(d,o),{saveAs:a,saveTo:c,fromConfig:A});this.processExtensions(y,b,u,m,v,f,e,p)&&(l&&(y.filename=l),r.push(y))}})),r}processAssets(e){var t;const{sessionId:s,assetMap:n,appendMap:o,nodeMap:i=new Map,useOriginalHtmlPage:r,preserveCrossOrigin:a}=e,c=this.application.getUserSetting(s,"formatUUID"),l=document.querySelectorAll("*"),u={},m=this.getHtmlPage(e).concat(this.getLinkAssets(e));if(e.saveAsWebPage)for(const e of m)switch(e.mimeType){case"text/html":case"text/css":e.mimeType="@"+e.mimeType}const[p,h]=this.getScriptAssets(e);if(m.push(...p,...this.getImageAssets(e),...this.getVideoAssets(e),...this.getAudioAssets(e),...this.getRawAssets("object",e),...this.getRawAssets("embed",e),...this.getRawAssets("iframe",e),...this.getFontAssets(e)),o){const e={},i=(t,s,n,o)=>(t in e||(e[t]=document.querySelectorAll(t).length),{tagName:t,tagCount:e[t],order:s,textContent:n,prepend:o});for(const[e,p]of o){const o=File.createTagNode(e,l,u),h=null===(t=W(n,e))||void 0===t?void 0:t.document,g=()=>o.index+e.querySelectorAll("*").length+1;r||File.setDocumentId(o,e,h,c),o.outerXml=e.outerHTML.trim();let v=0;for(const t of p){const{type:n,attributes:r,download:c,textContent:l}=t;if(n){let u,p,b;switch(n){case"prepend/js":b=!0;case"append/js":r&&(p=r.src,r.type||(r.type="text/javascript"),u=!0);break;case"prepend/css":b=!0;case"append/css":r&&(p=r.href,r.type||(r.type="text/css"));break;default:{let e;if("replace"===n)l&&(e=V(o,r),e.textContent=l);else{const t=i(d(n,"/",!0,!0).toLowerCase(),++v,l);f(n,"append/")?(t.nextSibling=g(),e=V(o,r,t)):f(n,"prepend/")&&(t.prepend=!0,e=V(o,r,t))}e&&m.push({pathname:"",filename:"",document:h,element:e});continue}}if(p&&r){t.document||(t.document=h),delete t.download;const n=this.createBundle(s,!1,m,e,p,r.type,"",void 0,void 0,void 0,t);if(n){P(c,a)&&delete n.uri;const e=i(u?"script":"link",++v,void 0,b);b||(e.nextSibling=g()),n.element=V(o,r,e)}}}}}}const g=this.application.getUserSetting(s,"outputDocumentHandler");for(const e of m){const t=e.element;if(t instanceof Element){const s=File.createTagNode(t,l,u);r||File.setDocumentId(s,t,e.document,c),e.element=s,i.set(s,t)}e.document||(e.document=File.copyDocument(g))}for(const[e,t]of i)t!==document.documentElement&&(e.outerXml=t.outerHTML.trim());return e.assets&&m.push(...e.assets),e.assets=m,e.baseUrl=B(),h&&(e.templateMap=h),delete e.saveAs,delete e.assetMap,delete e.indexMap,delete e.nodeMap,delete e.appendMap,delete e.sessionId,delete e.resourceId,e}createBundle(e,t,s,n,o,i,r,a,c,u,d,m){let p=d?"":n.dataset.chromeFile;if("exclude"===p||"ignore"===p)return;const f=W(u,n)||d;let v,b,A,S,x,w,U,_,I,O,F,N,D,V;if(f){if(({inline:A,compress:x,download:w,preserve:U,process:S,tasks:_,watch:I,attributes:O,cloudStorage:F,document:N}=f),j(s,f,n,N))return;p=o?f.saveAs:f.exportAs,p||!f.filename||f.pathname&&(p=R(o,f.pathname,f.filename)[0])||(v=f.filename),D=!0}else{if(t&&m){if(m.customize&&(v=m.customize.call(null,o||"",i,m=Object.assign({},m))),({preserve:U,inline:A,compress:x,download:w,process:S,tasks:_,watch:I,attributes:O,cloudStorage:F,document:N}=m),j(s,m,n,N))return;m.filename||(m.filename=v||y(this.application.getUserSetting(e,"formatUUID"))+"."+r),v||(v=m.filename),o?(p=L(o,m.pathname,v))&&(v=""):(p="./"+v,v="",V=!0)}const{chromeOptions:a,chromeTasks:c,chromeWatch:l}=n.dataset,u=E(a);null!=A||(A=u.inline),null!=U||(U=u.preserve),x||(x=u.compress),null!=w||(w=u.download),_||(_=h(c)),I||(I=g(l))}S&&(b=S.join("+"));let $=null;if(o){if(($=File.parseUri(l(o),P(w,a)||d&&U,{saveAs:p,mimeType:i,format:b,fromConfig:D}))&&"crossorigin"!==$.format)if(d){if(A)switch(d.type){case"append/js":$.inlineContent="script";break;case"append/css":$.inlineContent="style"}}else A&&($.inlineContent=H(n)),t&&M(s,$)&&($.bundleIndex=-1)}else if(p&&t){if(!D&&!V){const e=T("exportAs",p);e&&({file:p,format:b}=e)}($=C(s,n,p,i,b,U,A,N))&&($.bundleIndex=-1)}else n instanceof HTMLScriptElement||($=q(i));return this.processExtensions($,N,x,_,F,O,d?void 0:n,I)?(v&&($.filename=v),U&&($.preserve=!0),c&&k(c,$),s.push($),$):void 0}processImageUri(e,t,s,n,o,i,r,a,c){if(s){let l,u,d,m,p,f,v,b,A,y,x,w,U,_,I,O;const C=e=>{e.customize&&(p=e.customize.call(null,s,r||"",l=Object.assign({},e)))};if(t){const o=t.dataset.chromeFile;if("ignore"===o)return;if(l=W(i,t)){if(({pathname:m,filename:p,inline:v,compress:b,download:A,blob:y,commands:f,tasks:x,watch:w,attributes:U,cloudStorage:_,document:I}=l),j(e,l,t,I))return;[u,d]=R(s,l.saveTo||m,p||S(s)),u&&(p=""),O=!0}else{if(n){if(C(l=n),({pathname:m,inline:v,compress:b,download:A,blob:y,commands:f,tasks:x,watch:w,attributes:U,cloudStorage:_,document:I}=l),j(e,n,t,I))return;[u,d]=R(s,m,p||S(s))}if(o&&!m){let e=T("saveTo",o);e?[u,d]=R(s,e.file,p||S(s)):(e=T("saveAs",o))&&(u=e.file)}const{chromeCommands:i,chromeOptions:r,chromeTasks:a,chromeWatch:c}=t.dataset;i&&(f||(f=i.split("::").map((e=>e.trim()))));const O=E(r);null!=v||(v=O.inline),b||(b=O.compress),null!=A||(A=O.download),null!=y||(y=O.blob),x||(x=h(a)),w||(w=g(c))}}else n&&(C(l=n),({pathname:m,inline:v,compress:b,download:A,blob:y,commands:f,tasks:x,cloudStorage:_}=l),[u,d]=R(s,m,p||S(s)));if(a&&!y)return;!f||0!==f.length&&"~"!==f[0]||(f=void 0);const k=File.parseUri(s,P(A,o),{saveAs:u,saveTo:d,mimeType:r,fromConfig:O});if(this.processExtensions(k,I,b,x,_,U,t,w,!!f)){if(p&&(k.filename=p),a){if(!O&&e.find((e=>e.base64===a)))return;k.format="blob",k.base64=a}else if(c)k.format="srcset";else if(v)k.format="base64";else if(!t&&e.find((e=>e.moveTo===k.moveTo&&e.pathname===k.pathname&&e.filename===k.filename&&-1===k.filename.indexOf("__assign__"))))return;return f&&(k.commands=f),e.push(k),k}}}getResourceAssets(t){if(void 0!==t&&-1!==t)return e.ASSETS[t]}processExtensions(e,t,s,n,o,i,r,a,c){if(e){s&&(e.compress=s,c=!0),n&&(e.tasks=n,c=!0),i&&(e.attributes=i,c=!0),o&&(e.cloudStorage=o,c=!0),a&&(e.watch=a,c=!0),r&&(e.element=r),t&&(e.document=t);for(const t of this.application.extensions)if(!t.processFile(e))return!1;return c||"crossorigin"!==e.format}return!1}get application(){return this.resource.application}get userSettings(){return this.resource.application.userSettings}}const{STRING:J}=squared.base.lib.regex,{UNABLE_TO_FINALIZE_DOCUMENT:X,reject:Q}=squared.lib.error,{escapePattern:G,isPlainObject:Y,splitSome:Z}=squared.lib.util,{trimBoth:ee}=squared.base.lib.util,te=new RegExp(J.CSS_VARVALUE+"|"+J.CSS_VARNAME,"g"),se=new RegExp(J.CSS_VARNAME,"g"),ne=new RegExp(J.CSS_VARVALUE,"g");class Application extends squared.base.Application{constructor(){super(...arguments),this.extensions=[],this.systemName="chrome",this._cssVariables={},this._cssUsedVariables={},this._cssUsedFontFace={},this._cssUsedKeyframes={},this._cssUnusedSelectors={},this._cssUnusedMedia={},this._cssUnusedSupports={}}init(){this.session.usedSelector=function(e,t){var s,n,o,i,r;const{fontFamily:a,animationName:c}=t.style;let l,u,d,m,p;for(;p=te.exec(t.cssText);)p[3]&&(u||(u=(s=this._cssUsedVariables)[e]||(s[e]=new Set)),u.add(p[3]));for(;p=ne.exec(t.cssText);)l||(l=(n=this._cssVariables)[e]||(n[e]={})),(l[o=p[1]]||(l[o]=new Set)).add(p[2].trim());a&&(d||(d=(i=this._cssUsedFontFace)[e]||(i[e]=new Set)),Z(a,(e=>{d.add(ee(e))}))),c&&(m||(m=(r=this._cssUsedKeyframes)[e]||(r[e]=new Set)),Z(c,(e=>{m.add(e)}))),te.lastIndex=0,ne.lastIndex=0},this.session.unusedSelector=function(e,t,s,n){var o;n||((o=this._cssUnusedSelectors)[e]||(o[e]=new Set)).add(s)},this.session.unusedMedia=function(e,t,s,n){var o;n||((o=this._cssUnusedMedia)[e]||(o[e]=new Set)).add(s)},this.session.unusedSupports=function(e,t,s,n){var o;n||((o=this._cssUnusedSupports)[e]||(o[e]=new Set)).add(s)},super.init()}reset(){this._cssVariables={},this._cssUsedVariables={},this._cssUsedFontFace={},this._cssUsedKeyframes={},this._cssUnusedSelectors={},this._cssUnusedMedia={},this._cssUnusedSupports={},super.reset()}insertNode(e,t){if("#"===t.nodeName[0]){if(this.getUserSetting(e,"excludePlainText"))return;this.controllerHandler.applyDefaultStyles(e,t)}return this.createNodeStatic(e,t)}saveAs(e,t){return this.processAssets("saveAs",e,t)}copyTo(e,t){return this.processAssets("copyTo",e,t)}appendTo(e,t){return this.processAssets("appendTo",e,t)}async processAssets(e,t,s){var n;const o=await this.parseDocument();if(!o)return Q(X);const i=o.sessionId,r=this.getProcessing(i),a=r.resourceId,c=[],l=new Map,u=new Map,d=new Map,m=(s=Object.assign(Object.assign({},s),{saveAsWebPage:!0,sessionId:i,resourceId:a,assetMap:l,nodeMap:u,appendMap:d})).retainUsedStyles,p=m?m.filter((e=>"string"==typeof e)):[];if(s.removeUnusedVariables){const e=this._cssVariables[i];let t=Array.from(this._cssUsedVariables[i]||[]).concat(p.filter((e=>e.startsWith("--"))));if(e){const s=new Set;for(const n of t)!function t(n){if(n){const o=new RegExp(se);let i;for(const r of n){for(;i=o.exec(r);)s.add(i[1]),t(e[i[1]]);o.lastIndex=0}}}(e[n]);s.size&&(t.forEach((e=>s.add(e))),t=Array.from(s))}s.usedVariables=t,delete s.removeUnusedVariables}if(s.removeUnusedFontFace&&(s.usedFontFace=Array.from(this._cssUsedFontFace[i]||[]).concat(p.filter((e=>e.startsWith("|font-face:")&&e.endsWith("|"))).map((e=>ee(e,"|").substring(10).trim()))),delete s.removeUnusedFontFace),s.removeUnusedKeyframes&&(s.usedKeyframes=Array.from(this._cssUsedKeyframes[i]||[]).concat(p.filter((e=>e.startsWith("|keyframes:")&&e.endsWith("|"))).map((e=>ee(e,"|").substring(10).trim()))),delete s.removeUnusedKeyframes),s.removeUnusedMedia){const e=this._cssUnusedMedia[i];if(e){const t=[],n=p.filter((e=>e.startsWith("|media:")&&e.endsWith("|"))).map((e=>ee(e,"|").substring(6).trim()));for(const s of e)n.includes(s)||t.push(s);t.length&&(s.unusedMedia=t)}delete s.removeUnusedMedia}if(s.removeUnusedSupports){const e=this._cssUnusedSupports[i];if(e){const t=[],n=p.filter((e=>e.startsWith("|supports:")&&e.endsWith("|"))).map((e=>ee(e,"|").substring(9).trim()));for(const s of e)n.includes(s)||t.push(s);t.length&&(s.unusedSupports=t)}delete s.removeUnusedSupports}if(s.removeUnusedClasses||s.removeUnusedPseudoClasses){const e=this._cssUnusedSelectors[i];if(e){const t=[];for(const n of e)!(-1!==n.indexOf(":")?s.removeUnusedPseudoClasses:s.removeUnusedClasses)||m&&m.find((e=>"string"==typeof e?e===n:e.test(n)))||t.push(n);t.length&&(s.unusedStyles=t)}delete s.removeUnusedClasses,delete s.removeUnusedPseudoClasses}const f=null===(n=s.config)||void 0===n?void 0:n.uri;if(f){const e=await this.fileHandler.loadConfig(f,s);if(e){const t=this.getUserSetting(r,"outputDocumentHandler"),s=new Map,n=e=>{const t=typeof e;if(e&&("object"===t||"string"===t)){const n="object"===t?JSON.stringify(e):e;let o=n;for(const[e,t]of s.values())o=o.replace(e,((...e)=>{const s=e[1];return s?s+t.replace(new RegExp(`(?:^${s}|([^\\\\])${s})`,"g"),((...e)=>(e[1]||"")+"\\"+s))+s:t}));if(o!==n){if("object"!==t)return o;try{return JSON.parse(o)}catch(e){}}}return e};location.search&&new URLSearchParams(location.search).forEach(((e,t)=>s.set(t,[new RegExp(`(["'])?\\{\\{\\s*${G(t)}\\s*\\}\\}\\1`,"g"),e])));for(const o of e)if(o.selector){const e=o.type;let i=Y(o.dataSource)?o.dataSource:null,r=Y(o.cloudDatabase)?o.cloudDatabase:null;if(s.size)for(const e of[i,r])if(e)for(const t in e)"value"!==t&&(e[t]=n(e[t]));i&&(i=Object.assign(Object.assign({document:o.document||File.copyDocument(t)},i),{type:e})),r&&(r=Object.assign(Object.assign({document:o.document||File.copyDocument(t)},i),{type:e,source:"cloud"})),document.querySelectorAll(o.selector).forEach((t=>{switch(e){case"text":case"attribute":case"display":i?c.push([t,i]):r&&c.push([t,r]);break;default:if(e&&("replace"===e||e.startsWith("append/")||e.startsWith("prepend/"))){let e=d.get(t);e||d.set(t,e=[]),e.push(Object.assign({},o))}else l.set(t,Object.assign({},o))}}))}}}if(0===l.size&&delete s.assetMap,0===d.size&&delete s.appendMap,c.length){const e=s.useOriginalHtmlPage,t=this.getUserSetting(r,"formatUUID"),n=document.querySelectorAll("*"),o={},i=s.dataSource||(s.dataSource=[]);for(const[s,r]of c){const a=File.createTagNode(s,n,o);a.textContent=s.textContent,r.element=a,e||File.setDocumentId(a,s,r.document,t),u.set(a,s),i.push(r)}}return this.fileHandler[e](t,s)}get initializing(){return!1}get length(){return 1}}class Extension extends squared.base.Extension{processFile(e){return!0}}class Node extends squared.base.Node{}const oe={builtInExtensions:[],preloadImages:!1,preloadFonts:!1,preloadCustomElements:!1,excludePlainText:!0,createElementMap:!0,createQuerySelectorMap:!0,pierceShadowRoot:!0,showErrorMessages:!1,webSocketPort:80,webSocketSecurePort:443,formatUUID:"8-4-4-4-12",outputDocumentHandler:"chrome",outputEmptyCopyDirectory:!1,outputTasks:{},outputWatch:{},outputArchiveName:"chrome-data",outputArchiveFormat:"zip",outputArchiveCache:!1},{DIRECTORY_NOT_PROVIDED:ie,FRAMEWORK_NOT_INSTALLED:re,reject:ae}=squared.lib.error,{isString:ce,isPlainObject:le}=squared.lib.util;let ue=null,de=null;function me(e,t,s){return le(t)&&t.assets&&e.push(...t.assets),Object.assign(t={},{assets:e,filename:s})}const pe=(e,t)=>e||`${ue.userSettings.outputArchiveName}-${t}`,fe=undefined;return{base:{Application:Application,Extension:Extension,File:File,Node:Node},lib:{},extensions:{},system:{copyHtmlPage:(e,t)=>ce(e)?de?de.copying(e,me(de.getHtmlPage(t),t)):ae(re):ae(ie),copyScriptAssets:(e,t)=>ce(e)?de?de.copying(e,me(de.getScriptAssets(t)[0],t)):ae(re):ae(ie),copyLinkAssets:(e,t)=>ce(e)?de?de.copying(e,me(de.getLinkAssets(t),t)):ae(re):ae(ie),copyImageAssets:(e,t)=>ce(e)?de?de.copying(e,me(de.getImageAssets(t),t)):ae(re):ae(ie),copyVideoAssets:(e,t)=>ce(e)?de?de.copying(e,me(de.getVideoAssets(t),t)):ae(re):ae(ie),copyAudioAssets:(e,t)=>ce(e)?de?de.copying(e,me(de.getAudioAssets(t),t)):ae(re):ae(ie),copyFontAssets:(e,t)=>ce(e)?de?de.copying(e,me(de.getFontAssets(t),t)):ae(re):ae(ie),saveHtmlPage:(e,t)=>de?de.archiving("",me(de.getHtmlPage(t),t,pe(e,"html"))):ae(re),saveScriptAssets:(e,t)=>de?de.archiving("",me(de.getScriptAssets(t)[0],t,pe(e,"script"))):ae(re),saveLinkAssets:(e,t)=>de?de.archiving("",me(de.getLinkAssets(t),t,pe(e,"link"))):ae(re),saveImageAssets:(e,t)=>de?de.archiving("",me(de.getImageAssets(t),t,pe(e,"image"))):ae(re),saveVideoAssets:(e,t)=>de?de.archiving("",me(de.getVideoAssets(t),t,pe(e,"video"))):ae(re),saveAudioAssets:(e,t)=>de?de.archiving("",me(de.getAudioAssets(t),t,pe(e,"audio"))):ae(re),saveFontAssets:(e,t)=>de?de.archiving("",me(de.getFontAssets(t),t,pe(e,"font"))):ae(re)},create:()=>(ue=new Application(4,Node,squared.base.Controller,squared.base.ExtensionManager,squared.base.Resource),de=new File(ue.resourceHandler),{application:ue,framework:4,userSettings:Object.assign({},oe)}),cached(){return ue?{application:ue,framework:4,userSettings:ue.userSettings}:this.create()}}}();
