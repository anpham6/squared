var chrome=function(){"use strict";var e=squared.base.Resource,t=squared.lib.base.Pattern;const{createElement:s}=squared.lib.dom,{convertWord:n,endsWith:o,fromLastIndexOf:i,hasValue:r,isPlainObject:a,resolvePath:c,splitPair:l,splitPairEnd:u,splitPairStart:m,startsWith:p,trimEnd:d}=squared.lib.util,{appendSeparator:f,fromMimeType:h,parseMimeType:g,parseTask:v,parseWatchInterval:b,randomUUID:A}=squared.base.lib.util,y=new t(/([^\s,]+)(\s+[\d.]+\s*[wx])?\s*,?/gi),w=new WeakMap;let S=0;function x(e,t){if(t){const s=new RegExp(`^(?:^|\\s+)${e}\\s*:(.+)$`).exec(t);if(s){const e=s[1].split("::").map((e=>e.trim()));return{file:V(e[0]),format:e[1]}}}}function T(e){if(e){const t=/\bcompress\[([^\]]+)\]/g;let s,n;for(;n=t.exec(e);)(s||(s=[])).push({format:n[1].trim()});return{inline:e.includes("inline"),compress:s,download:!e.includes("crossorigin")&&void 0,preserve:e.includes("preserve"),blob:e.includes("blob")}}return{}}function k(e,t,s){if(p(e,"./")&&(e=e.substring(2)),!e.includes("/"))return["","",e];let n;if("/"===e[0])n="__serverroot__",e=e.substring(1);else if(p(e,"../")){n="__serverroot__";let t=location.pathname.split("/");if(--t.length)for(let s=0,n=e.length;s<n&&("../"===e.substring(s,s+3)&&0!=--t.length);s+=3);t.shift(),t=t.join("/"),e=(t?t+"/":"")+e.split("../").pop()}const o=l(e,"/",!1,!0);return t&&(o[1]=q(o[1],s)),[n,o[0],o[1]]}function E(e,t){const s=c(e instanceof HTMLObjectElement?e.data:e.src);s&&t.set(e,s)}function C(e){for(const t in e){const s=e[t],n=s.length;if(n>1){const e=[],t=++S;for(let o=0;o<n;++o){const n=s[o];n.bundleId=t,n.bundleIndex=o,o>0&&delete n.cloudStorage,e&&n.uri&&e.push(new URL(n.uri))}e:if(e.length===n){const t=e[0].origin,o=e[0].pathname.split("/");for(let s=1;s<n;++s){const n=e[s];if(n.origin!==t)break e;if(o.length){const e=n.pathname.split("/");for(let t=0;t<e.length;++t)if(o[t]!==e[t]){o.splice(t,1/0);break}}}s[0].bundleRoot=t+o.join("/")+"/"}}}}function O(e,t,s,n,o,i,r,a){const c=t.innerHTML;if(c.trim()){const[l,u,m]=k(s),p={uri:location.href,pathname:u,filename:m,moveTo:l,content:c,mimeType:n,format:o,preserve:i,document:a};r&&(p.inlineContent=P(t));const d=e[e.length-1];if(!d||!W(d,p,!0))return j(e,p),p;(d.trailingContent||(d.trailingContent=[])).push(c),F(e,{exclude:!0},t,a)}return null}function I(e,t){const s=(t.moveTo||"")+t.pathname+t.filename;s&&(e[s]||(e[s]=[])).push(t)}function M(e,t){for(let s=0,n=e.length;s<n;++s)if(W(e[s],t)){for(let o=s+1;o<n;++o)if(!W(e[o],t))return j(e,t),!0;return!1}return j(e,t),!0}function j(e,t){const s=t.filename;let n=0;for(;e.find((e=>W(e,t)));){const[e,s]=l(t.filename,".");t.filename=e+"_"+ ++n+(s?"."+s:"")}n>0&&w.set(t,s)}function F(e,t,s,n){return t.exclude?(e.push({pathname:"",filename:"",exclude:!0,element:s,document:n}),!0):!!t.ignore}function L(e,t,s){const n=U(e,t,s||e&&q(e));return n?[n,!1]:t&&"~"!==t?[t,!0]:["",!1]}function U(e,t,s){if("~"===t&&(t=""),e&&!t&&s)try{const s=new URL(e);if(location.origin!==s.origin||!s.pathname.startsWith(t=m(location.pathname,"/",!1,!0)))return"";t=m(s.pathname.substring(t.length+1),"/",!1,!0)}catch(e){}return t&&s&&f(t,s)}function _(e,t,s){var n,o;const i=(n=t.dataset)[o=s+"Id"]||(n[o]=A());(e.id||(e.id={}))[s]=i}function R(e){return{pathname:"",filename:"",mimeType:e,format:"crossorigin"}}const q=(e,t)=>"__assign__."+(t||e&&z(e)||"unknown"),N=(e,t)=>"boolean"==typeof e?!e:!!t,P=e=>e instanceof HTMLLinkElement?"style":e.tagName.toLowerCase(),D=(e,t,s)=>Object.assign(Object.assign({},e),{attributes:t,append:s}),H=e=>e.split("?")[0].split("/").pop(),W=(e,t,s)=>e.pathname===t.pathname&&(e.filename===t.filename||w.get(e)===t.filename||s&&p(e.filename,"__assign__"))&&(e.moveTo||"")===(t.moveTo||""),$=(e,t,s="")=>e.type.trim().toLowerCase()||t&&g(t)||s,z=e=>u(e,".",!0,!0).toLowerCase(),V=e=>e.replace(/\\+/g,"/");class File extends squared.base.File{static createTagNode(e,t,s){const n=e.tagName.toLowerCase(),o=s[n]||(s[n]=document.querySelectorAll(n)),i=o.length;let r=-1,a=-1;for(let s=0,n=t.length;s<n;++s)t[s]===e&&(r=s);for(let t=0;t<i;++t)if(o[t]===e){a=t;break}return{index:r,tagName:n,tagIndex:a,tagCount:i,ignoreCase:!0}}static setDocumentId(e,t,s){if(Array.isArray(s))for(const n of s)_(e,t,n);else s&&_(e,t,s)}static parseUri(e,t,s){let o,i,r,a,u;s&&({saveAs:o,mimeType:i,format:r,saveTo:a,fromConfig:u}=s),i||(i=g(e));let f=d(e,"/"),h;const v=p(f,location.origin);if(!v&&t)return R(i);if(o){if(o=d(V(o),"/"),a||u)h=o;else{const e=x("saveAs",o);e?({file:h,format:r}=e):h=o}"~"===h&&(h=""),v&&h&&(f=c(h))}try{const{host:t,port:s,pathname:o}=new URL(f),[c,u]=l(o,"/",!1,!0);let p="",d="",g;if(h?[g,p,d]=k(h,a,z(e)):v||(p=n(t)+(s?"/"+s.substring(1):"")+c),e!==location.href){if(v&&!p){let e=location.pathname;e.endsWith("/")||(e=m(e,"/",!1,!0)),c.startsWith(e)?p=c.substring(e.length+1):(g="__serverroot__",p=c)}d||(d=u)}return{uri:e,moveTo:g,pathname:decodeURIComponent(p),filename:decodeURIComponent(d),mimeType:i,format:r}}catch(e){}return null}copyTo(e,t){return this.copying(e,this.processAssets(t))}appendTo(e,t){return this.archiving(e,this.processAssets(t))}saveAs(e,t){return e&&(t.filename=e),this.archiving("",this.processAssets(t))}getHtmlPage(e){var t;const s=document.documentElement;let n=s.dataset.chromeFile,o,i;if("ignore"===n)return[];e&&(o=e.assetMap,i=null===(t=e.saveAs)||void 0===t?void 0:t.html);const r=(null==o?void 0:o.get(s))||i;let a,c,l,u,m,p,d,f;if(r){if(r.ignore||r.exclude)return[];({filename:a,compress:l,process:u,tasks:m,attributes:p,cloudStorage:d,document:f}=r)}else{const{chromeOptions:e,chromeTasks:t}=s.dataset;l=T(e).compress,m=v(t)}a&&(n=""),u&&(c=u.join("+"));const h=File.parseUri(location.href,!1,{saveAs:n,format:c,mimeType:"text/html"});if(this.processExtensions(h,f,l,m,d,p,s)){if(a)h.filename=a;else if(!h.filename){const e=H(location.href);h.filename=/\.(?:html?|php|jsp|aspx?)$/i.exec(e)?e:"index.html"}return[h]}return[]}getScriptAssets(e){var t;let s,n,o;e&&(({assetMap:s,preserveCrossOrigin:n}=e),o=null===(t=e.saveAs)||void 0===t?void 0:t.script);const i=[],r={};let a;const c=(e,t,s,n)=>{var o;return((o=(a||(a={html:{},js:{},css:{}}))[e])[t]||(o[t]={}))[s]=n};if(s)for(const{selector:e,type:t,template:n}of s.values())if(n&&t&&!e)switch(t){case"html":case"js":case"css":{const{module:e,identifier:s}=n;let o=n.value;e&&s&&o&&(o=o.trim())&&o.includes("function")&&c(t,e,s,o);break}}return document.querySelectorAll("script").forEach((e=>{const t=e.dataset.chromeTemplate;if(t||"text/template"===e.type){const n=null==s?void 0:s.get(e);let o,r,a;if(n?(o=n.type,n.template&&({module:r,identifier:a}=n.template)):t&&([o,r,a]=t.split("::").map(((e,t)=>(0===t?e.toLowerCase():e).trim()))),o&&r&&a)switch(o){case"html":case"js":case"css":return c(o,r,a,e.textContent.trim()),void F(i,{exclude:!0},e)}n&&F(i,n,e)}else{const t=e.src;this.createBundle(i,e,t,$(e,t,"text/javascript"),n,r,s,void 0,o)}})),C(r),[i,a]}getLinkAssets(e){var t;let s,n,o,r;e&&(({resourceId:s,assetMap:n,preserveCrossOrigin:o}=e),r=null===(t=e.saveAs)||void 0===t?void 0:t.link);const a=[],l={};document.querySelectorAll("link, style").forEach((e=>{let t="",s="text/css";if(e instanceof HTMLLinkElement){const o=e.rel.trim().toLowerCase();if(t=e.href,"stylesheet"!==o){const r=()=>{const n=i(t,"/");return!!n.includes(".")&&(s=$(e,n),!0)};if(n&&n.get(e))r();else if(!t||!o.includes("icon")||!r())return}}this.createBundle(a,e,t,s,o,l,n,void 0,r,"text/css"===s)}));const u=this.getResourceAssets(s);if(u)for(const[e,t]of u.rawData)if("text/css"===t.mimeType){let s,n,i,l,u,m,p,d,h;if(r){let t=r;r.customize&&(t=Object.assign({},t),n=r.customize.call(null,e,"text/css",t),t.pathname&&n&&(s=f(t.pathname,n))),({compress:i,download:l,preserve:u,process:m,tasks:p,cloudStorage:d,document:h}=t)}const g=File.parseUri(c(e),N(l,o),{saveAs:s,format:m?m.join("+"):""});this.processExtensions(g,h,i,p,d)&&(n&&(g.filename=n),u&&(g.preserve=!0),g.mimeType=t.mimeType,a.push(g))}return C(l),a}getImageAssets(t){var s;let n,i,r,a;t&&(({resourceId:n,assetMap:i,preserveCrossOrigin:r}=t),a=null===(s=t.saveAs)||void 0===s?void 0:s.image);const l=[];document.querySelectorAll("img, input[type=image], picture > source[src], video[poster]").forEach((t=>{let s=t instanceof HTMLVideoElement?t.poster:t.src,n,o;const u=e.parseDataURI(s);if(u){if(!(o=u.base64))return;n=u.mimeType,s=c(q("",n&&h(n)))}else s=c(s);this.processImageUri(l,t,s,a,r,i,n,o)})),document.querySelectorAll("img[srcset], picture > source[srcset]").forEach((e=>{for(y.matcher(e.srcset.trim());y.find();){const t=c(y.group(1));t!==c(e.src)&&this.processImageUri(l,e,t,a,r,i,void 0,void 0,!0)}}));const u=this.getResourceAssets(n);if(u){for(const t of u.image.keys()){const s=e.parseDataURI(t);s?s.base64&&this.resource.addRawData(n,t,s):this.processImageUri(l,null,t,a,r)}for(const e of u.rawData.values()){const{base64:t,content:s,mimeType:n=g(e.filename)}=e;if(t){if(null==a?void 0:a.blob){let s=a,i,r;a.customize&&(s=Object.assign({},s),i=a.customize.call(null,"",n,s));const u=s.pathname;if(i||(i=e.filename),p(n,"image/")&&(r=s.commands))for(let e=0;e<r.length;++e){const t=/^\s*(?:(png|jpeg|webp|bmp)\s*[@%]?)(.*)$/.exec(r[e]);t?r[e]=t[1]+"@"+t[2].trim():r.splice(e--,1)}const m=this.processImageUri(l,null,c(u?f(u,i):i),s,!1,void 0,n,t);m&&(o(m.filename,".unknown")&&(m.mimeType="image/unknown"),r&&r.length?m.commands=r:delete m.commands,u||delete m.uri,this.processExtensions(m)&&l.push(m))}}else if(s&&n){const t={pathname:`__generated__/${n.split("/").pop()}`,filename:q(e.filename),content:s,mimeType:n};this.processExtensions(t)&&l.push(t)}}}return l}getVideoAssets(e){return this.getRawAssets("video",e)}getAudioAssets(e){return this.getRawAssets("audio",e)}getFontAssets(e){var t;let s,n,o;e&&(({resourceId:s,preserveCrossOrigin:n}=e),o=null===(t=e.saveAs)||void 0===t?void 0:t.font);const i=[],r=this.getResourceAssets(s);if(r)for(const e of r.fonts.values())for(const{srcUrl:t,srcBase64:s,mimeType:r}of e){let e,a,l,u;if(o){let s=o;o.customize&&(s=Object.assign({},s),a=o.customize.call(null,t||"",r,s)),({pathname:e,inline:l,blob:u}=s)}let m=null;t?(m=File.parseUri(t,!0!==l&&n))&&l&&(m.format="base64"):s&&u&&(a||(a=q("",h(r))),(m=File.parseUri(c(e?f(e,a):a)))&&(m.format="blob",m.base64=s)),this.processExtensions(m)&&i.push(m)}return i}finalizeRequestBody(e,t){var n,o;const i=t.productionRelease;let c;if(e.baseUrl=t.baseUrl,e.dataSource=t.dataSource,e.templateMap=t.templateMap,e.unusedStyles=t.unusedStyles,e.productionRelease=i,!i&&t.watch){const e={},i=new URL(this.hostname).hostname;for(const{watch:s}of t.assets)if(a(s)&&s.reload){const t=s.reload,{socketId:a,handler:c={},secure:l}=t;let u=null!==(n=t.port)&&void 0!==n?n:l?this.userSettings.webSocketSecurePort:this.userSettings.webSocketPort;a&&r(u)&&!isNaN(u=+u)&&(e[o=a+`_${u}_`+(l?"0":"1")]||(e[o]='socket=new WebSocket("'+(l?"wss":"ws")+`://${i}:${u}");`+(c.open?`socket.onopen=${c.open};`:"")+"socket.onmessage="+(c.message||`function(e){var c=JSON.parse(e.data);if(c&&c.socketId==="${a}"&&c.module==="watch"&&c.action==="modified"){if(!c.errors||!c.errors.length){if(c.hot){if(c.type==="text/css"){var a=document.querySelectorAll('link[href^="'+c.src+'"]');if(a.length){a.forEach(function(b){b.href=c.src+c.hot;});return;}}else if(c.type.startsWith("image/")){var a=document.querySelectorAll('img[src^="'+c.src+'"]');if(a.length){a.forEach(function(b){b.src=c.src+c.hot;});return;}}}window.location.reload();}else{console.log("FAIL: "+c.errors.length+" errors\\n\\n"+c.errors.join("\\n"));}}}`)+";"+(c.error?`socket.onerror=${c.error};`:"")+(c.close?`socket.onclose=${c.close};`:""))),delete t.handler}if(Object.keys(e).length){let n='document.addEventListener("DOMContentLoaded", function(){var socket;';for(const t in e)n+=e[t];if(n+="});",t.useOriginalHtmlPage){const e=t.assets.find((e=>"@text/html"===e.mimeType));e&&(e.element.textContent=`<script>${n}<\/script>`)}else c=s("script",{parent:document.body,attributes:{textContent:n}})}}if(!t.useOriginalHtmlPage){for(const e of t.assets){const t=e.element;if(t){switch(t.tagName){case"html":t.innerXml=document.documentElement.innerHTML;break;case"script":c&&++t.tagCount}if(c){const e=t.append;"script"===(null==e?void 0:e.tagName)&&++e.tagCount}}i&&e.watch&&delete e.watch}if(c&&document.body.removeChild(c),e.document)for(const t of e.document){const e=t+"Id";document.querySelectorAll(`[data-${t}-id]`).forEach((t=>delete t.dataset[e]))}t.removeInlineStyles&&document.querySelectorAll("[style]").forEach((e=>e.removeAttribute("style")))}}getCopyQueryParameters(e){return e.watch&&!e.productionRelease?"&watch=1":""}getRawAssets(e,t){var s;let n,o,i;t&&(({assetMap:n,preserveCrossOrigin:o}=t),i=null===(s=t.saveAs)||void 0===s?void 0:s.image);const r=[];return document.querySelectorAll(e).forEach((e=>{const t=new Map;let s="";switch(e.tagName.toUpperCase()){case"VIDEO":case"AUDIO":e.querySelectorAll("source, track").forEach((e=>E(e,t)));break;case"IFRAME":if(!(null==n?void 0:n.get(e))&&!p(e.dataset.chromeFile,"saveTo"))return;case"OBJECT":case"EMBED":{const t=e instanceof HTMLObjectElement?e.data:e.src;if(s=e.type||g(t),p(s,"image/"))return void this.processImageUri(r,e,t,i,o,n,s);break}}E(e,t);for(const[e,s]of t){const t=e.dataset.chromeFile;if("ignore"===t)continue;const i=null==n?void 0:n.get(e);let a,c,l,u,m,p,d,f,h,g,A;if(i){if(({filename:l,compress:u,download:m,tasks:p,watch:d,attributes:f,cloudStorage:h,document:g}=i),F(r,i,e,g))continue;[a,c]=L(s,i.saveTo||i.pathname,l||H(s)),a&&(l=""),A=!0}else{const s=x("saveAs",t);s&&(a=s.file);const{chromeOptions:n,chromeTasks:o,chromeWatch:i}=e.dataset;({compress:u,download:m}=T(n)),p=v(o),d=b(i)}const y=File.parseUri(s,N(m,o),{saveAs:a,saveTo:c,fromConfig:A});this.processExtensions(y,g,u,p,h,f,e,d)&&(l&&(y.filename=l),r.push(y))}})),r}processAssets(e){const{assetMap:t,appendMap:s,nodeMap:n=new Map,useOriginalHtmlPage:o,preserveCrossOrigin:i}=e,r=document.querySelectorAll("*"),a={},c=this.getHtmlPage(e).concat(this.getLinkAssets(e));if(e.saveAsWebPage)for(const e of c)switch(e.mimeType){case"text/html":case"text/css":e.mimeType="@"+e.mimeType}const[l,m]=this.getScriptAssets(e);if(c.push(...l,...this.getImageAssets(e),...this.getVideoAssets(e),...this.getAudioAssets(e),...this.getRawAssets("object",e),...this.getRawAssets("embed",e),...this.getRawAssets("iframe",e),...this.getFontAssets(e)),s){const e={},n=(t,s,n,o)=>(t in e||(e[t]=document.querySelectorAll(t).length),{tagName:t,tagCount:e[t],textContent:n,order:s,prepend:o});for(const[e,l]of s){const s=File.createTagNode(e,r,a),m=null==t?void 0:t.get(e),p=null==m?void 0:m.document,d=()=>s.index+e.querySelectorAll("*").length+1;o||File.setDocumentId(s,e,p),s.outerXml=e.outerHTML.trim();let f=0;for(const t of l){const{type:o,attributes:r,download:a,textContent:l}=t;if(o){let m,h,g;switch(o){case"prepend/js":g=!0;case"append/js":r&&(h=r.src,r.type||(r.type="text/javascript"),m=!0);break;case"prepend/css":g=!0;case"append/css":r&&(h=r.href,r.type||(r.type="text/css"));break;default:{let e;if("replace"===o)l&&(e=D(s,r),e.textContent=l);else{const t=n(u(o,"/",!0,!0).toLowerCase(),++f,l);o.startsWith("append/")?(t.nextSibling=d(),e=D(s,r,t)):o.startsWith("prepend/")&&(t.prepend=!0,e=D(s,r,t))}e&&c.push({pathname:"",filename:"",document:p,element:e});continue}}if(h&&r){t.document||(t.document=p),delete t.download;const o=this.createBundle(c,e,h,r.type,void 0,void 0,void 0,t);if(o){N(a,i)&&delete o.uri;const e=n(m?"script":"link",++f,void 0,g);g||(e.nextSibling=d()),o.element=D(s,r,e)}}}}}}const p=this.userSettings.outputDocumentHandler;for(const e of c){const t=e.element;if(t instanceof Element){const s=File.createTagNode(t,r,a);o||File.setDocumentId(s,t,e.document),e.element=s,n.set(s,t)}e.document||(e.document=File.copyDocument(p))}for(const[e,t]of n)t!==document.documentElement&&(e.outerXml=t.outerHTML.trim());return e.assets&&c.push(...e.assets),e.assets=c,e.baseUrl=location.href,m&&(e.templateMap=m),delete e.assetMap,delete e.indexMap,delete e.nodeMap,delete e.appendMap,e}createBundle(e,t,s,n,o,i,r,a,l,u=!0){let m=a?"":t.dataset.chromeFile;if("exclude"===m||"ignore"===m)return;let p=(null==r?void 0:r.get(t))||a,d,f,h,g,A,y,w,S,k,E,C,j,_,q;if(p){if(({inline:h,compress:A,download:y,preserve:w,process:g,tasks:S,watch:k,attributes:E,cloudStorage:C,document:j}=p),F(e,p,t,j))return;m=s?p.saveAs:p.exportAs,m||!p.filename||p.pathname&&(m=L(s,p.pathname,p.filename)[0])||(d=p.filename),_=!0}else{if(u&&l){if(p=l,l.customize&&(p=Object.assign({},p),d=l.customize.call(null,s||"",n,p)),({preserve:w,inline:h,compress:A,download:y,process:g,tasks:S,watch:k,attributes:E,cloudStorage:C,document:j}=p),F(e,l,t,j))return;(d||(d=p.filename))&&(s?(m=U(s,p.pathname,d))&&(d=""):(m="./"+d,d="",q=!0))}const{chromeOptions:o,chromeTasks:i,chromeWatch:r}=t.dataset,a=T(o);null!=h||(h=a.inline),null!=w||(w=a.preserve),null!=A||(A=a.compress),null!=y||(y=a.download),S||(S=v(i)),k||(k=b(r))}g&&(f=g.join("+"));let D=null;if(s){if((D=File.parseUri(c(s),N(y,o),{saveAs:m,mimeType:n,format:f,fromConfig:_}))&&"crossorigin"!==D.format)if(a){if(h)switch(a.type){case"append/js":D.inlineContent="script";break;case"append/css":D.inlineContent="style"}}else h&&(D.inlineContent=P(t)),M(e,D)&&(D.bundleIndex=-1)}else if(m){if(!_&&!q){const e=x("exportAs",m);e&&({file:m,format:f}=e)}(D=O(e,t,m,n,f,w,h,j))&&(D.bundleIndex=-1)}else t instanceof HTMLScriptElement||(D=R(n));return this.processExtensions(D,j,A,S,C,E,a?void 0:t,k)?(d&&(D.filename=d),w&&(D.preserve=!0),i&&I(i,D),e.push(D),D):void 0}processImageUri(e,t,s,n,o,i,r,a,c){if(s){let l,u,m,p,d,f,h,g,A,y,w,S,k,E,C,O;const I=e=>{e.customize&&(l=Object.assign({},e),d=e.customize.call(null,s,r||"",l))};if(t){const o=t.dataset.chromeFile;if("ignore"===o)return;if(l=null==i?void 0:i.get(t)){if(({pathname:p,filename:d,inline:h,compress:g,download:A,blob:y,commands:f,tasks:w,watch:S,attributes:k,cloudStorage:E,document:C}=l),F(e,l,t,C))return;[u,m]=L(s,l.saveTo||p,d||H(s)),u&&(d=""),O=!0}else{if(n){if(I(l=n),({pathname:p,inline:h,compress:g,download:A,blob:y,commands:f,tasks:w,watch:S,attributes:k,cloudStorage:E,document:C}=l),F(e,n,t,C))return;[u,m]=L(s,p,d||H(s))}if(o&&!p){let e=x("saveTo",o);e?[u,m]=L(s,e.file,d||H(s)):(e=x("saveAs",o))&&(u=e.file)}const{chromeCommands:i,chromeOptions:r,chromeTasks:a,chromeWatch:c}=t.dataset;!f&&i&&(f=i.split("::").map((e=>e.trim())));const O=T(r);null!=h||(h=O.inline),null!=g||(g=O.compress),null!=A||(A=O.download),null!=y||(y=O.blob),w||(w=v(a)),S||(S=b(c))}}else n&&(I(l=n),({pathname:p,inline:h,compress:g,download:A,blob:y,commands:f,tasks:w,cloudStorage:E}=l),[u,m]=L(s,p,d||H(s)));if(a&&!y)return;!f||0!==f.length&&"~"!==f[0]||(f=void 0);const M=File.parseUri(s,N(A,o),{saveAs:u,saveTo:m,mimeType:r,fromConfig:O});if(this.processExtensions(M,C,g,w,E,k,t,S,!!f)){if(d&&(M.filename=d),a){if(!O&&e.find((e=>e.base64===a)))return;M.format="blob",M.base64=a}else if(c)M.format="srcset";else if(h)M.format="base64";else if(!t&&e.find((e=>e.moveTo===M.moveTo&&e.pathname===M.pathname&&e.filename===M.filename&&!M.filename.includes("__assign__"))))return;return f&&(M.commands=f),e.push(M),M}}}getResourceAssets(t){if(void 0!==t&&-1!==t)return e.ASSETS[t]}processExtensions(e,t,s,n,o,i,r,a,c){if(e){s&&(e.compress=s,c=!0),n&&(e.tasks=n,c=!0),i&&(e.attributes=i,c=!0),o&&(e.cloudStorage=o,c=!0),a&&(e.watch=a,c=!0),r&&(e.element=r),t&&(e.document=t);for(const t of this.application.extensions)if(!t.processFile(e))return!1;return c||"crossorigin"!==e.format}return!1}get application(){return this.resource.application}get userSettings(){return this.resource.userSettings}}const{UNABLE_TO_FINALIZE_DOCUMENT:B,reject:J}=squared.lib.error,{escapePattern:X,isPlainObject:Q}=squared.lib.util;class Application extends squared.base.Application{constructor(){super(...arguments),this.extensions=[],this.systemName="chrome"}init(){this.session.unusedStyles=!0}insertNode(e,t){if("#"===t.nodeName[0]){if(this.userSettings.excludePlainText)return;this.controllerHandler.applyDefaultStyles(e,t)}return this.createNodeStatic(e,t)}saveAs(e,t){return this.processAssets("saveAs",e,t)}copyTo(e,t){return this.processAssets("copyTo",e,t)}appendTo(e,t){return this.processAssets("appendTo",e,t)}async processAssets(e,t,s){const n=await this.parseDocument();if(!n)return J(B);const{resourceId:o,unusedStyles:i}=this.getProcessing(n.sessionId),r=[],a=new Map,c=new Map,l=new Map;if(s=Object.assign(Object.assign({},s),{saveAsWebPage:!0,resourceId:o,assetMap:a,nodeMap:c,appendMap:l}),i){const{removeUnusedClasses:e,removeUnusedSelectors:t,retainUsedStyles:n}=s;if(e||t){const o=[];for(const s of i)!(s.includes(":")?t:e)||n&&n.includes(s)||o.push(s);o.length&&(s.unusedStyles=o)}}if(s.configUri){const e=await this.fileHandler.loadConfig(s.configUri,s);if(e){const t=this.userSettings.outputDocumentHandler,s=new Map,n=e=>{if(e&&"number"!=typeof e&&"boolean"!=typeof e){const t=e,n="object"==typeof e||Array.isArray(e);n&&(e=JSON.stringify(e));const o=e;for(const[t,n]of s.values())e=e.replace(t,n);if(o===e)return t;if(n)try{return JSON.parse(e)}catch(e){return t}}return e};location.href.includes("?")&&new URLSearchParams(location.search).forEach(((e,t)=>s.set(t,[new RegExp(`\\{\\{\\s*${X(t)}\\s*\\}\\}`,"g"),e])));for(const o of e)if(o.selector){const e=o.type;let i=Q(o.dataSource)?o.dataSource:null,c=Q(o.cloudDatabase)?o.cloudDatabase:null;if(s.size)for(const e of[i,c])if(e)for(const t in e)"value"!==t&&(e[t]=n(e[t]));i&&(i=Object.assign(Object.assign({document:o.document||File.copyDocument(t)},i),{type:e})),c&&(c=Object.assign(Object.assign({document:o.document||File.copyDocument(t)},i),{type:e,source:"cloud"})),document.querySelectorAll(o.selector).forEach((t=>{switch(e){case"text":case"attribute":case"display":i?r.push([t,i]):c&&r.push([t,c]);break;default:if(e&&("replace"===e||e.startsWith("append/")||e.startsWith("prepend/"))){const e=l.get(t)||[];e.push(Object.assign({},o)),l.set(t,e)}else a.set(t,Object.assign({},o))}}))}}}if(0===a.size&&delete s.assetMap,0===l.size&&delete s.appendMap,r.length){const e=s.useOriginalHtmlPage,t=document.querySelectorAll("*"),n={},o=s.dataSource||(s.dataSource=[]);for(let s=0,i=r.length;s<i;++s){const[i,a]=r[s],l=File.createTagNode(i,t,n);l.textContent=i.textContent,a.element=l,e||File.setDocumentId(l,i,a.document),c.set(l,i),o.push(a)}}return this.fileHandler[e](t,s)}get initializing(){return!1}get length(){return 1}}class Extension extends squared.base.Extension{processFile(e){return!0}}class Node extends squared.base.Node{}const K={builtInExtensions:[],preloadImages:!1,preloadFonts:!1,preloadCustomElements:!1,excludePlainText:!0,createElementMap:!0,createQuerySelectorMap:!0,pierceShadowRoot:!0,showErrorMessages:!1,webSocketPort:80,webSocketSecurePort:443,outputDocumentHandler:"chrome",outputEmptyCopyDirectory:!1,outputTasks:{},outputWatch:{},outputArchiveName:"chrome-data",outputArchiveFormat:"zip",outputArchiveCache:!1},{DIRECTORY_NOT_PROVIDED:Y,FRAMEWORK_NOT_INSTALLED:Z,reject:G}=squared.lib.error,{isString:ee,isPlainObject:te}=squared.lib.util;let se=null,ne=null;function oe(e,t,s){return te(t)?t.assets&&e.push(...t.assets):t={},Object.assign(t,{assets:e,filename:s})}const ie=(e,t)=>e||`${se.userSettings.outputArchiveName}-${t}`,re=undefined;return{base:{Application:Application,Extension:Extension,File:File,Node:Node},lib:{},extensions:{},system:{copyHtmlPage:(e,t)=>ee(e)?ne?ne.copying(e,oe(ne.getHtmlPage(t),t)):G(Z):G(Y),copyScriptAssets:(e,t)=>ee(e)?ne?ne.copying(e,oe(ne.getScriptAssets(t)[0],t)):G(Z):G(Y),copyLinkAssets:(e,t)=>ee(e)?ne?ne.copying(e,oe(ne.getLinkAssets(t),t)):G(Z):G(Y),copyImageAssets:(e,t)=>ee(e)?ne?ne.copying(e,oe(ne.getImageAssets(t),t)):G(Z):G(Y),copyVideoAssets:(e,t)=>ee(e)?ne?ne.copying(e,oe(ne.getVideoAssets(t),t)):G(Z):G(Y),copyAudioAssets:(e,t)=>ee(e)?ne?ne.copying(e,oe(ne.getAudioAssets(t),t)):G(Z):G(Y),copyFontAssets:(e,t)=>ee(e)?ne?ne.copying(e,oe(ne.getFontAssets(t),t)):G(Z):G(Y),saveHtmlPage:(e,t)=>ne?ne.archiving("",oe(ne.getHtmlPage(t),t,ie(e,"html"))):G(Z),saveScriptAssets:(e,t)=>ne?ne.archiving("",oe(ne.getScriptAssets(t)[0],t,ie(e,"script"))):G(Z),saveLinkAssets:(e,t)=>ne?ne.archiving("",oe(ne.getLinkAssets(t),t,ie(e,"link"))):G(Z),saveImageAssets:(e,t)=>ne?ne.archiving("",oe(ne.getImageAssets(t),t,ie(e,"image"))):G(Z),saveVideoAssets:(e,t)=>ne?ne.archiving("",oe(ne.getVideoAssets(t),t,ie(e,"video"))):G(Z),saveAudioAssets:(e,t)=>ne?ne.archiving("",oe(ne.getAudioAssets(t),t,ie(e,"audio"))):G(Z),saveFontAssets:(e,t)=>ne?ne.archiving("",oe(ne.getFontAssets(t),t,ie(e,"font"))):G(Z)},create:()=>(se=new Application(4,Node,squared.base.Controller,squared.base.ExtensionManager,squared.base.Resource),ne=new File,se.resourceHandler.fileHandler=ne,{application:se,framework:4,userSettings:Object.assign({},K)}),cached(){return se?{application:se,framework:4,userSettings:se.userSettings}:this.create()}}}();
