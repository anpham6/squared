var chrome=function(){"use strict";class e extends squared.base.Resource{constructor(e,t){super(),this.application=e,this.cache=t,this.controllerSettings=e.controllerHandler.localSettings}get userSettings(){return this.application.userSettings}}const{isTextNode:t}=squared.lib.dom,s=e.ASSETS;class n extends squared.base.Application{constructor(){super(...arguments),this.builtInExtensions={},this.extensions=[]}finalize(){}insertNode(e,s){if(t(e)){if(this.userSettings.excludePlainText)return;this.controllerHandler.applyDefaultStyles(e)}const n=this.createNode(e,!1);return n.plainText&&s&&n.cssApply(s.textStyle),n}afterCreateCache(){this.controllerHandler.cacheElementList(this.processing.cache)}get length(){return s.images.size+s.rawData.size+s.fonts.size}}const i=squared.lib,{isTextNode:o}=i.dom,{setElementCache:r}=i.session;class c extends squared.base.Controller{constructor(e,t){super(),this.application=e,this.cache=t,this.localSettings={supported:{fontFormat:"*",imageFormat:"*"}},this._elementMap=new Map}init(){}sortInitialCache(){}reset(){this._elementMap.clear()}applyDefaultStyles(e){o(e)&&r(e,"styleMap",this.sessionId,{position:"static",display:"inline",verticalAlign:"baseline",float:"none",clear:"none"})}includeElement(){return!0}cacheElementList(e){const t=this._elementMap;for(const s of e)t.set(s.element,s)}get elementMap(){return this._elementMap}get userSettings(){return this.application.userSettings}}class l extends squared.base.ExtensionManager{}const a=squared.lib,{COMPONENT:u}=a.regex,{convertWord:p,fromLastIndexOf:h,resolvePath:m,spliceString:g,trimEnd:d}=a.util,f=e.ASSETS,v=/\s*(.+?\.[^\s,]+).*?,\s*/,y=/\s+[0-9.][wx]$/;function x(e){e=d(e,"/");const t=u.PROTOCOL.exec(e);let s="",n="";if(t){const i=t[2],o=t[3],r=t[4];if(e.startsWith(d(location.origin,"/"))||(s=p(i)+(o?"/"+o.substring(1):"")+"/"),r){const e=r.lastIndexOf("/");e>0&&(s+=r.substring(1,e),n=h(r,"/"))}}if(""!==s){const e=-1!==n.indexOf(".")?h(n,".").toLowerCase():void 0;return{pathname:s,filename:n,extension:e,mimeType:e&&E.getMimeType(e)}}}function A(e){return e=e.trim().replace(/([.|/\\{}()?])/g,(e,...t)=>"\\"+t[0]).replace(/\*/g,".*?"),RegExp(`${e}$`)}class E extends squared.base.File{reset(){super.reset(),this._outputFileExclusions=void 0}copyToDisk(e,t=[],s){this.copying(e,t.concat(this.getAssetsAll()),s)}appendToArchive(e,t=[]){this.archiving(this.userSettings.outputArchiveName,t.concat(this.getAssetsAll()),e)}saveToArchive(e){this.archiving(e,this.getAssetsAll())}getHtmlPage(e){const t=[],s=location.href,n=x(s);if(n){if(e)n.filename=e;else{const e=n.filename;-1===e.indexOf(".")&&(n.pathname+="/"+e,n.filename="index.html")}this.validFile(n)&&(n.uri=s,n.mimeType=E.getMimeType("html"),this.processExtensions(n),t.push(n))}return t}getScriptAssets(){const e=[];return document.querySelectorAll("script").forEach(t=>{const s=t.src.trim();if(""!==s){const n=m(s),i=x(n);this.validFile(i)&&(i.uri=n,t.type&&(i.mimeType=t.type),this.processExtensions(i),e.push(i))}}),e}getLinkAssets(e){const t=[];return document.querySelectorAll(e?`link[rel="${e}"]`:"link").forEach(e=>{const s=e.href.trim();if(""!==s){const e=m(s),n=x(e);this.validFile(n)&&(n.uri=e,this.processExtensions(n),t.push(n))}}),t}getImageAssets(){const e=[];for(const t of f.images.keys()){const s=x(t);this.validFile(s)&&(s.uri=t,this.processExtensions(s),e.push(s))}for(const[t,s]of f.rawData){const n=s.filename;if(n){const{pathname:i,base64:o,content:r,mimeType:c}=s;let l;i?l={pathname:i,filename:n,uri:t}:o?l={pathname:"generated/base64",filename:n,base64:o}:r&&c&&(l={pathname:"generated/"+c,filename:n,content:r}),this.validFile(l)&&(l.mimeType=c,this.processExtensions(l),e.push(l))}}return document.querySelectorAll("img[srcset], picture > source[srcset]").forEach(t=>{const s=[];let n,i=t.srcset.trim();for(;null!==(n=v.exec(i));)s.push(m(n[1])),i=g(i,n.index,n[0].length);i=i.trim(),""!==i&&s.push(m(i.replace(y,"")));for(const t of s)if(u.PROTOCOL.test(t)&&-1===e.findIndex(e=>e.uri===t)){const s=x(t);this.validFile(s)&&(s.uri=t,e.push(s))}}),e}getFontAssets(){const e=[];for(const t of f.fonts.values())for(const s of t){const t=s.srcUrl;if(t){const s=x(t);this.validFile(s)&&(s.uri=t,this.processExtensions(s),e.push(s))}}return e}getAssetsAll(){return this.getHtmlPage().concat(this.getScriptAssets()).concat(this.getLinkAssets()).concat(this.getImageAssets()).concat(this.getFontAssets())}validFile(e){if(e){const t=e.pathname+"/"+e.filename;return!this.outputFileExclusions.some(e=>e.test(t))}return!1}processExtensions(e){for(const t of this.application.extensions)t.processFile(e)}get outputFileExclusions(){let e=this._outputFileExclusions;if(void 0===e){const t=[];for(const e of this.userSettings.outputFileExclusions)t.push(A(e));e=t,this._outputFileExclusions=e}return e}get userSettings(){return this.resource.userSettings}get application(){return this.resource.application}}class S extends squared.base.Node{constructor(e,t,s,n){super(e,t,s),this._cached={},this.init(),n&&n(this)}}class F extends squared.base.Extension{processFile(e){return!1}}class M extends F{constructor(){super(...arguments),this.options={quality:11,fileExtensions:["js","css","json","svg"]}}processFile(e){const t=e.extension;if(t){const s=this.options;if(s.fileExtensions.includes(t))return e.brotliQuality=Math.min(s.quality,11),!0}return!1}}class b extends F{constructor(){super(...arguments),this.options={quality:9,fileExtensions:["js","css","json","svg"]}}processFile(e){const t=e.extension;if(t){const s=this.options;if(s.fileExtensions.includes(t))return e.gzipQuality=Math.min(s.quality,9),!0}return!1}}const I={builtInExtensions:["chrome.compress.brotli","chrome.compress.gzip"],preloadImages:!1,handleExtensionsAsync:!0,showErrorMessages:!1,createQuerySelectorMap:!0,excludePlainText:!0,outputFileExclusions:["squared.*","chrome.framework.*"],outputDirectory:"",outputArchiveName:"chrome-data",outputArchiveFormat:"zip",outputArchiveTimeout:60},q={COMPRESS_BROTLI:"chrome.compress.brotli",COMPRESS_GZIP:"chrome.compress.gzip"};var O=Object.freeze({__proto__:null,EXT_CHROME:q}),T=function(e,t,s,n){return new(s||(s=Promise))((function(i,o){function r(e){try{l(n.next(e))}catch(e){o(e)}}function c(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,c)}l((n=n.apply(e,t||[])).next())}))};const{flatArray:P,isString:_}=squared.lib.util;let w,C,L,R,k,N=!1;function H(e,t=!0){if(t){const t=k.get(e);if(t)return t}const s=R.preloadImages;return R.preloadImages=!1,w.parseDocument(e),R.preloadImages=s,k.get(e)||null}function z(e,t=!0){return T(this,void 0,void 0,(function*(){if(t){const t=k.get(e);if(t)return t}return yield w.parseDocument(e),k.get(e)||null}))}const B={base:{Application:n,ExtensionManager:l,Controller:c,File:E,Resource:e,View:S},lib:{constant:O},extensions:{compress:{Brotli:M,Gzip:b}},system:{getElement:(e,t=!0)=>w?H(e,t):null,getElementById(e,t=!0){if(w){const s=document.getElementById(e);if(s)return H(s,t)}return null},querySelector(e){if(w){const t=document.querySelector(e);if(t)return H(t)}return null},querySelectorAll(e){const t=[];return w&&document.querySelectorAll(e).forEach(e=>{const s=H(e);s&&t.push(s)}),t},getElementMap:()=>C?C.elementMap:new Map,clearElementMap(){if(C)return C.elementMap.clear()},copyHtmlPage(e,t,s){L&&_(e)&&L.copying(e,L.getHtmlPage(s),t)},copyScriptAssets(e,t){L&&_(e)&&L.copying(e,L.getScriptAssets(),t)},copyLinkAssets(e,t,s){L&&_(e)&&L.copying(e,L.getLinkAssets(s),t)},copyImageAssets(e,t){L&&_(e)&&L.copying(e,L.getImageAssets(),t)},copyFontAssets(e,t){L&&_(e)&&L.copying(e,L.getFontAssets(),t)},saveHtmlPage(e,t){L&&L.archiving((e||R.outputArchiveName)+"-html",L.getHtmlPage(t))},saveScriptAssets(e){L&&L.archiving((e||R.outputArchiveName)+"-script",L.getScriptAssets())},saveLinkAssets(e,t){L&&L.archiving((e||R.outputArchiveName)+"-link",L.getLinkAssets(t))},saveImageAssets(e){L&&L.archiving((e||R.outputArchiveName)+"-image",L.getImageAssets())},saveFontAssets(e){L&&L.archiving((e||R.outputArchiveName)+"-font",L.getFontAssets())}},create(){const t=q;return w=new n(4,S,c,e,l),C=w.controllerHandler,L=new E,w.resourceHandler.setFileHandler(L),k=C.elementMap,R=Object.assign({},I),Object.assign(w.builtInExtensions,{[t.COMPRESS_BROTLI]:new M(t.COMPRESS_BROTLI,4),[t.COMPRESS_GZIP]:new b(t.COMPRESS_GZIP,4)}),N=!0,{application:w,framework:4,userSettings:R}},cached:()=>N?{application:w,framework:4,userSettings:R}:B.create(),getElement:(e,t=!0)=>T(void 0,void 0,void 0,(function*(){return w?yield z(e,t):null})),getElementById:(e,t=!0)=>T(void 0,void 0,void 0,(function*(){if(w){const s=document.getElementById(e);if(s)return yield z(s,t)}return null})),querySelector:e=>T(void 0,void 0,void 0,(function*(){if(w){const t=document.querySelector(e);if(t)return yield z(t)}return null})),querySelectorAll:e=>T(void 0,void 0,void 0,(function*(){if(w){const t=document.querySelectorAll(e),s=Array(t.length);let n=!1;return yield T(void 0,void 0,void 0,(function*(){t.forEach((e,t)=>T(void 0,void 0,void 0,(function*(){const i=yield z(e);i?s[t]=i:n=!0})))})),n?P(s):s}return[]}))};return B}();
