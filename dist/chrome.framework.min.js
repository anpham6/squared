var chrome=function(){"use strict";class e extends squared.base.Resource{constructor(e,t){super(),this.application=e,this.cache=t}get userSettings(){return this.application.userSettings}}class t extends squared.base.Node{constructor(e,t,s,i){super(e,t,s),this._cached={},this.init(),i&&i(this)}}const s=squared.lib.dom,i=e.ASSETS;class n extends squared.base.Application{constructor(){super(...arguments),this.builtInExtensions={},this.extensions=[]}finalize(){}insertNode(e,i){if(s.isPlainText(e)){if(this.userSettings.excludePlainText)return;this.controllerHandler.applyDefaultStyles(e)}const n=this.createNode(e,!1);return n.plainText&&i&&t.copyTextStyle(n,i),n}afterCreateCache(){this.processing.node&&this.controllerHandler.cacheElementList(this.processing.cache)}get length(){return i.images.size+i.rawData.size+i.fonts.size}}const{constant:r,dom:o,session:c}=squared.lib;class a extends squared.base.Controller{constructor(e,t){super(),this.application=e,this.cache=t,this.localSettings={svg:{enabled:!0},supported:{fontFormat:"*",imageFormat:"*"},unsupported:{cascade:new Set,tagName:new Set,excluded:new Set}},this._elementMap=new Map}init(){}sortInitialCache(){}reset(){this._elementMap.clear()}applyDefaultStyles(e){o.isPlainText(e)&&c.setElementCache(e,"styleMap",this.application.processing.sessionId,{position:"static",display:"inline",verticalAlign:"baseline",float:r.CSS.NONE,clear:r.CSS.NONE})}includeElement(){return!0}cacheElement(e){this._elementMap.set(e.element,e)}cacheElementList(e){for(const t of e)this._elementMap.set(t.element,t)}get elementMap(){return this._elementMap}get userSettings(){return this.application.userSettings}}class l extends squared.base.ExtensionManager{}const{regex:u,util:p}=squared.lib,h=e.ASSETS,m={SRCSET:/\s*(.+?\.[^\s,]+).*?,\s*/,SRCSET_SPECIFIER:/\s+[0-9.][wx]$/};function g(e){e=p.trimEnd(e,"/");const t=u.COMPONENT.PROTOCOL.exec(e);let s="",i="";if(t){const n=t[2],r=t[3],o=t[4];if(e.startsWith(p.trimEnd(location.origin,"/"))||(s=p.convertWord(n)+(r?"/"+r.substring(1):"")+"/"),o){const e=o.lastIndexOf("/");e>0&&(s+=o.substring(1,e),i=p.fromLastIndexOf(o,"/"))}}if(""!==s){const e=-1!==i.indexOf(".")?p.fromLastIndexOf(i,".").toLowerCase():void 0;return{pathname:s,filename:i,extension:e,mimeType:e&&f.getMimeType(e)}}}function d(e){return e=e.trim().replace(/([.|\/\\{}()?])/g,(e,...t)=>"\\"+t[0]).replace(/\*/g,".*?"),RegExp(`${e}$`)}class f extends squared.base.File{reset(){super.reset(),this._outputFileExclusions=void 0}copyToDisk(e){this.copying(e,this.getAssetsAll())}saveToArchive(e){this.archiving(e,this.getAssetsAll())}getHtmlPage(e){const t=[],s=location.href,i=g(s);return i&&(e?i.filename=e:-1===i.filename.indexOf(".")&&(i.pathname+="/"+i.filename,i.filename="index.html"),this.validFile(i)&&(i.uri=s,i.mimeType=f.getMimeType("html"),this.processExtensions(i),t.push(i))),t}getScriptAssets(){const e=[];return document.querySelectorAll("script").forEach(t=>{const s=t.src.trim();if(""!==s){const i=p.resolvePath(s),n=g(i);this.validFile(n)&&(n.uri=i,t.type&&(n.mimeType=t.type),this.processExtensions(n),e.push(n))}}),e}getLinkAssets(e){const t=[];return document.querySelectorAll(e?`link[rel="${e}"]`:"link").forEach(e=>{const s=e.href.trim();if(""!==s){const e=p.resolvePath(s),i=g(e);this.validFile(i)&&(i.uri=e,this.processExtensions(i),t.push(i))}}),t}getImageAssets(){const e=[];for(const t of h.images.keys()){const s=g(t);this.validFile(s)&&(s.uri=t,this.processExtensions(s),e.push(s))}for(const[t,s]of h.rawData){const i=s.filename;if(i){const{pathname:n,base64:r,content:o,mimeType:c}=s;let a;n?a={pathname:n,filename:i,uri:t}:r?a={pathname:"generated/base64",filename:i,base64:r}:o&&c&&(a={pathname:`generated/${c}`,filename:i,content:o}),this.validFile(a)&&(a.mimeType=c,this.processExtensions(a),e.push(a))}}return document.querySelectorAll("img[srcset], picture > source[srcset]").forEach(t=>{const s=[];let i,n=t.srcset.trim();for(;null!==(i=m.SRCSET.exec(n));)s.push(p.resolvePath(i[1])),n=p.spliceString(n,i.index,i[0].length);""!==(n=n.trim())&&s.push(p.resolvePath(n.replace(m.SRCSET_SPECIFIER,"")));for(const t of s)if(u.COMPONENT.PROTOCOL.test(t)&&-1===e.findIndex(e=>e.uri===t)){const s=g(t);this.validFile(s)&&(s.uri=t,e.push(s))}}),e}getFontAssets(){const e=[];for(const t of h.fonts.values())for(const s of t){const t=s.srcUrl;if(t){const s=g(t);this.validFile(s)&&(s.uri=t,this.processExtensions(s),e.push(s))}}return e}getAssetsAll(){return this.getHtmlPage().concat(this.getScriptAssets()).concat(this.getLinkAssets()).concat(this.getImageAssets()).concat(this.getFontAssets())}validFile(e){if(e){const t=e.pathname+"/"+e.filename;return!this.outputFileExclusions.some(e=>e.test(t))}return!1}processExtensions(e){for(const t of this.application.extensions)t.processFile(e)}get outputFileExclusions(){if(void 0===this._outputFileExclusions){const e=[];for(const t of this.userSettings.outputFileExclusions)e.push(d(t));this._outputFileExclusions=e}return this._outputFileExclusions}get userSettings(){return this.resource.userSettings}get application(){return this.resource.application}}class S extends squared.base.Extension{processFile(e){return!1}}class E extends S{constructor(){super(...arguments),this.options={quality:11,fileExtensions:["js","css","json","svg"]}}processFile(e){if(e.extension){const t=this.options;if(t.fileExtensions.includes(e.extension))return e.brotliQuality=Math.min(t.quality,11),!0}return!1}}class x extends S{constructor(){super(...arguments),this.options={quality:9,fileExtensions:["js","css","json","svg"]}}processFile(e){if(e.extension){const t=this.options;if(t.fileExtensions.includes(e.extension))return e.gzipQuality=Math.min(t.quality,9),!0}return!1}}const y={builtInExtensions:["chrome.compress.brotli","chrome.compress.gzip"],preloadImages:!1,handleExtensionsAsync:!0,showErrorMessages:!1,createQuerySelectorMap:!0,excludePlainText:!0,outputFileExclusions:["squared.*","chrome.framework.*"],outputDirectory:"",outputArchiveName:"chrome-data",outputArchiveFormat:"zip",outputArchiveAppendTo:"",outputArchiveTimeout:60},v={COMPRESS_BROTLI:"chrome.compress.brotli",COMPRESS_GZIP:"chrome.compress.gzip"};const A=squared.lib.util;let F,I,_,M,T,O=!1;function b(e,t=!0){if(t){const t=T.get(e);if(t)return t}const s=M.preloadImages;return M.preloadImages=!1,F.parseDocument(e),M.preloadImages=s,T.get(e)||null}function P(e,t=!0){return __awaiter(this,void 0,void 0,function*(){if(t){const t=T.get(e);if(t)return t}return yield F.parseDocument(e),T.get(e)||null})}const q={base:{Application:n,ExtensionManager:l,Controller:a,File:f,Resource:e,View:t},lib:{constant:Object.freeze({EXT_CHROME:v})},extensions:{compress:{Brotli:E,Gzip:x}},system:{getElement:(e,t=!0)=>F?b(e,t):null,getElementById(e,t=!0){if(F){const s=document.getElementById(e);if(s)return b(s,t)}return null},querySelector(e){if(F){const t=document.querySelector(e);if(t)return b(t)}return null},querySelectorAll(e){const t=[];return F&&document.querySelectorAll(e).forEach(e=>{const s=b(e);s&&t.push(s)}),t},getElementMap:()=>I?I.elementMap:new Map,clearElementMap(){if(I)return I.elementMap.clear()},copyHtmlPage(e,t){_&&A.isString(e)&&_.copying(e,_.getHtmlPage(t))},copyScriptAssets(e){_&&A.isString(e)&&_.copying(e,_.getScriptAssets())},copyLinkAssets(e,t){_&&A.isString(e)&&_.copying(e,_.getLinkAssets(t))},copyImageAssets(e){_&&A.isString(e)&&_.copying(e,_.getImageAssets())},copyFontAssets(e){_&&A.isString(e)&&_.copying(e,_.getFontAssets())},saveHtmlPage(e,t){_&&_.archiving(e||`${M.outputArchiveName}-html`,_.getHtmlPage(t))},saveScriptAssets(e){_&&_.archiving(e||`${M.outputArchiveName}-script`,_.getScriptAssets())},saveLinkAssets(e,t){_&&_.archiving(e||`${M.outputArchiveName}-link`,_.getLinkAssets(t))},saveImageAssets(e){_&&_.archiving(e||`${M.outputArchiveName}-image`,_.getImageAssets())},saveFontAssets(e){_&&_.archiving(e||`${M.outputArchiveName}-font`,_.getFontAssets())}},create(){const s=v;return F=new n(4,t,a,e,l),I=F.controllerHandler,_=new f,F.resourceHandler.setFileHandler(_),T=I.elementMap,M=Object.assign({},y),Object.assign(F.builtInExtensions,{[s.COMPRESS_BROTLI]:new E(s.COMPRESS_BROTLI,4),[s.COMPRESS_GZIP]:new x(s.COMPRESS_GZIP,4)}),O=!0,{application:F,framework:4,userSettings:M}},cached:()=>O?{application:F,framework:4,userSettings:M}:q.create(),getElement:(e,t=!0)=>__awaiter(void 0,void 0,void 0,function*(){return F?yield P(e,t):null}),getElementById:(e,t=!0)=>__awaiter(void 0,void 0,void 0,function*(){if(F){const s=document.getElementById(e);if(s)return yield P(s,t)}return null}),querySelector:e=>__awaiter(void 0,void 0,void 0,function*(){if(F){const t=document.querySelector(e);if(t)return yield P(t)}return null}),querySelectorAll:e=>__awaiter(void 0,void 0,void 0,function*(){if(F){const t=document.querySelectorAll(e),s=Array(t.length);let i=!1;return yield(()=>__awaiter(this,void 0,void 0,function*(){t.forEach((e,t)=>__awaiter(this,void 0,void 0,function*(){const n=yield P(e);n?s[t]=n:i=!0}))}))(),i?A.flatArray(s):s}return[]})};return q}();
