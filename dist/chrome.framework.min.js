var chrome=function(){"use strict";class e extends squared.base.Resource{constructor(e,t){super(),this.application=e,this.cache=t,this.controllerSettings=e.controllerHandler.localSettings}get userSettings(){return this.application.userSettings}}const{isTextNode:t}=squared.lib.dom;class s extends squared.base.Application{constructor(){super(...arguments),this.builtInExtensions={},this.extensions=[]}finalize(){}createNode(e){return new this.Node(this.nextId,this.processing.sessionId,e.element)}insertNode(e,s){if(t(e)){if(this.userSettings.excludePlainText)return;this.controllerHandler.applyDefaultStyles(e);const t=this.createNode({element:e});return s&&t.cssApply(s.textStyle),t}return this.createNode({element:e})}afterCreateCache(){this.userSettings.cacheQuerySelectorResultSet?this.controllerHandler.cacheElementList(this.processing.cache):this.controllerHandler.cacheElement(this.processing.node)}get length(){const{images:t,rawData:s,fonts:n}=e.ASSETS;return t.size+s.size+n.size}}const n=squared.lib,{isTextNode:i}=n.dom,{setElementCache:o}=n.session;class r extends squared.base.Controller{constructor(e,t){super(),this.application=e,this.cache=t,this.localSettings={supported:{fontFormat:"*",imageFormat:"*"}},this._elementMap=new Map}init(){}sortInitialCache(){}reset(){this._elementMap.clear()}applyDefaultStyles(e){i(e)&&o(e,"styleMap",this.sessionId,{position:"static",display:"inline",verticalAlign:"baseline",float:"none",clear:"none"})}includeElement(){return!0}cacheElement(e){this._elementMap.set(e.element,e)}cacheElementList(e){const t=this._elementMap;for(const s of e)t.set(s.element,s)}get elementMap(){return this._elementMap}get userSettings(){return this.application.userSettings}}class c extends squared.base.ExtensionManager{}const l=squared.lib,{COMPONENT:a}=l.regex,{convertWord:u,fromLastIndexOf:p,resolvePath:h,spliceString:m,trimEnd:d}=l.util,g=e.ASSETS,f=/\s*(.+?\.[^\s,]+).*?,\s*/,v=/\s+[0-9.][wx]$/;function y(e){e=d(e,"/");const t=a.PROTOCOL.exec(e);let s="",n="";if(t){const i=t[2],o=t[3],r=t[4];if(e.startsWith(d(location.origin,"/"))||(s=u(i)+(o?"/"+o.substring(1):"")+"/"),r){const e=r.lastIndexOf("/");e>0&&(s+=r.substring(1,e),n=p(r,"/"))}}if(""!==s){const e=n.includes(".")?p(n,".").toLowerCase():void 0;return{pathname:s,filename:n,extension:e,mimeType:e&&S.getMimeType(e)}}}function x(e){return e=e.trim().replace(/([.|/\\{}()?])/g,(e,...t)=>"\\"+t[0]).replace(/\*/g,".*?"),RegExp(`${e}$`)}class S extends squared.base.File{reset(){super.reset(),this._outputFileExclusions=void 0}copyToDisk(e,t){this.copying(Object.assign(Object.assign({},t),{assets:this._getAssetsAll().concat((null==t?void 0:t.assets)||[]),directory:e}))}appendToArchive(e,t){this.archiving(Object.assign(Object.assign({},t),{assets:this._getAssetsAll().concat((null==t?void 0:t.assets)||[]),filename:this.userSettings.outputArchiveName,appendTo:e}))}saveToArchive(e,t){this.archiving(Object.assign(Object.assign({},t),{assets:this._getAssetsAll().concat((null==t?void 0:t.assets)||[]),filename:e}))}getHtmlPage(e){const t=[],s=location.href,n=y(s);if(n){if(e)n.filename=e;else{const e=n.filename;e.includes(".")||(n.pathname+="/"+e,n.filename="index.html")}this._validFile(n)&&(n.uri=s,n.mimeType=S.getMimeType("html"),this._processExtensions(n),t.push(n))}return t}getScriptAssets(){const e=[];return document.querySelectorAll("script").forEach(t=>{const s=t.src.trim();if(""!==s){const n=h(s),i=y(n);if(this._validFile(i)){i.uri=n;const s=t.type;s&&(i.mimeType=s),this._processExtensions(i),e.push(i)}}}),e}getLinkAssets(e){const t=[];return document.querySelectorAll(e?`link[rel="${e}"]`:"link").forEach(e=>{const s=e.href.trim();if(""!==s){const e=h(s),n=y(e);this._validFile(n)&&(n.uri=e,this._processExtensions(n),t.push(n))}}),t}getImageAssets(){const e=[];for(const t of g.images.keys()){const s=y(t);this._validFile(s)&&(s.uri=t,this._processExtensions(s),e.push(s))}for(const[t,s]of g.rawData){const n=s.filename;if(n){const{pathname:i,base64:o,content:r,mimeType:c}=s;let l;if(i)l={pathname:i,filename:n,uri:t};else if(o)l={pathname:"generated/base64",filename:n,base64:o};else{if(!r||!c)continue;l={pathname:`generated/${c}`,filename:n,content:r}}this._validFile(l)&&(l.mimeType=c,this._processExtensions(l),e.push(l))}}return document.querySelectorAll("img[srcset], picture > source[srcset]").forEach(t=>{const s=[];let n,i=t.srcset.trim();for(;null!==(n=f.exec(i));)s.push(h(n[1])),i=m(i,n.index,n[0].length);i=i.trim(),""!==i&&s.push(h(i.replace(v,"")));for(const t of s)if(a.PROTOCOL.test(t)&&-1===e.findIndex(e=>e.uri===t)){const s=y(t);this._validFile(s)&&(s.uri=t,e.push(s))}}),e}getFontAssets(){const e=[];for(const t of g.fonts.values())for(const s of t){const t=s.srcUrl;if(t){const s=y(t);this._validFile(s)&&(s.uri=t,this._processExtensions(s),e.push(s))}}return e}_getAssetsAll(){return this.getHtmlPage().concat(this.getScriptAssets()).concat(this.getLinkAssets()).concat(this.getImageAssets()).concat(this.getFontAssets())}_validFile(e){if(e){const t=`${e.pathname}/${e.filename}`;return!this.outputFileExclusions.some(e=>e.test(t))}return!1}_processExtensions(e){for(const t of this.application.extensions)t.processFile(e)}get outputFileExclusions(){let e=this._outputFileExclusions;if(void 0===e){const t=[];for(const e of this.userSettings.outputFileExclusions)t.push(x(e));e=t,this._outputFileExclusions=e}return e}get userSettings(){return this.resource.userSettings}get application(){return this.resource.application}}class A extends squared.base.Node{constructor(e,t,s,n){super(e,t,s),this._cached={},this.init(),n&&n(this)}}class E extends squared.base.Extension{processFile(e){return!1}}class _ extends E{constructor(){super(...arguments),this.options={quality:11,fileExtensions:["js","css","json","svg"]}}processFile(e){const t=e.extension;if(t){const s=this.options;if(s.fileExtensions.includes(t))return e.brotliQuality=Math.min(s.quality,11),!0}return!1}}class b extends E{constructor(){super(...arguments),this.options={quality:9,fileExtensions:["js","css","json","svg"]}}processFile(e){const t=e.extension;if(t){const s=this.options;if(s.fileExtensions.includes(t))return e.gzipQuality=Math.min(s.quality,9),!0}return!1}}const F={builtInExtensions:["chrome.compress.brotli","chrome.compress.gzip"],preloadImages:!1,handleExtensionsAsync:!0,showErrorMessages:!1,createQuerySelectorMap:!0,cacheQuerySelectorResultSet:!0,excludePlainText:!0,outputFileExclusions:["squared.*","chrome.framework.*"],outputDirectory:"",outputEmptyCopyDirectory:!1,outputArchiveName:"chrome-data",outputArchiveFormat:"zip",outputArchiveTimeout:60},O={COMPRESS_BROTLI:"chrome.compress.brotli",COMPRESS_GZIP:"chrome.compress.gzip"};var I=Object.freeze({__proto__:null,EXT_CHROME:O}),M=function(e,t,s,n){return new(s||(s=Promise))((function(i,o){function r(e){try{l(n.next(e))}catch(e){o(e)}}function c(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,c)}l((n=n.apply(e,t||[])).next())}))};const{flatArray:q,isString:T}=squared.lib.util;let P,w,C,N,R,j=!1;function L(e,t){if(t){const t=R.get(e);if(t)return t}const s=N.preloadImages;return N.preloadImages=!1,P.parseDocument(e),N.preloadImages=s,R.get(e)||null}function k(e,t){return M(this,void 0,void 0,(function*(){if(t){const t=R.get(e);if(t)return t}return yield P.parseDocument(e),R.get(e)||null}))}function H(e,t,s,n){return Object.assign(Object.assign({},t),{assets:e.concat((null==t?void 0:t.assets)||[]),directory:s,filename:n})}const z={base:{Application:s,ExtensionManager:c,Controller:r,File:S,Resource:e,View:A},lib:{constant:I},extensions:{compress:{Brotli:_,Gzip:b}},system:{getElement:(e,t=!0)=>P?L(e,t):null,getElementById(e,t=!0){if(P){const s=document.getElementById(e);if(s)return L(s,t)}return null},querySelector(e,t=!0){if(P){const s=document.querySelector(e);if(s)return L(s,t)}return null},querySelectorAll(e,t=!0){const s=[];return P&&document.querySelectorAll(e).forEach(e=>{const n=L(e,t);n&&s.push(n)}),s},getElementMap:()=>(null==w?void 0:w.elementMap)||new Map,clearElementMap(){null==w||w.elementMap.clear()},copyHtmlPage(e,t){C&&T(e)&&C.copying(H(C.getHtmlPage(null==t?void 0:t.name),t,e))},copyScriptAssets(e,t){C&&T(e)&&C.copying(H(C.getScriptAssets(),t,e))},copyLinkAssets(e,t){C&&T(e)&&C.copying(H(C.getLinkAssets(null==t?void 0:t.rel),t,e))},copyImageAssets(e,t){C&&T(e)&&C.copying(H(C.getImageAssets(),t,e))},copyFontAssets(e,t){C&&T(e)&&C.copying(H(C.getFontAssets(),t,e))},saveHtmlPage(e,t){C&&C.archiving(H(C.getHtmlPage(null==t?void 0:t.name),t,void 0,(e||N.outputArchiveName)+"-html"))},saveScriptAssets(e,t){C&&C.archiving(H(C.getScriptAssets(),t,void 0,(e||N.outputArchiveName)+"-script"))},saveLinkAssets(e,t){C&&C.archiving(H(C.getLinkAssets(null==t?void 0:t.rel),t,void 0,(e||N.outputArchiveName)+"-link"))},saveImageAssets(e,t){C&&C.archiving(H(C.getImageAssets(),t,void 0,(e||N.outputArchiveName)+"-image"))},saveFontAssets(e,t){C&&C.archiving(H(C.getFontAssets(),t,void 0,(e||N.outputArchiveName)+"-font"))}},create(){const t=O;return P=new s(4,A,r,e,c),w=P.controllerHandler,C=new S,P.resourceHandler.setFileHandler(C),R=w.elementMap,N=Object.assign({},F),Object.assign(P.builtInExtensions,{[t.COMPRESS_BROTLI]:new _(t.COMPRESS_BROTLI,4),[t.COMPRESS_GZIP]:new b(t.COMPRESS_GZIP,4)}),j=!0,{application:P,framework:4,userSettings:N}},cached:()=>j?{application:P,framework:4,userSettings:N}:z.create(),getElement:(e,t=!0)=>M(void 0,void 0,void 0,(function*(){return P?yield k(e,t):null})),getElementById:(e,t=!0)=>M(void 0,void 0,void 0,(function*(){if(P){const s=document.getElementById(e);if(s)return yield k(s,t)}return null})),querySelector:(e,t=!0)=>M(void 0,void 0,void 0,(function*(){if(P){const s=document.querySelector(e);if(s)return yield k(s,t)}return null})),querySelectorAll:(e,t=!0)=>M(void 0,void 0,void 0,(function*(){if(P){const s=document.querySelectorAll(e);if(s.length)return yield function(e,t){return M(this,void 0,void 0,(function*(){const s=e.length,n=Array(s);let i=!1;for(let o=0;o<s;o++){const s=yield k(e[o],t);s?n[o]=s:i=!0}return i&&q(n),n}))}(s,t)}return null}))};return z}();
