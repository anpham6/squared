var chrome=function(){"use strict";class e extends squared.base.Resource{constructor(e,t){super(),this.application=e,this.cache=t}get userSettings(){return this.application.userSettings}}const{isTextNode:t}=squared.lib.dom;class s extends squared.base.Application{constructor(){super(...arguments),this.builtInExtensions={},this.extensions=[],this.systemName="chrome",this.queryState=0}finalize(){}createNode(e){return new this.Node(this.nextId,this.processing.sessionId,e.element)}insertNode(e,s){if(t(e)){if(this.userSettings.excludePlainText)return;this.controllerHandler.applyDefaultStyles(e);const t=this.createNode({element:e});if(s)t.cssApply(s.textStyle);return t}return this.createNode({element:e})}afterCreateCache(e){switch(this.queryState){case 1:this.controllerHandler.cacheElement(e);break;default:this.controllerHandler.cacheElementList(this.processing.cache);break}}get length(){const t=e.ASSETS;let s=0;for(const e in t)s+=t[e].size;return s}}const i=squared.lib,{isTextNode:n}=i.dom,{setElementCache:r}=i.session;class o extends squared.base.Controller{constructor(e,t){super(),this.application=e,this.cache=t,this.localSettings={mimeType:{font:"*",image:"*",audio:"*",video:"*"}},this._elementMap=new Map}init(){}sortInitialCache(){}reset(){this._elementMap.clear()}applyDefaultStyles(e){if(n(e))r(e,"styleMap",this.sessionId,{position:"static",display:"inline",verticalAlign:"baseline",float:"none",clear:"none"})}includeElement(){return true}cacheElement(e){this._elementMap.set(e.element,e)}cacheElementList(e){const t=this._elementMap;e.each(e=>t.set(e.element,e))}get elementMap(){return this._elementMap}get userSettings(){return this.application.userSettings}}const l=squared.lib,{CHAR:a,COMPONENT:c,FILE:u,XML:p}=l.regex,{appendSeparator:m,convertWord:f,fromLastIndexOf:h,isString:g,objectMap:d,parseMimeType:y,resolvePath:v,spliceString:A,trimEnd:S}=l.util,E=e.ASSETS,T=/\s*(.+?\.[^\s,]+).*?,\s*/,x=/\s+[0-9.][wx]$/;function b(e,t){var s;const i=S(e,"/"),n=c.PROTOCOL.exec(i);if(n){const r=n[2],o=n[3],l=n[4];let a,c,u,p="",m="",g="";const d=(e=1)=>{if(e>1)g=l.substring(0,e);return l.substring(e,l.lastIndexOf("/"))};if(!i.startsWith(S(location.origin,"/")))p=f(r)+(o?"/"+o.substring(1):"")+"/";else c=true;if(t){let e=null===(s=/saveAs:([^;"']+)/.exec(t))||void 0===s?void 0:s[1];if(e){if("/"===e.charAt(0))a="__serverroot__",e=e.substring(1);const t=e.split("/");m=decodeURIComponent(t.pop()),p=t.join("/"),u=true}}else if(l&&"/"!==l)if(m=h(l,"/"),c){const e=location.pathname.substring(0,location.pathname.lastIndexOf("/")+1);if(l.startsWith(e))p=d(e.length);else a="__serverroot__",p=d()}else p+=d();else m="index.html";const v=m.includes(".")?h(m,".").toLowerCase():void 0;return{uri:e,rootDir:g,moveTo:a,pathname:p,filename:m,extension:v,append:u,mimeType:v&&y(v)}}}function _(e,t){const s=v(t.src);if(""!==s)e.set(t,s)}function O(e){var t;const s=null===(t=null==e?void 0:e.dataset.use)||void 0===t?void 0:t.trim();return s?s.split(p.SEPARATOR):[]}function P(e,t,s){const i=[];if(true!==(null==s?void 0:s.ignoreExtensions))this.application.extensions.forEach(t=>{if(t.processFile(e))i.push(t)});for(const s of t){const t=this.application.extensionManager.retrieve(s,true);if(t&&!i.includes(t))t.processFile(e,true)}}class F extends squared.base.File{reset(){super.reset(),this._outputFileExclusions=void 0}copyToDisk(e,t){return this.copying(Object.assign(Object.assign({},t),{assets:this.getAssetsAll().concat((null==t?void 0:t.assets)||[]),directory:e}))}appendToArchive(e,t){return this.archiving(Object.assign(Object.assign({filename:this.userSettings.outputArchiveName},t),{assets:this.getAssetsAll(t).concat((null==t?void 0:t.assets)||[]),appendTo:e}))}saveToArchive(e,t){return this.archiving(Object.assign(Object.assign({},t),{assets:this.getAssetsAll(t).concat((null==t?void 0:t.assets)||[]),filename:e}))}getHtmlPage(e){const t=[],s=b(location.href);if(s){const i=null==e?void 0:e.name;if(i)s.filename=i;else{const e=s.filename;if(!u.NAME.test(e))s.pathname=m(s.pathname,e),s.filename="index.html"}if(this.validFile(s))s.mimeType=y("html"),P.call(this,s,O(document.querySelector("html")),e),t.push(s)}return t}getScriptAssets(e){var t;const s=[],i=null===(t=null==e?void 0:e.saveAs)||void 0===t?void 0:t.script;return document.querySelectorAll("script").forEach(t=>{let n=t.dataset.chromeFile;if("exclude"!==n){if(!g(n))n=i;const r=t.src.trim();if(""!==r){const i=b(v(r),n);if(this.validFile(i))i.mimeType=t.type.trim()||y(i.uri)||"text/javascript",P.call(this,i,O(t),e),s.push(i)}}}),s}getLinkAssets(e){var t;const s=[],i=null==e?void 0:e.rel,n=null===(t=null==e?void 0:e.saveAs)||void 0===t?void 0:t.script;return document.querySelectorAll(i?`link[rel="${i}"]`:"link").forEach(t=>{let i=t.dataset.chromeFile;if("exclude"!==i){if(!g(i))i=n;const r=t.href.trim();if(""!==r){const n=b(v(r),i);if(this.validFile(n)){switch(t.rel.trim()){case"stylesheet":n.mimeType="text/css";break;case"icon":n.mimeType="image/x-icon";break;default:n.mimeType=t.type.trim()||y(n.uri);break}P.call(this,n,O(t),e),s.push(n)}}}}),s}getImageAssets(e){const t=[],s=(s,i)=>{if(""!==i){const n=b(i);if(this.validFile(n)&&!t.find(e=>e.uri===i))P.call(this,n,O(s),e),t.push(n)}};document.querySelectorAll("picture > source").forEach(e=>e.srcset.split(p.SEPARATOR).forEach(t=>s(e,v(t.split(a.SPACE)[0])))),document.querySelectorAll("video").forEach(e=>s(e,v(e.poster))),document.querySelectorAll("img, input[type=image]").forEach(e=>{const t=e.src.trim();if(!t.startsWith("data:image/"))s(e,v(t))}),document.querySelectorAll("img[srcset], picture > source[srcset]").forEach(e=>{const t=[];let i,n=e.srcset.trim();while(null!==(i=T.exec(n)))t.push(i[1]),n=A(n,i.index,i[0].length);t.push(n.trim().replace(x,"")),t.forEach(t=>{if(""!==t)s(e,v(t))})});for(const e of E.image.keys())s(null,e);for(const s of E.rawData.values())if(!s.pathname){const{base64:i,content:n,filename:r,mimeType:o}=s;let l;if(i)l={pathname:"__generated__/base64",filename:r,base64:i};else if(n&&o)l={pathname:"__generated__/"+o.split("/").pop(),filename:r,content:n};else continue;if(this.validFile(l))l.mimeType=o,P.call(this,l,[],e),t.push(l)}return t}getVideoAssets(e){return this.getRawAssets("video",e)}getAudioAssets(e){return this.getRawAssets("audio",e)}getFontAssets(e){const t=[];for(const s of E.fonts.values())s.forEach(s=>{const i=s.srcUrl;if(i){const s=b(i);if(this.validFile(s))P.call(this,s,[],e),t.push(s)}});return t}validFile(e){if(e){const t=e.pathname+"/"+e.filename;return!this.outputFileExclusions.some(e=>e.test(t))}return false}getRawAssets(e,t){const s=[];return document.querySelectorAll(e).forEach(e=>{const i=new Map;_(i,e),e.querySelectorAll("source").forEach(e=>_(i,e));for(const[e,n]of i.entries()){const i=b(n);if(this.validFile(i))P.call(this,i,O(e),t),s.push(i)}}),s}getAssetsAll(e={}){if(true===e.saveAsWebPage)e=Object.assign(Object.assign({},e),{ignoreExtensions:true});const t=this.getHtmlPage(e).concat(this.getLinkAssets(e));if(e.saveAsWebPage)t.forEach(e=>{const t=e.mimeType;switch(t){case"text/html":case"text/css":case"application/xhtml+xml":e.mimeType="@"+t;break}});return t.concat(this.getScriptAssets(e)).concat(this.getImageAssets(e)).concat(this.getVideoAssets(e)).concat(this.getAudioAssets(e)).concat(this.getFontAssets(e))}get outputFileExclusions(){let e=this._outputFileExclusions;if(void 0===e)e=d(this.userSettings.outputFileExclusions,e=>function(e){return e=e.trim().replace(/([.|/\\{}()?])/g,(e,...t)=>"\\"+t[0]).replace(/\*/g,".*?"),new RegExp(e+"$")}(e)),this._outputFileExclusions=e;return e}get userSettings(){return this.resource.userSettings}get application(){return this.resource.application}}class N extends squared.base.Node{constructor(e,t,s){super(e,t,s),this._cached={},this._preferInitial=false,this.init()}}class R extends squared.base.Extension{processFile(e,t=false){return false}}const{safeNestedArray:C}=squared.lib.util;class I extends R{constructor(){super(...arguments),this.options={level:11,mimeTypes:["text/css","text/javascript","text/plain","text/csv","application/json","application/javascript","application/ld+json","application/xml"]}}processFile(e,t=false){if(!t){const s=e.mimeType;if(s){const e=this.options.mimeTypes;t="*"===e||e.includes(s)}}if(t)return C(e,"compress").push({format:"br",level:this.options.level}),true;else return false}}const{safeNestedArray:M}=squared.lib.util;class j extends R{constructor(){super(...arguments),this.options={level:9,mimeTypes:["text/css","text/javascript","text/plain","text/csv","application/json","application/javascript","application/ld+json","application/xml"]}}processFile(e,t=false){if(!t){const s=e.mimeType;if(s){const e=this.options.mimeTypes;t="*"===e||e.includes(s)}}if(t)return M(e,"compress").push({format:"gz",level:this.options.level}),true;else return false}}const{safeNestedArray:q}=squared.lib.util;class w extends R{constructor(){super(...arguments),this.options={level:100,mimeTypes:["image/jpeg"]}}processFile(e,t=false){if(!t){const s=e.mimeType;if(s){const e=this.options.mimeTypes;t=/[@%]jpeg:/.test(s)||Array.isArray(e)&&!!e.find(e=>s.endsWith(e))||"*"===e&&s.includes("image/")}}if(t)return q(e,"compress").push({format:"png"},{format:"jpeg",level:this.options.level}),true;else return false}}const{safeNestedArray:k}=squared.lib.util;class W extends R{constructor(){super(...arguments),this.options={mimeTypes:["image/png"]}}processFile(e,t=false){if(!t){const s=e.mimeType;if(s){const e=this.options.mimeTypes;t=/[@%]png:/.test(s)||Array.isArray(e)&&!!e.find(e=>s.endsWith(e))||"*"===e&&s.includes("image/")}}if(t)return k(e,"compress").push({format:"png"}),true;else return false}}class V extends R{constructor(){super(...arguments),this.options={mimeTypes:["image/png","image/jpeg","image/gif","image/tiff"],replaceWith:true,pickSmaller:false}}processFile(e,t=false){const s=e.mimeType;if(s){const i=this.options;if(t||i.mimeTypes.find(e=>s.endsWith(e))){let t="";if(i.replaceWith)t="@";else if(i.pickSmaller)t="%";return e.mimeType=t+"bmp:"+s,true}}return false}}class G extends R{constructor(){super(...arguments),this.options={mimeTypes:["image/png","image/bmp","image/gif","image/tiff"],replaceWith:true,pickSmaller:false}}processFile(e,t=false){const s=e.mimeType;if(s){const i=this.options;if(t||i.mimeTypes.find(e=>s.endsWith(e))){let t="";if(i.replaceWith)t="@";else if(i.pickSmaller)t="%";return e.mimeType=t+"jpeg:"+s,true}}return false}}class L extends R{constructor(){super(...arguments),this.options={mimeTypes:["image/jpeg","image/bmp","image/gif","image/tiff"],replaceWith:true,pickSmaller:false}}processFile(e,t=false){const s=e.mimeType;if(s){const i=this.options;if(t||i.mimeTypes.find(e=>s.endsWith(e))){let t="";if(i.replaceWith)t="@";else if(i.pickSmaller)t="%";return e.mimeType=t+"png:"+s,true}}return false}}class H extends R{constructor(){super(...arguments),this.options={mimeTypes:["image/png","image/jpeg","image/bmp","image/tiff"],replaceWith:true,pickSmaller:false}}processFile(e,t=false){const s=e.mimeType;if(s){const i=this.options;if(t||i.mimeTypes.find(e=>s.endsWith(e))){let t="";if(i.replaceWith)t="@";else if(i.pickSmaller)t="%";return e.mimeType=t+"gif:"+s,true}}return false}}class B extends R{constructor(){super(...arguments),this.options={mimeTypes:["image/png","image/jpeg","image/gif","image/bmp"],replaceWith:true,pickSmaller:false}}processFile(e,t=false){const s=e.mimeType;if(s){const i=this.options;if(t||i.mimeTypes.find(e=>s.endsWith(e))){let t="";if(i.replaceWith)t="@";else if(i.pickSmaller)t="%";return e.mimeType=t+"tiff:"+s,true}}return false}}const D={builtInExtensions:[],preloadImages:false,excludePlainText:true,createQuerySelectorMap:true,showErrorMessages:false,outputFileExclusions:[],outputEmptyCopyDirectory:false,outputArchiveName:"chrome-data",outputArchiveFormat:"zip"};var z=Object.freeze({__proto__:null});const J={COMPRESS_BROTLI:"chrome.compress.brotli",COMPRESS_GZIP:"chrome.compress.gzip",COMPRESS_PNG:"chrome.compress.png",COMPRESS_JPEG:"chrome.compress.jpeg",CONVERT_PNG:"chrome.convert.png",CONVERT_JPEG:"chrome.convert.jpeg",CONVERT_BMP:"chrome.convert.bmp",CONVERT_GIF:"chrome.convert.gif",CONVERT_TIFF:"chrome.convert.tiff"};var Z=Object.freeze({__proto__:null,EXT_CHROME:J});const{util:$,session:U}=squared.lib,{flatArray:X,isString:Q,isObject:K,promisify:Y}=$,{frameworkNotInstalled:ee}=U;let te,se,ie,ne,re=false;function oe(e,t){let s=function(e,t){if(t)return ne.get(e);else ne.clear()}(e,t);if(void 0===s)te.queryState=1,(async()=>{await te.parseDocument(e)})(),s=ne.get(e),te.queryState=0;return s||null}function le(e){te.queryState=2;let t=false;const s=e.length,i=new Array(s);if((async()=>{for(let n=0;n<s;++n){const s=e[n];let r=ne.get(s);if(r)i[n]=r;else if(await te.parseDocument(s),r=ne.get(s),r)i[n]=r;else t=true}})(),t)X(i);return te.queryState=0,i}function ae(e,t,s,i){if(K(t)){const s=t.assets;if(s)e=e.concat(s)}else t=void 0;return Object.assign(Object.assign({},t),{assets:e,directory:s,filename:i})}const ce={base:{Application:s,Controller:o,File:F,Resource:e,View:N},lib:{constant:Z,enumeration:z},extensions:{compress:{Brotli:I,Gzip:j,Jpeg:w,Png:W},convert:{Bmp:V,Gif:H,Jpeg:G,Png:L,Tiff:B}},system:{getElementById(e,t=true){if(te){const s=document.getElementById(e);if(s)return oe(s,t)}return null},querySelector(e,t=true){if(te){const s=document.querySelector(e);if(s)return oe(s,t)}return null},querySelectorAll(e,t=true){if(te){const s=document.querySelectorAll(e);if(s.length){if(!t)ne.clear();return le(s)}}return[]},getElement(e,t=false){if(te)return oe(e,t);else return null},getElementMap:()=>(null==se?void 0:se.elementMap)||new Map,clearElementMap(){null==se||se.elementMap.clear()},copyHtmlPage(e,t){if(Q(e))null==ie||ie.copying(ae(ie.getHtmlPage(t),t,e))},copyScriptAssets(e,t){if(Q(e))null==ie||ie.copying(ae(ie.getScriptAssets(t),t,e))},copyLinkAssets(e,t){if(Q(e))null==ie||ie.copying(ae(ie.getLinkAssets(t),t,e))},copyImageAssets(e,t){if(ie&&Q(e))ie.copying(ae(ie.getImageAssets(t),t,e))},copyVideoAssets(e,t){if(Q(e))null==ie||ie.copying(ae(ie.getVideoAssets(t),t,e))},copyAudioAssets(e,t){if(Q(e))null==ie||ie.copying(ae(ie.getAudioAssets(t),t,e))},copyFontAssets(e,t){if(Q(e))null==ie||ie.copying(ae(ie.getFontAssets(t),t,e))},saveHtmlPage(e,t){null==ie||ie.archiving(ae(ie.getHtmlPage(t),t,void 0,(e||te.userSettings.outputArchiveName)+"-html"))},saveScriptAssets(e,t){null==ie||ie.archiving(ae(ie.getScriptAssets(t),t,void 0,(e||te.userSettings.outputArchiveName)+"-script"))},saveLinkAssets(e,t){null==ie||ie.archiving(ae(ie.getLinkAssets(t),t,void 0,(e||te.userSettings.outputArchiveName)+"-link"))},saveImageAssets(e,t){null==ie||ie.archiving(ae(ie.getImageAssets(t),t,void 0,(e||te.userSettings.outputArchiveName)+"-image"))},saveVideoAssets(e,t){null==ie||ie.archiving(ae(ie.getVideoAssets(t),t,void 0,(e||te.userSettings.outputArchiveName)+"-video"))},saveAudioAssets(e,t){null==ie||ie.archiving(ae(ie.getAudioAssets(t),t,void 0,(e||te.userSettings.outputArchiveName)+"-audio"))},saveFontAssets(e,t){null==ie||ie.archiving(ae(ie.getFontAssets(t),t,void 0,(e||te.userSettings.outputArchiveName)+"-font"))}},create(){const t=J;return te=new s(4,N,o,e),se=te.controllerHandler,ie=new F,te.resourceHandler.setFileHandler(ie),ne=se.elementMap,Object.assign(te.builtInExtensions,{[t.COMPRESS_BROTLI]:new I(t.COMPRESS_BROTLI,4),[t.COMPRESS_GZIP]:new j(t.COMPRESS_GZIP,4),[t.COMPRESS_JPEG]:new w(t.COMPRESS_JPEG,4),[t.COMPRESS_PNG]:new W(t.COMPRESS_PNG,4),[t.CONVERT_BMP]:new V(t.CONVERT_BMP,4),[t.CONVERT_GIF]:new H(t.CONVERT_GIF,4),[t.CONVERT_JPEG]:new G(t.CONVERT_JPEG,4),[t.CONVERT_PNG]:new L(t.CONVERT_PNG,4),[t.CONVERT_TIFF]:new B(t.CONVERT_TIFF,4)}),re=true,{application:te,framework:4,userSettings:Object.assign({},D)}},cached(){if(re)return{application:te,framework:4,userSettings:te.userSettings};else return ce.create()},getElementById:(e,t=true)=>{if(te){const s=document.getElementById(e);if(s)return Y(oe)(s,t)}return ee()},querySelector:(e,t=true)=>{if(te){const s=document.querySelector(e);if(s)return Y(oe)(s,t)}return ee()},querySelectorAll:(e,t=true)=>{if(te){const s=document.querySelectorAll(e);if(s.length){if(!t)ne.clear();return Y(le)(s)}}return ee()},getElement:(e,t=false)=>{if(te)return Y(oe)(e,t);else return ee()},saveAsWebPage:(e,t)=>{if(ie){(t=!K(t)?{}:Object.assign({},t)).saveAsWebPage=true;const s=te.userSettings,i=s.preloadImages;return s.preloadImages=true,te.reset(),te.parseDocument(document.body).then(n=>(ie.saveToArchive(e||te.userSettings.outputArchiveName,t),s.preloadImages=i,n))}return ee()}};return ce}();
