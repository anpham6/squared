var chrome=function(){"use strict";class e extends squared.base.Resource{constructor(e,t){super(),this.application=e,this.cache=t,this.controllerSettings=e.controllerHandler.localSettings}get userSettings(){return this.application.userSettings}}const{isTextNode:t}=squared.lib.dom;class s extends squared.base.Application{constructor(){super(...arguments),this.builtInExtensions={},this.extensions=[],this.queryState=0}finalize(){}createNode(e){return new this.Node(this.nextId,this.processing.sessionId,e.element)}insertNode(e,s){if(t(e)){if(this.userSettings.excludePlainText)return;this.controllerHandler.applyDefaultStyles(e);const t=this.createNode({element:e});return s&&t.cssApply(s.textStyle),t}return this.createNode({element:e})}afterCreateCache(e){switch(this.queryState){case 1:this.controllerHandler.cacheElement(e);break;default:this.controllerHandler.cacheElementList(this.processing.cache)}}get length(){const t=e.ASSETS;let s=0;for(const e in t)s+=t[e].size;return s}}const i=squared.lib,{isTextNode:n}=i.dom,{setElementCache:r}=i.session;class o extends squared.base.Controller{constructor(e,t){super(),this.application=e,this.cache=t,this.localSettings={mimeType:{font:"*",image:"*",audio:"*",video:"*"}},this._elementMap=new Map}init(){}sortInitialCache(){}reset(){this._elementMap.clear()}applyDefaultStyles(e){n(e)&&r(e,"styleMap",this.sessionId,{position:"static",display:"inline",verticalAlign:"baseline",float:"none",clear:"none"})}includeElement(){return true}cacheElement(e){this._elementMap.set(e.element,e)}cacheElementList(e){const t=this._elementMap;e.each(e=>t.set(e.element,e))}get elementMap(){return this._elementMap}get userSettings(){return this.application.userSettings}}class l extends squared.base.ExtensionManager{}const a=squared.lib,{CHAR:c,COMPONENT:u,FILE:p,XML:m}=a.regex,{appendSeparator:h,convertWord:g,fromLastIndexOf:d,objectMap:f,parseMimeType:y,resolvePath:v,safeNestedArray:A,spliceString:S,trimEnd:E}=a.util,T=e.ASSETS,x=/\s*(.+?\.[^\s,]+).*?,\s*/,b=/\s+[0-9.][wx]$/;function _(e){const t=E(e,"/"),s=u.PROTOCOL.exec(t);if(s){let i,n="",r="",o="";const l=s[2],a=s[3],c=s[4],u=(e=1)=>(e>1&&(o=c.substring(0,e)),c.substring(e,c.lastIndexOf("/")));let p=true;if(t.startsWith(E(location.origin,"/"))||(n=g(l)+(a?"/"+a.substring(1):"")+"/",p=false),c&&"/"!==c)if(r=d(c,"/"),p){const e=location.pathname.substring(0,location.pathname.lastIndexOf("/")+1);c.startsWith(e)?n=u(e.length):(i="__serverroot__",n=u())}else n+=u();else r="index.html";const m=r.includes(".")?d(r,".").toLowerCase():void 0;return{uri:e,rootDir:o,moveTo:i,pathname:n,filename:r,extension:m,mimeType:m&&y(m)}}}function O(e,t){const s=v(t);""!==s&&e.add(s)}function P(e){this.application.extensions.forEach(t=>t.processFile(e))}class F extends squared.base.File{reset(){super.reset(),this._outputFileExclusions=void 0}copyToDisk(e,t){this.copying(Object.assign(Object.assign({},t),{assets:this.getAssetsAll().concat((null==t?void 0:t.assets)||[]),directory:e}))}appendToArchive(e,t){this.archiving(Object.assign(Object.assign({filename:this.userSettings.outputArchiveName},t),{assets:this.getAssetsAll(t).concat((null==t?void 0:t.assets)||[]),appendTo:e}))}saveToArchive(e,t){this.archiving(Object.assign(Object.assign({},t),{assets:this.getAssetsAll(t).concat((null==t?void 0:t.assets)||[]),filename:e}))}getHtmlPage(e,t=false){const s=[],i=_(location.href);if(i){if(e)i.filename=e;else{const e=i.filename;p.NAME.test(e)||(i.pathname=h(i.pathname,e),i.filename="index.html")}this.validFile(i)&&(i.mimeType=y("html"),t||P.bind(this,i)(),s.push(i))}return s}getScriptAssets(e=false){const t=[];return document.querySelectorAll("script").forEach(s=>{const i=s.src.trim();if(""!==i){const n=v(i),r=_(n);this.validFile(r)&&(r.mimeType=s.type.trim()||y(n)||"text/javascript",e||P.bind(this,r)(),t.push(r))}}),t}getLinkAssets(e,t=false){const s=[];return document.querySelectorAll(e?`link[rel="${e}"]`:"link").forEach(e=>{const i=e.href.trim();if(""!==i){const n=v(i),r=_(n);if(this.validFile(r)){switch(e.rel.trim()){case"stylesheet":r.mimeType="text/css";break;case"icon":r.mimeType="image/x-icon";break;default:r.mimeType=e.type.trim()||y(n)}t||P.bind(this,r)(),s.push(r)}}}),s}getImageAssets(t=false){const s=[],i=e=>{if(""!==e){const i=_(e);this.validFile(i)&&(t||P.bind(this,i)(),s.push(i))}};if(this.userSettings.preloadImages)for(const e of T.image.keys())i(e);else document.querySelectorAll("picture > source").forEach(e=>e.srcset.split(m.SEPARATOR).forEach(e=>i(v(e.split(c.SPACE)[0])))),document.querySelectorAll("video").forEach(e=>i(v(e.poster))),document.querySelectorAll("img, input[type=image]").forEach(e=>{const t=e.src.trim();t.startsWith("data:image/")||i(v(t))});for(const[e,i]of T.rawData){const n=i.filename;if(n){const{pathname:r,base64:o,content:l,mimeType:a}=i;let c;if(r)c={pathname:r,filename:n,uri:e};else if(o)c={pathname:"__generated__/base64",filename:n,base64:o};else{if(!l||!a)continue;c={pathname:"__generated__/"+a.split("/").pop(),filename:n,content:l}}this.validFile(c)&&(c.mimeType=a,t||P.bind(this,c)(),s.push(c))}}return document.querySelectorAll("img[srcset], picture > source[srcset]").forEach(e=>{const t=[];let i,n=e.srcset.trim();while(null!==(i=x.exec(n)))t.push(v(i[1])),n=S(n,i.index,i[0].length);n=n.trim(),""!==n&&t.push(v(n.replace(b,""))),t.forEach(e=>{if(u.PROTOCOL.test(e)&&-1===s.findIndex(t=>t.uri===e)){const t=_(e);this.validFile(t)&&s.push(t)}})}),this.userSettings.compressImages&&s.forEach(t=>{e.canCompressImage(t.filename)&&A(t,"compress").unshift({format:"png"})}),s}getVideoAssets(e=false){return this.getRawAssets("video",e)}getAudioAssets(e=false){return this.getRawAssets("audio",e)}getFontAssets(e=false){const t=[];for(const s of T.fonts.values())s.forEach(s=>{const i=s.srcUrl;if(i){const s=_(i);this.validFile(s)&&(e||P.bind(this,s)(),t.push(s))}});return t}validFile(e){if(e){const t=`${e.pathname}/${e.filename}`;return!this.outputFileExclusions.some(e=>e.test(t))}return false}getRawAssets(e,t=false){const s=[];return document.querySelectorAll(e).forEach(e=>{const i=new Set;O(i,e.src),e.querySelectorAll("source").forEach(e=>O(i,e.src));for(const e of i){const i=_(e);this.validFile(i)&&(t||P.bind(this,i)(),s.push(i))}}),s}getAssetsAll(e={}){const{name:t,rel:s}=e,i=true===e.saveAsWebPage,n=this.getHtmlPage(t,i).concat(this.getLinkAssets(s,i));return i&&n.forEach(e=>{const t=e.mimeType;switch(t){case"text/html":case"text/css":case"application/xhtml+xml":e.mimeType="@"+t}}),n.concat(this.getScriptAssets(i)).concat(this.getImageAssets(i)).concat(this.getVideoAssets(i)).concat(this.getAudioAssets(i)).concat(this.getFontAssets(i))}get outputFileExclusions(){let e=this._outputFileExclusions;return void 0===e&&(e=f(this.userSettings.outputFileExclusions,e=>function(e){return e=e.trim().replace(/([.|/\\{}()?])/g,(e,...t)=>"\\"+t[0]).replace(/\*/g,".*?"),new RegExp(e+"$")}(e)),this._outputFileExclusions=e),e}get userSettings(){return this.resource.userSettings}get application(){return this.resource.application}}class N extends squared.base.Node{constructor(e,t,s,i){super(e,t,s),this._cached={},this._preferInitial=false,this.init(),i&&i(this)}}class I extends squared.base.Extension{processFile(e){return false}}const{safeNestedArray:q}=squared.lib.util;class C extends I{constructor(){super(...arguments),this.options={level:11,mimeTypes:["text/css","text/javascript","text/plain","text/csv","application/json","application/javascript","application/ld+json","application/xml"]}}processFile(e){const t=e.mimeType;if(t){const{level:s,mimeTypes:i}=this.options;if("*"===i||i.includes(t))return q(e,"compress").push({format:"br",level:s}),true}return false}}const{safeNestedArray:R}=squared.lib.util;class M extends I{constructor(){super(...arguments),this.options={level:9,mimeTypes:["text/css","text/javascript","text/plain","text/csv","application/json","application/javascript","application/ld+json","application/xml"]}}processFile(e){const t=e.mimeType;if(t){const{level:s,mimeTypes:i}=this.options;if("*"===i||i.includes(t))return R(e,"compress").push({format:"gz",level:s}),true}return false}}const{safeNestedArray:w}=squared.lib.util;class j extends I{constructor(){super(...arguments),this.options={level:100,mimeTypes:["image/jpeg"]}}processFile(e){const t=e.mimeType;if(t){const{level:s,mimeTypes:i}=this.options;if("*"===i&&t.startsWith("image/")||i.includes(t))return w(e,"compress").push({format:"jpeg",level:s}),true}return false}}const{safeNestedArray:k}=squared.lib.util;class V extends I{constructor(){super(...arguments),this.options={mimeTypes:["image/png"]}}processFile(e){const t=e.mimeType;if(t){const s=this.options.mimeTypes;if("*"===s&&t.startsWith("image/")||s.includes(t))return k(e,"compress").push({format:"png"}),true}return false}}class G extends I{constructor(){super(...arguments),this.options={mimeTypes:["image/png","image/jpeg","image/gif","image/tiff"],replaceWith:true,pickSmaller:false}}processFile(e){const t=e.mimeType;if(t){const s=this.options;if(s.mimeTypes.includes(t)){let i="";return s.replaceWith?i="@":s.pickSmaller&&(i="%"),e.mimeType=i+"bmp:"+t,true}}return false}}class W extends I{constructor(){super(...arguments),this.options={mimeTypes:["image/png","image/bmp","image/gif","image/tiff"],replaceWith:true,pickSmaller:false}}processFile(e){const t=e.mimeType;if(t){const s=this.options;if(s.mimeTypes.includes(t)){let i="";return s.replaceWith?i="@":s.pickSmaller&&(i="%"),e.mimeType=i+"jpeg:"+t,true}}return false}}class L extends I{constructor(){super(...arguments),this.options={mimeTypes:["image/jpeg","image/bmp","image/gif","image/tiff"],replaceWith:true,pickSmaller:false}}processFile(e){const t=e.mimeType;if(t){const s=this.options;if(s.mimeTypes.includes(t)){let i="";return s.replaceWith?i="@":s.pickSmaller&&(i="%"),e.mimeType=i+"png:"+t,true}}return false}}class H extends I{constructor(){super(...arguments),this.options={mimeTypes:["image/png","image/jpeg","image/bmp","image/tiff"],replaceWith:true,pickSmaller:false}}processFile(e){const t=e.mimeType;if(t){const s=this.options;if(s.mimeTypes.includes(t)){let i="";return s.replaceWith?i="@":s.pickSmaller&&(i="%"),e.mimeType=i+"gif:"+t,true}}return false}}class B extends I{constructor(){super(...arguments),this.options={mimeTypes:["image/png","image/jpeg","image/gif","image/bmp"],replaceWith:true,pickSmaller:false}}processFile(e){const t=e.mimeType;if(t){const s=this.options;if(s.mimeTypes.includes(t)){let i="";return s.replaceWith?i="@":s.pickSmaller&&(i="%"),e.mimeType=i+"tiff:"+t,true}}return false}}const D={builtInExtensions:[],preloadImages:false,compressImages:false,excludePlainText:true,createQuerySelectorMap:true,showErrorMessages:false,outputFileExclusions:["squared.*","chrome.framework.*"],outputEmptyCopyDirectory:false,outputArchiveName:"chrome-data",outputArchiveFormat:"zip"};var z=Object.freeze({__proto__:null});const J={COMPRESS_BROTLI:"chrome.compress.brotli",COMPRESS_GZIP:"chrome.compress.gzip",COMPRESS_PNG:"chrome.compress.png",COMPRESS_JPEG:"chrome.compress.jpeg",CONVERT_PNG:"chrome.convert.png",CONVERT_JPEG:"chrome.convert.jpeg",CONVERT_BMP:"chrome.convert.bmp",CONVERT_GIF:"chrome.convert.gif",CONVERT_TIFF:"chrome.convert.tiff"};var $=Object.freeze({__proto__:null,EXT_CHROME:J}),Z=function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{a(i.next(e))}catch(e){r(e)}}function l(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,l)}a((i=i.apply(e,t||[])).next())}))};const{flatArray:X,isString:Q,isObject:U}=squared.lib.util;let K,Y,ee,te,se,ie=false;function ne(e,t){if(t)return se.get(e);se.clear()}function re(e,t){let s=ne(e,t);return void 0===s&&(K.queryState=1,K.parseDocument(e),s=se.get(e),K.queryState=0),s||null}function oe(e,t){return Z(this,void 0,void 0,(function*(){let s=ne(e,t);return void 0===s&&(K.queryState=1,yield K.parseDocumentAsync(e),s=se.get(e),K.queryState=0),s||null}))}function le(e,t,s,i){if(U(t)){const s=t.assets;s&&(e=e.concat(s))}else t=void 0;return Object.assign(Object.assign({},t),{assets:e,directory:s,filename:i})}const ae={base:{Application:s,ExtensionManager:l,Controller:o,File:F,Resource:e,View:N},lib:{constant:$,enumeration:z},extensions:{compress:{Brotli:C,Gzip:M,Jpeg:j,Png:V},convert:{Bmp:G,Gif:H,Jpeg:W,Png:L,Tiff:B}},system:{getElementById(e,t=true){if(K){const s=document.getElementById(e);if(s)return re(s,t)}return null},querySelector(e,t=true){if(K){const s=document.querySelector(e);if(s)return re(s,t)}return null},querySelectorAll(e,t=true){if(K){const s=document.querySelectorAll(e);if(s.length)return t||se.clear(),function(e){K.queryState=2;let t=false;const s=e.length,i=new Array(s);for(let n=0;n<s;++n){const s=e[n];let r=se.get(s);r?i[n]=r:(K.parseDocument(s),r=se.get(s),r?i[n]=r:t=true)}return t&&X(i),K.queryState=0,i}(s)}return[]},getElement:(e,t=false)=>K?re(e,t):null,getElementMap:()=>(null==Y?void 0:Y.elementMap)||new Map,clearElementMap(){null==Y||Y.elementMap.clear()},copyHtmlPage(e,t){Q(e)&&(null==ee||ee.copying(le(ee.getHtmlPage(null==t?void 0:t.name),t,e)))},copyScriptAssets(e,t){Q(e)&&(null==ee||ee.copying(le(ee.getScriptAssets(),t,e)))},copyLinkAssets(e,t){Q(e)&&(null==ee||ee.copying(le(ee.getLinkAssets(null==t?void 0:t.rel),t,e)))},copyImageAssets(e,t){ee&&Q(e)&&ee.copying(le(ee.getImageAssets(),t,e))},copyVideoAssets(e,t){Q(e)&&(null==ee||ee.copying(le(ee.getVideoAssets(),t,e)))},copyAudioAssets(e,t){Q(e)&&(null==ee||ee.copying(le(ee.getAudioAssets(),t,e)))},copyFontAssets(e,t){Q(e)&&(null==ee||ee.copying(le(ee.getFontAssets(),t,e)))},saveHtmlPage(e,t){null==ee||ee.archiving(le(ee.getHtmlPage(null==t?void 0:t.name),t,void 0,(e||te.outputArchiveName)+"-html"))},saveScriptAssets(e,t){null==ee||ee.archiving(le(ee.getScriptAssets(),t,void 0,(e||te.outputArchiveName)+"-script"))},saveLinkAssets(e,t){null==ee||ee.archiving(le(ee.getLinkAssets(null==t?void 0:t.rel),t,void 0,(e||te.outputArchiveName)+"-link"))},saveImageAssets(e,t){null==ee||ee.archiving(le(ee.getImageAssets(),t,void 0,(e||te.outputArchiveName)+"-image"))},saveVideoAssets(e,t){null==ee||ee.archiving(le(ee.getVideoAssets(),t,void 0,(e||te.outputArchiveName)+"-video"))},saveAudioAssets(e,t){null==ee||ee.archiving(le(ee.getAudioAssets(),t,void 0,(e||te.outputArchiveName)+"-audio"))},saveFontAssets(e,t){null==ee||ee.archiving(le(ee.getFontAssets(),t,void 0,(e||te.outputArchiveName)+"-font"))}},create(){const t=J;return K=new s(4,N,o,e,l),Y=K.controllerHandler,ee=new F,K.resourceHandler.setFileHandler(ee),se=Y.elementMap,te=Object.assign({},D),Object.assign(K.builtInExtensions,{[t.COMPRESS_BROTLI]:new C(t.COMPRESS_BROTLI,4),[t.COMPRESS_GZIP]:new M(t.COMPRESS_GZIP,4),[t.COMPRESS_JPEG]:new j(t.COMPRESS_JPEG,4),[t.COMPRESS_PNG]:new V(t.COMPRESS_PNG,4),[t.CONVERT_BMP]:new G(t.CONVERT_BMP,4),[t.CONVERT_GIF]:new H(t.CONVERT_GIF,4),[t.CONVERT_JPEG]:new W(t.CONVERT_JPEG,4),[t.CONVERT_PNG]:new L(t.CONVERT_PNG,4),[t.CONVERT_TIFF]:new B(t.CONVERT_TIFF,4)}),ie=true,{application:K,framework:4,userSettings:te}},cached:()=>ie?{application:K,framework:4,userSettings:te}:ae.create(),getElementById:(e,t=true)=>Z(void 0,void 0,void 0,(function*(){if(K){const s=document.getElementById(e);if(s)return yield oe(s,t)}return null})),querySelector:(e,t=true)=>Z(void 0,void 0,void 0,(function*(){if(K){const s=document.querySelector(e);if(s)return yield oe(s,t)}return null})),querySelectorAll:(e,t=true)=>Z(void 0,void 0,void 0,(function*(){if(K){const s=document.querySelectorAll(e);if(s.length)return t||se.clear(),yield function(e){return Z(this,void 0,void 0,(function*(){let t=false;const s=e.length,i=new Array(s);return yield(()=>Z(this,void 0,void 0,(function*(){for(let n=0;n<s;++n){const s=e[n],r=se.get(s);r?i[n]=r:(K.queryState=2,yield K.parseDocumentAsync(s).then(()=>{const e=se.get(s);e?i[n]=e:t=true}))}})))(),t&&X(i),K.queryState=0,i}))}(s)}return null})),getElement:(e,t=false)=>Z(void 0,void 0,void 0,(function*(){return K?yield oe(e,t):null})),saveAsWebPage:(e,t)=>Z(void 0,void 0,void 0,(function*(){if(ee){U(t)||(t={}),t.saveAsWebPage=true;const s=te.preloadImages;te.preloadImages=true,yield K.parseDocumentAsync(document.body).then(()=>{ee.saveToArchive(e||te.outputArchiveName,t),te.preloadImages=s})}}))};return ae}();
