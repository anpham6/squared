!function(e,s){"object"==typeof exports&&"undefined"!=typeof module?module.exports=s():"function"==typeof define&&define.amd?define(s):(e="undefined"!=typeof globalThis?globalThis:e||self).chrome=s()}(this,(function(){"use strict";const{UNABLE_TO_FINALIZE_DOCUMENT:e,reject:s}=squared.lib.error,{isPlainObject:t}=squared.lib.util;class Application extends squared.base.Application{constructor(){super(...arguments),this.extensions=[],this.systemName="chrome"}init(){this.session.unusedStyles=new Set}reset(){this.session.unusedStyles.clear(),super.reset()}insertNode(e,s){if("#"===e.nodeName[0]){if(this.userSettings.excludePlainText)return;this.controllerHandler.applyDefaultStyles(e,s)}return this.createNode(s,{element:e})}saveAs(e,s){return this.processAssets("saveAs",e||this.userSettings.outputArchiveName,s)}copyTo(e,s){return this.processAssets("copyTo",e,s)}appendTo(e,s){return this.processAssets("appendTo",e,s)}processAssets(i,n,r){(r=t(r)?Object.assign({},r):{}).saveAsWebPage=!0,this.reset();const o=undefined;if(!this.parseDocumentSync())return s(e);if(r.removeUnusedStyles){const e=Array.from(this.session.unusedStyles);e.length&&(r.unusedStyles=r.unusedStyles?Array.from(new Set(r.unusedStyles.concat(e))):e)}return this.fileHandler[i](n,r)}get initializing(){return!1}get length(){return 1}}const i=e=>"("+Math.max(e.largerThan,0)+","+(e.smallerThan<1/0?e.smallerThan:"*")+")";class Extension extends squared.base.Extension{static getCompressOptions(e){const s=(e.whenSmaller?"%":"")+i(e);if("(0,*)"!==s)return s}static getConvertOptions(e,s){const t=s.opacity||1;let n="";return s.replaceWith?n+="@":s.whenSmaller&&(n+="%"),n+=i(s),e+("(0,*)"!==n?n:"")+(t>0&&t<1?`|${t}|`:"")+":"}processFile(e,s){return!1}}var n=squared.lib.base.Pattern;const{FILE:r}=squared.lib.regex,o=squared.base.Resource.ASSETS,{convertWord:a,fromLastIndexOf:l,isString:c,iterateReverseArray:p,parseMimeType:m,resolvePath:u,splitPair:h,splitPairStart:g,trimEnd:f}=squared.lib.util,{appendSeparator:d,randomUUID:v}=squared.base.lib.util,y="__serverroot__",T=/([.|/\\{}()?])/g,A=new n(/\s*(.+?\.[^\s,]+)(\s+[\d.]+[wx]\s*)?,?/g);function x(e,s){if(s){const t=new RegExp(e+':\\s*((?:[^"]|\\\\")+)').exec(s.replace(/\\/g,"/"));if(t){const e=t[1].split("::").map((e=>e.trim()));return[e[0],e[1]||void 0,"preserve"===e[2]]}}}function S(e,s){let t;if("/"===(e=e.replace(/\\/g,"/"))[0])t=y;else if(e.startsWith("../")){t=y;const s=location.pathname.split("/");if(--s.length)for(let t=0,i=e.length;t<i&&("../"===e.substring(t,t+3)&&0!=--s.length);t+=3);e=`${s.join("/")}/${e.split("../").pop()}`}else e.startsWith("./")&&(e=e.substring(2));const i=h(e,"/",!1,!0);if(s){const e=P(i[1]);i[1]=v()+(e?"."+e:"")}return[t,i[0],i[1]]}function b(e,s){const t=u(e instanceof HTMLObjectElement?e.data:e.src);t&&s.set(e,t)}function E(e){return e=e.replace(T,((e,...s)=>"\\"+s[0])).replace(/\*/g,".*?"),new RegExp(e+"$")}function w(e){if(e){const s=e.dataset,t=s.useChrome||s.use;if(t)return t.trim().split(/\s*,\s*/)}return[]}function F(e,s){const t=[];for(const s of this.application.extensions)s.processFile(e)&&t.push(s);for(const i of s){const s=this.application.extensionManager.get(i,!0);s&&!t.includes(s)&&s.processFile(e,!0)}}function O(e){for(const s in e){const t=e[s],i=t.length;if(i>1)for(let e=0;e<i;++e)t[e].bundleIndex=e}}function C(e,s,t,i,n){const r=s.innerHTML.trim();if(r){const[s,o,a]=S(t),l=undefined;if(p(e,(e=>{if((e.moveTo===s||!e.moveTo&&!s)&&e.pathname===o&&e.filename===a)return(e.trailingContent||(e.trailingContent=[])).push({value:r,format:i,preserve:n}),!0}))!==1/0)return{uri:u(t,location.href),pathname:o,filename:a,moveTo:s,content:r,format:i,preserve:n}}return null}function j(e,s){const t=(s.moveTo||"")+s.pathname+s.filename;(e[t]||(e[t]=[])).push(s)}function q(e,s){return 0===e.bundleIndex?1:0===s.bundleIndex?-1:0}const P=e=>e.includes(".")?l(e,".").toLowerCase():"",M=(e,s)=>e.substring(s,e.lastIndexOf("/"));class File extends squared.base.File{static parseUri(e,s){let t,i,n,o;s&&({saveAs:t,format:i,saveTo:n,preserve:o}=s);let c=f(e,"/"),p;const h=c.startsWith(f(location.origin,"/"));if(t){if(t=f(t.replace(/\\/g,"/"),"/"),n)p=t;else{const e=x("saveAs",t);e?[p,i,o]=e:p=t}h&&p&&(c=u(p,location.href))}if(!h&&!p&&s&&s.preserveCrossOrigin)return null;const d=r.PROTOCOL.exec(c);if(d){const s=d[2],t=d[3],r=d[4]||"",c=P(e);let u="",f="",T="",A,x;if(h){T=g(location.pathname,"/",!1,!0)+"/";let e=r.length;if(e){let s=0;e=Math.min(e,T.length);for(let t=0;t<e&&r[t]===T[t];++t)s=t;A=r.substring(0,s+1)}}else n&&p?[x,u,f]=S(`${p}/${v()+(c?"."+c:"")}`):u=a(s)+(t?"/"+t.substring(1):"")+"/";return f||(h&&p?[x,u,f]=S(p,n):r&&"/"!==r?(f=l(r,"/","\\"),h?r.startsWith(T)?u=M(r,T.length):(x=y,A="",u=M(r,0)):u+=M(r,1)):f="index.html"),{uri:e,rootDir:A,moveTo:x,pathname:u.replace(/\\/g,"/"),filename:f,mimeType:c&&m(c),format:i,preserve:o}}return null}reset(){delete this._outputFileExclusions,super.reset()}copyTo(e,s={}){return s.directory=e,this.copying(this.processAssets(s))}appendTo(e,s={}){return s.filename||(s.filename=this.userSettings.outputArchiveName),s.appendTo=e,this.archiving(this.processAssets(s))}saveAs(e,s={}){return s.filename=e,this.archiving(this.processAssets(s))}getHtmlPage(e){var s;let t,i,n;e&&(({name:t,preserveCrossOrigin:i}=e),n=null===(s=e.saveAs)||void 0===s?void 0:s.html);const o=[],a=document.querySelector("html"),p=location.href;let u,h;a&&(u=a.dataset.chromeFile),!c(u)&&n&&n.filename&&(u=l(n.filename,"/","\\"),h=n.format);const g=File.parseUri(p,{preserveCrossOrigin:i,saveAs:u,format:h});if(g){if(t)g.filename=t;else{const e=g.filename;r.NAME.test(e)||(g.pathname=d(g.pathname,e),g.filename="index.html")}this.validFile(g)&&(g.requestMain=!0,g.mimeType=m("html"),F.call(this,g,w(document.querySelector("html"))),o.push(g))}return o}getScriptAssets(e){var s;let t,i;e&&(t=e.preserveCrossOrigin,i=null===(s=e.saveAs)||void 0===s?void 0:s.script);const n=[],r={},o={html:{},js:{},css:{}};return document.querySelectorAll("script").forEach((e=>{var s;const a=e.dataset.chromeTemplate;if(a){if("text/template"===e.type){const[t,i,n]=a.split("::").map(((e,s)=>(0===s?e.toLowerCase():e).trim()));if(t&&i&&n)switch(t){case"html":case"js":case"css":((s=o[t])[i]||(s[i]={}))[n]=e.textContent.trim()}}}else{let s=e.dataset.chromeFile;if("exclude"!==s){const o=e.src.trim();let a=null,l,p,h;if(!c(s)&&i&&i.filename&&(s=d(i.pathname,i.filename),l=i.format,p=e.outerHTML),o)a=File.parseUri(u(o),{preserveCrossOrigin:t,saveAs:s,format:l});else if(c(s)){if(!p){const e=x("exportAs",s);e&&([s,l,h]=e)}s&&(a=C(n,e,s,l,h))}this.validFile(a)&&(j(r,a),a.mimeType=e.type.trim()||a.uri&&m(a.uri)||"text/javascript",p&&(a.outerHTML=p),F.call(this,a,w(e)),n.push(a))}}})),O(r),[n.sort(q),o]}getLinkAssets(e){var s;let t,i,n;e&&(({rel:t,preserveCrossOrigin:n}=e),i=null===(s=e.saveAs)||void 0===s?void 0:s.link);const r=[],a={};document.querySelectorAll((t?`link[rel="${t}"]`:"link")+", style").forEach((e=>{let s=e.dataset.chromeFile;if("exclude"!==s){let t=null,o,l,p,h,g;if(e instanceof HTMLLinkElement&&(o=e.href.trim(),o))switch(e.rel.trim()){case"stylesheet":l="text/css";break;case"icon":l="image/x-icon";break;default:l=e.type.trim()||m(o)}if(!c(s)&&i&&i.filename&&("text/css"===l||e instanceof HTMLStyleElement)&&(s=d(i.pathname,i.filename),({format:p,preserve:h}=i),g=e.outerHTML),o)t=File.parseUri(u(o),{preserveCrossOrigin:n,saveAs:s,format:p,preserve:h});else if(c(s)){if(!g){const e=x("exportAs",s);e&&([s,p,h]=e)}s&&(t=C(r,e,s,p,h))}this.validFile(t)&&(j(a,t),t.mimeType=l||"text/css",g&&(t.outerHTML=g),F.call(this,t,w(e)),r.push(t))}}));for(const e of o.rawData){const s=e[1];if("text/css"===s.mimeType){const t=File.parseUri(u(e[0]),{preserveCrossOrigin:n,format:i&&i.format});this.validFile(t)&&(t.mimeType=s.mimeType,F.call(this,t,[]),r.push(t))}}return O(a),r.sort(q)}getImageAssets(e){var s;let t,i;e&&(t=e.preserveCrossOrigin,i=null===(s=e.saveAs)||void 0===s?void 0:s.base64);const n=[],r=(e,s,i)=>{if(s=s.trim()){let r,o;if(e){const s=x("saveTo",e.dataset.chromeFile);s&&([r,i]=s,o=!0)}const a=File.parseUri(s,{preserveCrossOrigin:t,saveAs:r,saveTo:o});if(this.validFile(a)&&!n.find((e=>e.uri===s)))return i&&(a.mimeType=r&&a.mimeType?i+":"+a.mimeType:i),F.call(this,a,w(e)),n.push(a),a}};document.querySelectorAll("video").forEach((e=>r(null,u(e.poster)))),document.querySelectorAll("picture > source").forEach((e=>{for(const s of e.srcset.trim().split(","))r(e,u(g(s," ")))})),document.querySelectorAll("img, input[type=image]").forEach((e=>{const s=e.src.trim();s.startsWith("data:image/")||r(e,u(s))})),document.querySelectorAll("img[srcset], picture > source[srcset]").forEach((e=>{for(A.matcher(e.srcset.trim());A.find();)r(e,u(A.group(1)))})),document.querySelectorAll("object, embed").forEach((e=>{const s=e.data||e.src;s&&(e.type.startsWith("image/")||m(s).startsWith("image/"))&&r(e,s)}));for(const e of o.image.keys())r(null,e);for(const e of o.rawData.values())if(!e.pathname){const{base64:s,filename:t}=e;let o=e.mimeType,a;if(s){if(i){const e=i.format;if(e&&o&&o.startsWith("image/"))switch(e){case"png":case"jpeg":case"bmp":case"gif":case"tiff":o="@"+e+":"+o}const n=f(i.pathname||"","/").replace(/\\/g,"/");if(a=r(null,u(S(n+(n?"/":"")+t)[1]+t,location.href),o),a){a.base64=s;continue}}a={pathname:"__generated__/base64",filename:t,mimeType:o,base64:s}}else{if(!o||!e.content)continue;a={pathname:"__generated__/"+o.split("/").pop(),filename:t,content:e.content}}this.validFile(a)&&(a.mimeType=o,F.call(this,a,[]),n.push(a))}return n}getVideoAssets(e){return this.getRawAssets("video",e)}getAudioAssets(e){return this.getRawAssets("audio",e)}getFontAssets(e){const s=e&&e.preserveCrossOrigin,t=[];for(const e of o.fonts.values())for(let i=0,n=e.length;i<n;++i){const n=e[i].srcUrl;if(n){const e=File.parseUri(n,{preserveCrossOrigin:s});this.validFile(e)&&(F.call(this,e,[]),t.push(e))}}return t}getDataMap(e){return{unusedStyles:e.unusedStyles,transpileMap:e.transpileMap}}getCopyQueryParameters(e){return e.productionRelease?"&release=1":""}getArchiveQueryParameters(e){return e.productionRelease?"&release=1":""}validFile(e){if(e){const s=d(e.pathname,e.filename);return!this.outputFileExclusions.some((e=>e.test(s)))}return!1}getRawAssets(e,s){const t=s&&s.preserveCrossOrigin,i=[];return document.querySelectorAll(e).forEach((e=>{var s;const n=new Map;switch(b(e,n),e.tagName){case"VIDEO":case"AUDIO":e.querySelectorAll("source, track").forEach((e=>b(e,n)))}for(const e of n){const n=null===(s=x("saveTo",e[0].dataset.chromeFile))||void 0===s?void 0:s[0],r=File.parseUri(e[1],{preserveCrossOrigin:t,saveAs:n,saveTo:!!n});this.validFile(r)&&(F.call(this,r,w(e[0])),i.push(r))}})),i}processAssets(e){const s=this.getHtmlPage(e).concat(this.getLinkAssets(e));if(e.saveAsWebPage)for(let e=0,t=s.length;e<t;++e){const t=s[e],i=t.mimeType;switch(i){case"text/html":case"application/xhtml+xml":case"text/css":t.mimeType="@"+i}}const[t,i]=this.getScriptAssets(e);return s.push(...t,...this.getImageAssets(e),...this.getVideoAssets(e),...this.getAudioAssets(e),...this.getRawAssets("object",e),...this.getRawAssets("embed",e),...this.getFontAssets(e)),e.assets=s,e.transpileMap=i,e}get outputFileExclusions(){return this._outputFileExclusions||(this._outputFileExclusions=this.userSettings.outputFileExclusions.map((e=>E(e))))}get application(){return this.resource.application}get userSettings(){return this.resource.userSettings}}class Brotli extends Extension{constructor(){super(...arguments),this.options={mimeTypes:new Set(["text/css","text/javascript","text/plain","text/csv","text/vtt","application/json","application/javascript","application/ld+json","application/xml"]),largerThan:0,smallerThan:1/0,whenSmaller:!0,level:11}}processFile(e,s){if(!s){const t=e.mimeType;if(t){const e=this.options.mimeTypes;s="*"===e||e.has(t)}}return!!s&&((e.compress||(e.compress=[])).push({format:"br",level:this.options.level,condition:Extension.getCompressOptions(this.options)}),!0)}}class Gzip extends Extension{constructor(){super(...arguments),this.options={mimeTypes:new Set(["text/css","text/javascript","text/plain","text/csv","text/vtt","application/json","application/javascript","application/ld+json","application/xml"]),largerThan:0,smallerThan:1/0,whenSmaller:!0,level:9}}processFile(e,s){if(!s){const t=e.mimeType;if(t){const e=this.options.mimeTypes;s="*"===e||e.has(t)}}return!!s&&((e.compress||(e.compress=[])).push({format:"gz",level:this.options.level,condition:Extension.getCompressOptions(this.options)}),!0)}}const{findSet:W}=squared.lib.util;class Jpeg extends Extension{constructor(){super(...arguments),this.options={mimeTypes:new Set(["image/jpeg"]),largerThan:0,smallerThan:1/0,whenSmaller:!0,level:100}}processFile(e,s){if(!s){const t=e.mimeType;if(t){const e=this.options.mimeTypes;s=t.includes("jpeg:")||("*"===e?t.includes("image/"):!!W(e,(e=>t.endsWith(e))))}}return!!s&&((e.compress||(e.compress=[])).push({format:"png",condition:Extension.getCompressOptions(this.options)},{format:"jpeg",level:this.options.level}),!0)}}const{findSet:L}=squared.lib.util;class Png extends Extension{constructor(){super(...arguments),this.options={mimeTypes:new Set(["image/png"]),largerThan:0,smallerThan:1/0,whenSmaller:!0}}processFile(e,s){if(!s){const t=e.mimeType;if(t){const e=this.options.mimeTypes;s=t.includes("png:")||"*"===e?t.includes("image/"):!!L(e,(e=>t.endsWith(e)))}}return!!s&&((e.compress||(e.compress=[])).push({format:"png",condition:Extension.getCompressOptions(this.options)}),!0)}}const{findSet:I}=squared.lib.util;class Bmp extends Extension{constructor(){super(...arguments),this.options={mimeTypes:new Set(["image/png","image/jpeg","image/gif","image/tiff"]),largerThan:0,smallerThan:1/0,whenSmaller:!1,replaceWith:!0}}processFile(e,s){const t=e.mimeType;return!(!t||/bmp[(%@:]/.test(t)||!s&&!I(this.options.mimeTypes,(e=>t.endsWith(e))))&&(e.mimeType=Extension.getConvertOptions("bmp",this.options)+t,!0)}}const{findSet:_}=squared.lib.util;class Jpeg$1 extends Extension{constructor(){super(...arguments),this.options={mimeTypes:new Set(["image/png","image/bmp","image/gif","image/tiff"]),largerThan:0,smallerThan:1/0,whenSmaller:!1,replaceWith:!0}}processFile(e,s){const t=e.mimeType;return!(!t||/jpeg[(%@:]/.test(t)||!s&&!_(this.options.mimeTypes,(e=>t.endsWith(e))))&&(e.mimeType=Extension.getConvertOptions("jpeg",this.options)+t,!0)}}const{findSet:R}=squared.lib.util;class Png$1 extends Extension{constructor(){super(...arguments),this.options={mimeTypes:new Set(["image/jpeg","image/bmp","image/gif","image/tiff"]),largerThan:0,smallerThan:1/0,whenSmaller:!1,replaceWith:!0,opacity:1}}processFile(e,s){const t=e.mimeType;return!(!t||/png[(%@:]/.test(t)||!s&&!R(this.options.mimeTypes,(e=>t.endsWith(e))))&&(e.mimeType=Extension.getConvertOptions("png",this.options)+t,!0)}}const{findSet:H}=squared.lib.util;class Gif extends Extension{constructor(){super(...arguments),this.options={mimeTypes:new Set(["image/png","image/jpeg","image/bmp","image/tiff"]),largerThan:0,smallerThan:1/0,whenSmaller:!1,replaceWith:!0,opacity:1}}processFile(e,s){const t=e.mimeType;return!(!t||/gif[(%@:]/.test(t)||!s&&!H(this.options.mimeTypes,(e=>t.endsWith(e))))&&(e.mimeType=Extension.getConvertOptions("gif",this.options)+t,!0)}}const{findSet:k}=squared.lib.util;class Tiff extends Extension{constructor(){super(...arguments),this.options={mimeTypes:new Set(["image/png","image/jpeg","image/gif","image/bmp"]),largerThan:0,smallerThan:1/0,whenSmaller:!1,replaceWith:!0}}processFile(e,s){const t=e.mimeType;return!(!t||/tiff[(%@:]/.test(t)||!s&&!k(this.options.mimeTypes,(e=>t.endsWith(e))))&&(e.mimeType=Extension.getConvertOptions("tiff",this.options)+t,!0)}}const N={builtInExtensions:[],preloadImages:!1,preloadFonts:!1,preloadCustomElements:!1,excludePlainText:!0,createElementMap:!0,createQuerySelectorMap:!0,pierceShadowRoot:!1,showErrorMessages:!1,outputFileExclusions:[],outputEmptyCopyDirectory:!1,outputArchiveName:"chrome-data",outputArchiveFormat:"zip"},{DIRECTORY_NOT_PROVIDED:D,FRAMEWORK_NOT_INSTALLED:U,reject:$}=squared.lib.error,{isString:z,isPlainObject:B}=squared.lib.util;let G=null,J=null;function V(e,s,t,i){return B(s)?s.assets&&e.push(...s.assets):s={},Object.assign(s,{assets:e,directory:t,filename:i})}const Q=e=>e||G.userSettings.outputArchiveName,K=undefined;return{base:{Application:Application,Extension:Extension,File:File},lib:{},extensions:{compress:{Brotli:Brotli,Gzip:Gzip,Jpeg:Jpeg,Png:Png},convert:{Bmp:Bmp,Gif:Gif,Jpeg:Jpeg$1,Png:Png$1,Tiff:Tiff}},system:{copyHtmlPage:(e,s)=>z(e)?J?J.copying(V(J.getHtmlPage(s),s,e)):$(U):$(D),copyScriptAssets:(e,s)=>z(e)?J?J.copying(V(J.getScriptAssets(s)[0],s,e)):$(U):$(D),copyLinkAssets:(e,s)=>z(e)?J?J.copying(V(J.getLinkAssets(s),s,e)):$(U):$(D),copyImageAssets:(e,s)=>z(e)?J?J.copying(V(J.getImageAssets(s),s,e)):$(U):$(D),copyVideoAssets:(e,s)=>z(e)?J?J.copying(V(J.getVideoAssets(s),s,e)):$(U):$(D),copyAudioAssets:(e,s)=>z(e)?J?J.copying(V(J.getAudioAssets(s),s,e)):$(U):$(D),copyFontAssets:(e,s)=>z(e)?J?J.copying(V(J.getFontAssets(s),s,e)):$(U):$(D),saveHtmlPage:(e,s)=>J?J.archiving(V(J.getHtmlPage(s),s,void 0,Q(e)+"-html")):$(U),saveScriptAssets:(e,s)=>J?J.archiving(V(J.getScriptAssets(s)[0],s,void 0,Q(e)+"-script")):$(U),saveLinkAssets:(e,s)=>J?J.archiving(V(J.getLinkAssets(s),s,void 0,Q(e)+"-link")):$(U),saveImageAssets:(e,s)=>J?J.archiving(V(J.getImageAssets(s),s,void 0,Q(e)+"-image")):$(U),saveVideoAssets:(e,s)=>J?J.archiving(V(J.getVideoAssets(s),s,void 0,Q(e)+"-video")):$(U),saveAudioAssets:(e,s)=>J?J.archiving(V(J.getAudioAssets(s),s,void 0,Q(e)+"-audio")):$(U),saveFontAssets:(e,s)=>J?J.archiving(V(J.getFontAssets(s),s,void 0,Q(e)+"-font")):$(U)},create:()=>(G=new Application(4,squared.base.Node,squared.base.Controller,squared.base.ExtensionManager,squared.base.Resource),J=new File,G.resourceHandler.fileHandler=J,G.builtInExtensions=new Map([["chrome.compress.brotli",new Brotli("chrome.compress.brotli",4)],["chrome.compress.gzip",new Gzip("chrome.compress.gzip",4)],["chrome.compress.jpeg",new Jpeg("chrome.compress.jpeg",4)],["chrome.compress.png",new Png("chrome.compress.png",4)],["chrome.convert.bmp",new Bmp("chrome.convert.bmp",4)],["chrome.convert.gif",new Gif("chrome.convert.gif",4)],["chrome.convert.jpeg",new Jpeg$1("chrome.convert.jpeg",4)],["chrome.convert.png",new Png$1("chrome.convert.png",4)],["chrome.convert.tiff",new Tiff("chrome.convert.tiff",4)]]),{application:G,framework:4,userSettings:Object.assign({},N)}),cached(){return G?{application:G,framework:4,userSettings:G.userSettings}:this.create()}}}));
